<!doctype html>
<html lang="ja" data-version="DoctorCar Note v0.7.6a">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>DoctorCar Note v0.7.6a</title>
<style>
:root{--bg:#fff;--fg:#111;--muted:#6b7280;--border:#e5e7eb;--acB:#2563eb;--ok:#16a34a}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 -apple-system,system-ui,"Hiragino Sans","Noto Sans JP","YuGothic","Meiryo",sans-serif}
header{position:sticky;top:0;z-index:60;background:#fff;border-bottom:1px solid var(--border)}
.bar{display:flex;gap:8px;align-items:center;padding:8px 12px;flex-wrap:wrap}
.bar h1{font-size:16px;margin:0 8px 0 0}
main{padding:12px;max-width:1400px;margin:auto}
.layout{display:grid;grid-template-columns:minmax(340px,720px) 1fr;gap:12px;align-items:start}
@media (max-width:1024px){.layout{grid-template-columns:1fr}}
section{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin:12px 0}
h2{margin:0 0 8px;font-size:18px}
h3{margin:8px 0 6px;font-size:16px}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;gap:8px;flex-wrap:wrap}
.col{flex:1 1 220px;min-width:220px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font:inherit}
textarea{min-height:80px}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{padding:10px 14px;border:1px solid var(--border);border-radius:999px;cursor:pointer;user-select:none}
.chip.on{background:var(--acB);border-color:var(--acB);color:#fff}
.chip.plus{border-color:#22c55e;background:#ecfdf5;color:#065f46}
.chip.minus{border-color:#ef4444;background:#fef2f2;color:#991b1b}
.btn{padding:12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer}
.btn:active{transform:scale(.99)}
.btn.b{background:var(--acB);border-color:var(--acB);color:#fff}
.btn.g{background:var(--ok);border-color:var(--ok);color:#fff}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
@media (max-width:780px){.grid2,.grid3{grid-template-columns:1fr}}
/* timeline right pane */
.rightPane{position:sticky;top:64px;max-height:calc(100vh - 80px);overflow:auto}
.tl{display:flex;flex-direction:column;gap:8px}
.card{border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff}
.when{font-size:12px;color:var(--muted);margin-bottom:4px}
.actions{display:flex;gap:8px;margin-top:6px}
.actions .btn{flex:1;padding:8px}
.tag{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;margin-right:6px}
/* pads */
.quick{border:1px solid var(--border);border-radius:12px;padding:10px;margin:12px 0}
.qrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.step{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.step input{width:72px;border:none;text-align:center}
.step button{border:none;background:#f3f4f6;padding:8px 12px;cursor:pointer}
.qpick{display:flex;gap:6px;align-items:center}
.qpick select{width:auto;min-width:88px}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:0 6px}
.timerbar{display:flex;gap:8px;align-items:center}
.badge{padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#111;background:#f8fafc}
.cpa{border:1px dashed var(--border);border-radius:12px;padding:8px;margin-top:8px}
/* collapsible */
.fold{border:1px solid var(--border);border-radius:12px;margin:12px 0;background:#fff}
.fold>summary{list-style:none;cursor:pointer;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;font-weight:600}
.fold>summary::-webkit-details-marker{display:none}
.fold .fold-body{padding:10px 12px;border-top:1px solid var(--border)}
.fold .hint{font-size:12px;color:var(--muted)}
/* subpanels */
.subpanel{border:1px dashed var(--border);border-radius:10px;padding:8px;margin-top:8px}
</style>
<!-- iOS Safari ç”¨ -->
<link rel="apple-touch-icon" href="/medicationindex/apple-touch-icon.png">

<!-- Android/Chrome ç”¨ -->
<link rel="manifest" href="/medicationindex/manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
</head>
<body>
<header>
  <div class="bar">
    <h1>DoctorCar Note v0.7.6a</h1>
    <div class="timerbar">
      <div class="chip" id="timerToggle">â± 5åˆ†ã‚¿ã‚¤ãƒãƒ¼ï¼šOFF</div>
      <span class="badge" id="timerRemain" style="display:none">Tâˆ’05:00</span>
    </div>
    <button class="btn" id="btnExport">å‡ºåŠ›</button>
    <button class="btn" id="btnExportChrono">æ™‚åˆ»é †ã§å‡ºåŠ›</button>
    <button class="btn" id="btnCopy">ã‚³ãƒ”ãƒ¼</button>
    <button class="btn" id="btnReset">åˆæœŸåŒ–</button>
  </div>
</header>

<main class="layout">
  <!-- ===== Left Pane: æ“ä½œã‚¨ãƒªã‚¢ ===== -->
  <div class="leftPane">

    <!-- æ‚£è€…æƒ…å ± -->
    <details class="fold" open>
      <summary>æ‚£è€…æƒ…å ±</summary>
      <div class="fold-body">
        <div class="grid2">
          <div>
            <label>å¹´é½¢ã®ç¢ºåº¦</label>
            <div class="chips">
              <div class="chip on" id="ageCertain">ç¢ºå®š</div>
              <div class="chip" id="ageEstimated">æ¨å®š</div>
            </div>
          </div>
          <div>
            <label>æ€§åˆ¥</label>
            <div class="chips" id="sexChips">
              <div class="chip on" data-sex="ç”·æ€§">ç”·æ€§</div>
              <div class="chip" data-sex="å¥³æ€§">å¥³æ€§</div>
              <div class="chip" data-sex="ä¸æ˜">ä¸æ˜</div>
            </div>
          </div>
        </div>
        <div class="row" id="ageCertainRow" style="margin-top:6px">
          <div class="col"><label>å¹´é½¢ï¼ˆç¢ºå®šãƒ»1åˆ»ã¿ï¼‰</label><select id="ageSelect"></select></div>
        </div>
        <div class="row" id="ageEstimatedRow" style="display:none;margin-top:6px">
          <div class="col"><label>å¹´ä»£ï¼ˆæ¨å®šï¼‰</label>
            <select id="ageDecade">
              <option value=""></option>
              <option>10ä»£</option><option>20ä»£</option><option>30ä»£</option><option>40ä»£</option>
              <option>50ä»£</option><option>60ä»£</option><option>70ä»£</option><option>80ä»£</option><option>90ä»£ä»¥ä¸Š</option><option>ä¸æ˜</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <div class="col"><label>ç¾ç—…æ­´</label><textarea id="hpi"></textarea></div>
        </div>
        <div class="grid2" style="margin-top:6px">
          <div><label>æ—¢å¾€æ­´</label><textarea id="pmh" placeholder="ä¾‹ï¼šé«˜è¡€åœ§ã€ç³–å°¿ç—… ç­‰"></textarea></div>
          <div><label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æ­´</label><textarea id="allergy" placeholder="ä¾‹ï¼šãƒšãƒ‹ã‚·ãƒªãƒ³ã€é£Ÿç‰©ç­‰ã€‚ãªã—å¯"></textarea></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn g" id="btnRecordPatient">ï¼‹ æ‚£è€…æƒ…å ±ã‚’è¨˜éŒ²</button>
        </div>
      </div>
    </details>

    <!-- ä¸»è¨´ãƒ»EMS -->
    <details class="fold" id="accChief">
      <summary>ä¸»è¨´ãƒ»EMS <span class="small" id="chiefSummaryHint">ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦é–‹ãï¼‰</span></summary>
      <div class="fold-body">
        <section style="border:none;padding:0;margin:0">
          <div class="row">
            <div class="col">
              <label>ä¸»è¨´ï¼ˆé¹¿å…å³¶å¸‚DCè¦ä»¶ï¼šãƒˆã‚°ãƒ«ï¼‰</label>
              <div class="chips" id="chiefFlags"></div>

              <!-- CPAãƒ¢ãƒ¼ãƒ‰ -->
              <div id="cpaPanel" class="cpa" style="display:none">
                <h3>CPAãƒ¢ãƒ¼ãƒ‰</h3>
                <div class="chips" id="cpaRhythm">
                  <div class="chip" data-val="VF/ç„¡è„ˆæ€§VT">åˆæœŸæ³¢å½¢ï¼šVF/ç„¡è„ˆæ€§VT</div>
                  <div class="chip" data-val="PEA">åˆæœŸæ³¢å½¢ï¼šPEA</div>
                  <div class="chip" data-val="å¿ƒé™æ­¢">åˆæœŸæ³¢å½¢ï¼šå¿ƒé™æ­¢</div>
                  <div class="chip" data-val="ä¸æ˜">åˆæœŸæ³¢å½¢ï¼šä¸æ˜</div>
                </div>
                <div class="chips" id="cpaWitness">
                  <div class="chip" data-val="ã‚ã‚Š">ç›®æ’ƒã‚ã‚Š</div>
                  <div class="chip" data-val="ãªã—">ç›®æ’ƒãªã—</div>
                </div>
                <div class="chips" id="cpaByst">
                  <div class="chip" data-val="ã‚ã‚Š">ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š</div>
                  <div class="chip" data-val="ãªã—">ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—</div>
                </div>
                <div class="chips">
                  <div class="chip" id="cpaShock">ã‚·ãƒ§ãƒƒã‚¯è¨˜éŒ²</div>
                  <div class="chip" id="cpaEpi">ã‚¨ãƒ”è¨˜éŒ²</div>
                  <div class="chip" id="cpaROSC">ROSCè¨˜éŒ²</div>
                  <div class="chip" id="cpaSummary">CPAæ¦‚è¦ã‚’è¨˜éŒ²</div>
                </div>
                <div class="small" id="cpaCounters">åˆæœŸæ³¢å½¢ï¼šâ€” / ç›®æ’ƒï¼šâ€” / BCPRï¼šâ€” / ã‚·ãƒ§ãƒƒã‚¯ 0å› / ã‚¨ãƒ” 0å› / ROSCï¼šâ€”</div>
              </div>
            </div>

            <div class="col">
              <label>EMSã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæŠ¼ã™ã ã‘ã§è¨˜éŒ²ï¼‰</label>
              <div class="chips" id="emsEvents">
                <div class="chip" data-scope="EMS" data-ev="ç¾ç€">ç¾ç€</div>
                <div class="chip" data-scope="EMS" data-ev="æ¥è§¦">æ¥è§¦</div>
                <div class="chip" data-scope="EMS" data-ev="åå®¹">åå®¹</div>
                <div class="chip" data-scope="EMS" data-ev="ç¾ç™º">ç¾ç™º</div>
                <div class="chip" data-scope="EMS" data-ev="ç—…ç€">ç—…ç€</div>
              </div>
              <div class="chips" style="margin-top:8px">
                <div class="chip on" id="vrDC" data-rail="DC">ãƒã‚¤ã‚¿ãƒ«å¯¾è±¡ï¼šDoctorCar</div>
                <div class="chip" id="vrEMS" data-rail="EMS">ãƒã‚¤ã‚¿ãƒ«å¯¾è±¡ï¼šEMS</div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </details>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ»ãƒã‚¤ã‚¿ãƒ« -->
    <details class="fold" id="accVitals">
      <summary>ã‚¯ã‚¤ãƒƒã‚¯ãƒ»ãƒã‚¤ã‚¿ãƒ« <span class="small" id="vitalSummaryHint">ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦é–‹ãï¼‰</span></summary>
      <div class="fold-body">
        <section class="quick" id="quickVitals">
          <div class="qrow">
            <strong>ã‚¯ã‚¤ãƒƒã‚¯ãƒ»ãƒã‚¤ã‚¿ãƒ«</strong>
            <span class="small">ã‚»ãƒ¬ã‚¯ãƒˆã§ä¸€ç™ºã€Â±ã§å¾®èª¿æ•´ã€‚æœªå…¥åŠ›ã¯ç©ºæ¬„ã€‚1ã‚¿ãƒƒãƒ—ã§ã‚«ãƒ¼ãƒ‰åŒ–ã€‚</span>
          </div>
          <div class="qrow" style="margin-top:6px">
            <div class="qpick"><span class="small">HR</span><select id="sHR"></select></div>
            <div class="qpick"><span class="small">RR</span><select id="sRR"></select></div>
            <div class="qpick"><span class="small">SBP</span><select id="sSBP"></select></div>
            <div class="qpick"><span class="small">DBP</span><select id="sDBP"></select></div>
            <div class="qpick"><span class="small">SpOâ‚‚</span><select id="sSpO2"></select></div>
            <div class="qpick"><span class="small">BT</span><select id="sBT"></select></div>
          </div>
          <div class="qrow" style="margin-top:6px">
            <div><span class="small">HR</span><span class="step"><button data-step="-1" data-for="qHR">âˆ’</button><input id="qHR" type="number" inputmode="numeric" placeholder="â€”"><button data-step="1" data-for="qHR">ï¼‹</button></span></div>
            <div><span class="small">RR</span><span class="step"><button data-step="-1" data-for="qRR">âˆ’</button><input id="qRR" type="number" inputmode="numeric" placeholder="â€”"><button data-step="1" data-for="qRR">ï¼‹</button></span></div>
            <div><span class="small">SBP/DBP</span>
              <span class="step"><button data-step="-1" data-for="qSBP">âˆ’</button><input id="qSBP" type="number" inputmode="numeric" placeholder="â€”"><button data-step="1" data-for="qSBP">ï¼‹</button></span>
              <span class="step"><button data-step="-1" data-for="qDBP">âˆ’</button><input id="qDBP" type="number" inputmode="numeric" placeholder="â€”"><button data-step="1" data-for="qDBP">ï¼‹</button></span>
            </div>
            <div><span class="small">SpOâ‚‚</span><span class="step"><button data-step="-1" data-for="qSpO2">âˆ’</button><input id="qSpO2" type="number" inputmode="numeric" placeholder="â€”"><button data-step="1" data-for="qSpO2">ï¼‹</button></span></div>
            <div><span class="small">BT</span><span class="step"><button data-step="-0.1" data-for="qBT">âˆ’</button><input id="qBT" type="number" inputmode="decimal" step="0.1" placeholder="â€”"><button data-step="0.1" data-for="qBT">ï¼‹</button></span></div>
          </div>
          <div class="qrow" style="margin-top:6px">
            <div><span class="small">GCS-E</span><select id="qE"><option></option><option>4</option><option>3</option><option>2</option><option>1</option></select></div>
            <div><span class="small">GCS-V</span><select id="qV"><option></option><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option><option>1T</option></select></div>
            <div><span class="small">GCS-M</span><select id="qM"><option></option><option>6</option><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select></div>
            <div class="chips">
              <div class="chip" id="qNorm">Nï¼ˆæ­£å¸¸ï¼‰</div>
              <div class="chip" id="qLowBP">ä½è¡€åœ§</div>
              <div class="chip" id="qTachy">é »è„ˆ</div>
              <div class="chip" id="qHypox">SpOâ‚‚&lt;90</div>
            </div>
          </div>
          <div class="qrow">
            <input id="qNote" placeholder="å‚™è€ƒï¼ˆä½“ä½ã€é…¸ç´ æŠ•ä¸ãªã©ä»»æ„ï¼‰">
            <button class="btn b" id="btnRecordVitals">ï¼‹ ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²</button>
          </div>
          <div class="hint">â€» æŠ˜ã‚ŠãŸãŸã¿ä¸­ã‚‚ã‚¿ã‚¤ãƒãƒ¼ã¯å‹•ä½œã—ã¾ã™ã€‚</div>
        </section>
      </div>
    </details>

    <!-- â˜… DoctorCar ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã“ã“ã«ç§»å‹•ï¼‰ -->
    <section>
      <h2>DoctorCar ã‚¤ãƒ™ãƒ³ãƒˆ</h2>
      <div class="chips" id="dcEvents">
        <div class="chip" data-scope="DC" data-ev="è¦šçŸ¥">è¦šçŸ¥</div>
        <div class="chip" data-scope="DC" data-ev="æŒ‡ä»¤">æŒ‡ä»¤</div>
        <div class="chip" data-scope="DC" data-ev="å‡ºå‹•">å‡ºå‹•</div>
        <div class="chip" data-scope="DC" data-ev="ç¾ç€">ç¾ç€</div>
        <div class="chip" data-scope="DC" data-ev="æ¥è§¦">æ¥è§¦</div>
        <div class="chip" data-scope="DC" data-ev="åå®¹">åå®¹</div>
        <div class="chip" data-scope="DC" data-ev="ç¾ç™º">ç¾ç™º</div>
        <div class="chip" data-scope="DC" data-ev="ç—…ç€">ç—…ç€</div>
      </div>
    </section>

    <!-- æ‰€è¦‹ -->
    <section>
      <h2>æ‰€è¦‹ï¼ˆï¼‹/âˆ’ãƒˆã‚°ãƒ« â†’ 1ã‚¿ãƒƒãƒ—è¨˜éŒ²ï¼‰</h2>
      <div class="chips" id="examTabs"></div>
      <div id="examPanel" class="chips" style="margin-top:6px"></div>
      <div class="row" style="margin-top:6px">
        <input id="examFree" placeholder="å‚™è€ƒï¼ˆä¾‹ï¼šå³å‰èƒ¸éƒ¨åœ§ç—› 3cmå‰µãªã©ï¼‰">
        <button class="btn g" id="btnRecordExam">ï¼‹ æ‰€è¦‹ã‚’è¨˜éŒ²</button>
      </div>
      <div class="small">â€»å„ãƒãƒƒãƒ—ã¯ï¼ˆç©ºï¼‰â†’ï¼ˆï¼‹ï¼‰â†’ï¼ˆâˆ’ï¼‰â†’ï¼ˆç©ºï¼‰ã€‚ã‚¿ãƒ–ã‚’ã¾ãŸã„ã§ã‚‚çŠ¶æ…‹ä¿æŒã€‚</div>
    </section>

    <!-- å‡¦ç½® -->
    <section>
      <h2>å‡¦ç½®ï¼ˆé¸ã¶â†’å³ã‚«ãƒ¼ãƒ‰åŒ–ï¼‰</h2>
      <div class="grid3">
        <div>
          <h3>æ°—é“ãƒ»å‘¼å¸</h3>
          <div class="chips" id="padAirway"></div>
          <div id="subAirway" class="chips subpanel" style="display:none"></div>
          <div id="subAirway2" class="chips subpanel" style="display:none"></div>
        </div>
        <div>
          <h3>å¾ªç’°ãƒ»ç©¿åˆºãƒ»å¤–å‚·</h3>
          <div class="chips" id="padCirc"></div>
          <div id="subCirc" class="chips subpanel" style="display:none"></div>
        </div>
        <div>
          <h3>è¨˜éŒ²è£œåŠ©</h3>
          <div class="chips" id="padQuick"></div>
          <div id="subQuick" class="chips subpanel" style="display:none"></div>
          <div id="subQuickCtl" class="row" style="display:none;margin-top:6px">
            <button class="btn b" id="btnFastRecord">ï¼‹ FASTæ‰€è¦‹ã‚’è¨˜éŒ²</button>
          </div>
        </div>
      </div>
    </section>

    <!-- è–¬å‰¤ -->
    <section>
      <h2>è–¬å‰¤ï¼ˆã‚¿ãƒƒãƒ—â†’ã‚«ãƒ¼ãƒ‰åŒ–ã€âœï¸ã§é‡ã‚’ç·¨é›†ï¼‰</h2>
      <div class="chips" id="padDrugs"></div>
    </section>

    <!-- å‡ºåŠ› -->
    <section>
      <h2>å‡ºåŠ›ï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</h2>
      <textarea id="out" class="kbd" style="width:100%;min-height:180px" placeholder="ï¼»å‡ºåŠ›ï¼½ã§ç”Ÿæˆã•ã‚Œã¾ã™"></textarea>
    </section>
  </div>

  <!-- ===== Right Pane: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼ˆç¸¦é•·ï¼‰ ===== -->
  <div class="rightPane">
    <section>
      <h2>çµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
      <div id="tl" class="tl"></div>
    </section>
  </div>
</main>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<dialog id="dlgEdit">
  <div style="padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
    <strong>ã‚«ãƒ¼ãƒ‰ç·¨é›†</strong><button class="btn" onclick="dlgEdit.close()">é–‰ã˜ã‚‹</button>
  </div>
  <div class="ma" id="editBody"></div>
  <div class="mf" style="padding:8px 12px"><button class="btn b" id="btnSaveEdit">ä¿å­˜</button></div>
</dialog>

<!-- ã‚¿ã‚¤ãƒãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ -->
<dialog id="dlgTimer">
  <div style="padding:10px 12px;border-bottom:1px solid var(--border)"><strong>â± ãƒã‚¤ã‚¿ãƒ«è¨˜éŒ²ã‚¿ã‚¤ãƒãƒ¼ï¼ˆ5åˆ†ï¼‰</strong></div>
  <div class="ma"><div class="small">ã‚¯ã‚¤ãƒƒã‚¯æ¬„ã®å€¤ã§è¨˜éŒ²ã—ã¾ã™ã€‚å¿…è¦ãªã‚‰å…ˆã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</div></div>
  <div class="mf" style="padding:8px 12px">
    <button class="btn" id="timerSkip">å¾Œã§</button>
    <button class="btn" id="timerStop">åœæ­¢</button>
    <button class="btn b" id="timerRecord">ä»Šã™ãè¨˜éŒ²</button>
  </div>
</dialog>

<script>
/* ====== è¾æ›¸ ====== */
const CHIEF_FLAGS=["æ„è­˜ãªã—","å‘¼å¸ãªã—","CPA","é‡ç—‡å¤–å‚·","ç—™æ”£æŒç¶š","å‘¼å¸å›°é›£","ã‚·ãƒ§ãƒƒã‚¯å¾´å€™","èƒ¸ç—›ACSç–‘ã„","è„³å’ä¸­ç–‘ã„","é‡ç—‡ç†±å‚·","ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼","ç”£ç§‘æ•‘æ€¥","å¤šæ•°å‚·ç—…è€…"];

/* æ‰€è¦‹ï¼ˆã”æŒ‡å®šåæ˜ æ¸ˆï¼‰ */
const EXAM_DICT={
  "æ„è­˜/ç¥çµŒ":[
    "æ„è­˜æ¸…æ˜","ä¼šè©±å¯èƒ½","æ§‹éŸ³éšœå®³",
    "é ­ç—›","è¦‹å½“è­˜ä½ä¸‹","ç‰‡éº»ç—º","å…±åŒåè¦–","å¤±èª","ç—™æ”£","é …éƒ¨ç¡¬ç›´","ã‚±ãƒ«ãƒ‹ãƒƒãƒ’å¾´å€™","ç³å­”ä¸åŒ"
  ],
  "æ°—é“/å‘¼å¸":[
    "æ°—é“é–‹é€š","å‘¼å¸éŸ³æ¸…","å‘¼å¸ä¿ƒè¿«","å–˜é³´","ãƒ©éŸ³","èƒ¸éƒ­å¤‰å½¢","æŒç¶šã™ã‚‹èƒ¸ç—›","èƒ¸éƒ¨åœ§ç—›","å‘¼å¸è£œåŠ©ç­‹ä½¿ç”¨","å‘¼å¸éŸ³å·¦å³å·®"
  ],
  "å¾ªç’°":[
    "å¿ƒéŸ³ç´”","å¿ƒé›‘éŸ³","æ©ˆéª¨å‹•è„ˆè§¦çŸ¥è‰¯å¥½","CRTå»¶é•·","è¶³èƒŒå‹•è„ˆè§¦çŸ¥å¯èƒ½","é šå‹•è„ˆè§¦çŸ¥å¯èƒ½",
    "è’¼ç™½","é »è„ˆ","å¾è„ˆ","æµ®è…«"
  ],
  "è…¹éƒ¨":[
    "å¹³å¦è»Ÿ","è‡ªç™ºç—›","åœ§ç—›","åè·³ç—›","ç­‹æ€§é˜²å¾¡","è…¸è •å‹•éŸ³æ¸›å¼±"
  ],
  "å››è‚¢/çš®è†š":[
    "è’¼ç™½","å†·æ„Ÿ","è…«è„¹","å¤‰å½¢","é–‹æ”¾å‰µ","æ“¦éå‚·","çš®ä¸‹å‡ºè¡€"
  ],
  "å¤–å‚·":[
    "é ­éƒ¨å¤–å‚·","èƒ¸éƒ¨å¤–å‚·","è…¹éƒ¨å¤–å‚·","éª¨ç›¤ç—›","å››è‚¢å¤–å‚·","ç†±å‚·",
    "æ°—ç®¡åä½","å£è…”å†…å‡ºè¡€","ä½“è¡¨ã®æ´»å‹•æ€§å‡ºè¡€","èƒ¸éƒ­å‹•æº","èƒ¸éƒ¨åœ§ç—›",
    "çš®ä¸‹æ°—è…«","å¥‡ç•°æ€§å‘¼å¸","èƒ¸éƒ­æŒ™ä¸Šå·¦å³å·®","è…¹éƒ¨æ‰“æ’²ç—•","è…¹éƒ¨è†¨æº€",
    "éª¨ç›¤å‹•æº","å¤§è…¿éƒ¨å¤‰å½¢","ä¸‹è…¿å¤‰å½¢","å››è‚¢éº»ç—º","è„±åŠ›","éº»ç—º","æŒ«å‰µ"
  ]
};

/* å‡¦ç½®ãƒ‘ãƒƒãƒ‰ */
const AIRWAY_PAD={
  base:["é…¸ç´ æŠ•ä¸","å¸å¼•","ç•°ç‰©é™¤å»","BVMæ›æ°—","å£°é–€ä¸Šå™¨å…·","æ°—ç®¡æŒ¿ç®¡","äººå·¥å‘¼å¸å™¨"],
  O2:{device:["é¼»ã‚«ãƒŒãƒ©","ãƒã‚¹ã‚¯","ãƒªã‚¶ãƒ¼ãƒãƒ¼ãƒã‚¹ã‚¯","BVM"],
      flow:{"é¼»ã‚«ãƒŒãƒ©":["1L","2L","3L","4L","5L","6L"],"ãƒã‚¹ã‚¯":["5L","10L","15L"],"ãƒªã‚¶ãƒ¼ãƒãƒ¼ãƒã‚¹ã‚¯":["10L","15L"],"BVM":["15L"]}},
  SUCT:{site:["å£è…”","é¼»è…”","æ°—ç®¡"],content:["åˆ†æ³Œ","è¡€æ¶²","å˜”å"],vol:["å°‘","ä¸­","å¤š"]},
  FOB:{method:["èƒŒéƒ¨å©æ‰“","èƒ¸éƒ¨çªãä¸Šã’","ãƒã‚¤ãƒ ãƒªãƒƒã‚¯","ãƒã‚®ãƒ¼ãƒ«é‰—å­","å¸å¼•é™¤å»"],result:["æˆåŠŸ","ä¸æˆåŠŸ"]},
  ADJ:{device:["i-gel #3","i-gel #4","i-gel #5","LT"]},
  INT:{tube:["ETT 7.0","ETT 7.5","ETT 8.0"],confirm:["Capno","è´è¨º","èƒ¸éƒ­æŒ™ä¸Š"],depth:["æ·±ã• 21cm","22cm","23cm"]}
};
const CIRC_PAD={
  base:["IVãƒ«ãƒ¼ãƒˆ#1","IVãƒ«ãƒ¼ãƒˆ#2","è¼¸æ¶²é–‹å§‹","æ­¢è¡€","éª¨ç›¤å›ºå®š","èƒ¸è…”ãƒ‰ãƒ¬ãƒ¼ãƒ³","å¿ƒåš¢ç©¿åˆº","ç¸«åˆ"],
  IV:{site:["å³å‰è…•","å·¦å‰è…•","å³è‚˜çª©","å·¦è‚˜çª©","å³æ‰‹èƒŒ","å·¦æ‰‹èƒŒ"],gauge:["14G","16G","18G","20G"]},
  FLUID:{kind:["ç”Ÿé£Ÿ","ã‚½ãƒ«ã‚¢ã‚»ãƒˆ"],vol:["500 mL"]},
  HEMO:{method:["åœ§è¿«","æ­¢è¡€å¸¯","æ­¢è¡€æ"],site:["é ­éƒ¨","èƒ¸éƒ¨","è…¹éƒ¨","éª¨ç›¤","å³å¤§è…¿","å·¦å¤§è…¿","å³å‰è…•","å·¦å‰è…•"]},
  PELV:{dev:["ã‚·ãƒ¼ãƒ","ã‚·ãƒ¼ãƒ„å›ºå®š"]},
  DRAIN:{side:["å³","å·¦"],size:["20Fr","24Fr","28Fr","32Fr"]},
  PERI:{detail:[]},
  SUTURE:{site:["å‰é¡éƒ¨","é ­çš®","ä¸‹é¡","å‰èƒ¸éƒ¨","ä¸Šè‚¢","ä¸‹è‚¢"]}
};

/* è¨˜éŒ²è£œåŠ© */
const QUICK_PAD=[
  {title:"12èª˜å°å¿ƒé›»å›³",cat:"ecg",type:"ecg"},
  {title:"ã‚¨ã‚³ãƒ¼FAST",cat:"fast",type:"fast"},
  {title:"è¡€ç³–æ¸¬å®š",cat:"glucose",type:"glucose"},
  {title:"é®ç—›è©•ä¾¡",cat:"aux",type:"pain"},
  {title:"é™¤ç´°å‹•",cat:"defib",type:"defib"}
];

/* è–¬å‰¤ï¼šé‡ã‚»ãƒ¬ã‚¯ãƒˆä»•æ§˜ */
const DRUG_CFG={
  "ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³":      {unit:"mg", def:1.0, min:0, max:5, step:0.1},
  "ãƒ‹ã‚«ãƒ«ã‚¸ãƒ”ãƒ³":      {unit:"mg", def:1.0, min:0, max:10, step:0.1},
  "ãƒŸãƒ€ã‚¾ãƒ©ãƒ ":        {unit:"mg", def:1.0, min:0, max:10, step:0.1},
  "TXAï¼ˆãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³ï¼‰": {unit:"mg", def:1000, options:[500,1000,1500,2000]},
  "ãƒãƒ«ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³":   {unit:"mL", def:1.0, min:0, max:20, step:0.1, note:"ï¼ˆ1A/20mLï¼‰"},
  "ãƒ–ãƒ—ãƒ¬ãƒãƒ«ãƒ•ã‚£ãƒ³":  {unit:"A",  def:1.0, min:0, max:2, step:0.25},
  "ãƒ­ã‚¯ãƒ­ãƒ‹ã‚¦ãƒ ":      {unit:"mg", def:50,  min:0, max:150, step:10},
  "ãƒ¬ãƒ™ãƒãƒ©ã‚»ã‚¿ãƒ ":    {unit:"mg", def:500, options:[500,1000,1500,2000]},
  "ã‚¢ã‚»ãƒªã‚ª":          {unit:"mg", def:1000, options:[500,1000]},
  "ã‚¢ãƒˆãƒ­ãƒ”ãƒ³":        {unit:"mg", def:0.5, min:0, max:3, step:0.1}
};
const DRUGS=Object.keys(DRUG_CFG);

/* ====== çŠ¶æ…‹ ====== */
let seqCounter=0;
const state={
  tl:[],
  vitalsLast:{HR:null,RR:null,SBP:null,DBP:null,SpO2:null,BT:null,GCS:{E:null,V:null,M:null}},
  vitalRail:"DC",
  examState:{},
  cpa:{active:false,rhythm:null,witness:null,byst:null,shock:0,epi:0,rosc:null},
  timer:{active:false,next:null}
};

const $=sel=>document.querySelector(sel), $$=sel=>document.querySelectorAll(sel);
const z=n=>String(n).padStart(2,'0');
const now=()=>{const d=new Date();return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`};
const hhmm=iso=>iso?iso.split(' ')[1]:'';
const num=s=>s===''||s==null?null:Number(s);
const safe=v=>v==null?'':v;
function escapeHTML(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* ====== TL ====== */
function addCard(scope,type,body={}){
  const c={id:String(Date.now()+Math.random()),seq:++seqCounter,t:now(),scope,type,body};
  state.tl.push(c);
  // CPAã‚«ã‚¦ãƒ³ã‚¿
  if(state.cpa.active){
    if(type==='drug' && (body.name||'').includes('ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³')) state.cpa.epi++;
    if(type==='procedure' && ((body.title||'').includes('é™¤ç´°å‹•') || body.cat==='defib')) state.cpa.shock++;
    if(scope==='CPA' && type==='event' && (body.name||'')==='ROSC') state.cpa.rosc=c.t;
    updateCpaCounters();
  }
  renderTL();
}
function renderTL(){
  $('#tl').innerHTML = state.tl.map(c=>cardHTML(c)).join('') || `<div class="small">ï¼ˆè¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</div>`;
}
function valTag(label,val,prev=null,isBP=false){
  if(val==null) return `<span class="tag">${label} â€”</span>`;
  if(isBP) return `<span class="tag">${label} ${val}</span>`;
  if(prev==null||isNaN(prev)) return `<span class="tag">${label} ${val}</span>`;
  const d=Number(val)-Number(prev); const s=d>0?`â†‘+${d}`:d<0?`â†“${d}`:'';
  return `<span class="tag">${label} ${val} ${s?`(${s})`:''}</span>`;
}
function cardHTML(c){
  let ttl='',body='';
  if(c.type==='event'){
    ttl=`${c.scope}ï¼š${c.body.name}`;
  } else if(c.type==='patient'){
    ttl='æ‚£è€…æƒ…å ±';
    body=`<div>å¹´é½¢ï¼š${escapeHTML(c.body.age)}ã€€æ€§åˆ¥ï¼š${escapeHTML(c.body.sex||'')}</div>
          ${c.body.hpi?`<div>ç¾ç—…æ­´ï¼š${escapeHTML(c.body.hpi)}</div>`:''}
          ${c.body.pmh?`<div>æ—¢å¾€æ­´ï¼š${escapeHTML(c.body.pmh)}</div>`:''}
          ${c.body.allergy?`<div>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š${escapeHTML(c.body.allergy)}</div>`:''}`;
  } else if(c.type==='vitals'){
    const v=c.body; ttl=`ãƒã‚¤ã‚¿ãƒ«ï¼ˆ${c.scope}ï¼‰`;
    body=`<div class="chips">
      ${valTag('HR',v.HR,state.vitalsLast?.HR)}
      ${valTag('RR',v.RR,state.vitalsLast?.RR)}
      ${valTag('BP',(v.SBP!=null&&v.DBP!=null)?`${v.SBP}/${v.DBP}`:null,null,true)}
      ${valTag('SpOâ‚‚',v.SpO2,state.vitalsLast?.SpO2)}
      ${valTag('BT',v.BT,state.vitalsLast?.BT)}
      <span class="tag">GCS E${v.GCS.E??'â€”'} V${v.GCS.V==='1T'?'1ï¼ˆTï¼‰':(v.GCS.V??'â€”')} M${v.GCS.M??'â€”'}</span>
      ${v.note?`<span class="tag">${escapeHTML(v.note)}</span>`:''}
    </div>`;
  } else if(c.type==='exam'){
    const items=[]; (c.body.plus||[]).forEach(n=>items.push(`${escapeHTML(n)}ï¼ˆï¼‹ï¼‰`)); (c.body.minus||[]).forEach(n=>items.push(`${escapeHTML(n)}ï¼ˆâˆ’ï¼‰`));
    ttl='æ‰€è¦‹'; body=`<div>${items.length?items.join('ã€'):'ï¼ˆé¸æŠãªã—ï¼‰'}</div>${c.body.note?`<div class="small">${escapeHTML(c.body.note)}</div>`:''}`;
  } else if(c.type==='procedure'){
    ttl=c.body.title || c.body.cat || 'å‡¦ç½®';
    if(c.body.cat==='vent'){
      const v=c.body.vent||{}; body=`<div>ãƒ¢ãƒ¼ãƒ‰ï¼š${v.main||'â€”'} ${v.sub||''}ã€€f:${v.f??'â€”'}ã€€FiOâ‚‚:${v.fio2??'â€”'}ã€€Pi:${v.pi??'â€”'}ã€€PEEP:${v.peep??'â€”'}</div>`;
    } else if(c.body.cat==='ecg'){
      body=`<div>STå¤‰åŒ–ï¼š${c.body.st||'â€”'}ã€€ä¸æ•´è„ˆï¼š${c.body.arr||'â€”'}</div>`;
    } else if(c.body.cat==='fast'){
      const items=[];(c.body.plus||[]).forEach(n=>items.push(`${n}ï¼ˆï¼‹ï¼‰`));(c.body.minus||[]).forEach(n=>items.push(`${n}ï¼ˆâˆ’ï¼‰`));
      body=`<div>${items.length?items.join('ã€'):'ï¼ˆé¸æŠãªã—ï¼‰'}</div>`;
    } else {
      body=`<div>${escapeHTML(c.body.detail||'')}</div>${c.body.end_time?`<div class="small">çµ‚äº†ï¼š${hhmm(c.body.end_time)}</div>`:''}`;
    }
  } else if(c.type==='drug'){
    const cfg=DRUG_CFG[c.body.name]||{unit:''};
    ttl=`è–¬å‰¤ï¼š${c.body.name}`;
    body=`<div>é‡ï¼š${safe(c.body.dose)} ${cfg.unit}${cfg.note?` <span class="small">${cfg.note}</span>`:''}</div>`;
  } else if(c.type==='measure'){
    ttl=c.body.name||'æ¸¬å®š';
    body=`<div>${c.body.value!=null?`å€¤ï¼š${c.body.value} ${c.body.unit}`:`å€¤ï¼šâ€” ${c.body.unit}`}</div>`;
  } else if(c.type==='cpa'){
    ttl='CPAæ¦‚è¦';
    body=`<div>åˆæœŸæ³¢å½¢ï¼š${c.body.rhythm||'â€”'}ã€€ç›®æ’ƒï¼š${c.body.witness||'â€”'}ã€€BCPRï¼š${c.body.byst||'â€”'}</div>
          <div>ã‚·ãƒ§ãƒƒã‚¯ï¼š${c.body.shock||0}å›ã€€ã‚¨ãƒ”ï¼š${c.body.epi||0}å›ã€€ROSCï¼š${c.body.rosc?`ã‚ã‚Šï¼ˆ${hhmm(c.body.rosc)}ï¼‰`:'ãªã—'}</div>`;
  }
  return `<div class="card" data-id="${c.id}">
    <div class="when">${hhmm(c.t)} / ${ttl}</div>
    ${body}
    <div class="actions">
      <button class="btn" onclick="openEdit('${c.id}')">âœï¸ ç·¨é›†</button>
      <button class="btn" onclick="delCard('${c.id}')">ğŸ—‘ å‰Šé™¤</button>
    </div>
  </div>`;
}
function delCard(id){ if(!confirm('ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return; state.tl=state.tl.filter(c=>c.id!==id); renderTL(); }

/* ====== å‡ºåŠ›ï¼ˆé€šå¸¸ï¼æ™‚åˆ»é †ï¼‰ ====== */
function buildOutput(sorted=false){
  const list = sorted
    ? state.tl.slice().sort((a,b)=>{
        const ta=new Date(a.t).getTime(), tb=new Date(b.t).getTime();
        if(ta!==tb) return ta-tb;
        return (a.seq||0)-(b.seq||0);
      })
    : state.tl;

  const lines = list.map(c=>{
    if(c.type==='event') return `${hhmm(c.t)} ${c.scope}:${c.body.name}`;
    if(c.type==='patient'){return `${hhmm(c.t)} æ‚£è€…æƒ…å ± å¹´é½¢:${c.body.age} æ€§åˆ¥:${c.body.sex||'â€”'}${c.body.hpi?` / ç¾ç—…æ­´:${c.body.hpi}`:''}${c.body.pmh?` / æ—¢å¾€æ­´:${c.body.pmh}`:''}${c.body.allergy?` / ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼:${c.body.allergy}`:''}`;}
    if(c.type==='vitals'){const v=c.body,g=v.GCS||{}; return `${hhmm(c.t)} ãƒã‚¤ã‚¿ãƒ«(${c.scope}) HR${val(v.HR)} RR${val(v.RR)} BP${val(v.SBP)}/${val(v.DBP)} SpOâ‚‚${val(v.SpO2)} BT${val(v.BT)} GCS E${val(g.E)} V${g.V==='1T'?'1ï¼ˆTï¼‰':val(g.V)} M${val(g.M)}${v.note?` / ${v.note}`:''}`;}
    if(c.type==='exam'){const items=[];(c.body.plus||[]).forEach(n=>items.push(`${n}ï¼ˆï¼‹ï¼‰`));(c.body.minus||[]).forEach(n=>items.push(`${n}ï¼ˆâˆ’ï¼‰`)); return `${hhmm(c.t)} æ‰€è¦‹ ${items.join('ã€')||'ï¼ˆé¸æŠãªã—ï¼‰'}${c.body.note?` / ${c.body.note}`:''}`;}
    if(c.type==='procedure'){
      if(c.body.cat==='vent'){const v=c.body.vent||{}; return `${hhmm(c.t)} å‡¦ç½® äººå·¥å‘¼å¸å™¨ / ãƒ¢ãƒ¼ãƒ‰:${v.main||'â€”'} ${v.sub||''} / f:${v.f??'â€”'} / FiOâ‚‚:${v.fio2??'â€”'} / Pi:${v.pi??'â€”'} / PEEP:${v.peep??'â€”'}`;}
      if(c.body.cat==='ecg'){return `${hhmm(c.t)} 12èª˜å°å¿ƒé›»å›³ STå¤‰åŒ–:${c.body.st||'â€”'} ä¸æ•´è„ˆ:${c.body.arr||'â€”'}`;}
      if(c.body.cat==='fast'){const items=[];(c.body.plus||[]).forEach(n=>items.push(`${n}ï¼ˆï¼‹ï¼‰`));(c.body.minus||[]).forEach(n=>items.push(`${n}ï¼ˆâˆ’ï¼‰`)); return `${hhmm(c.t)} FAST ${items.join('ã€')||'ï¼ˆé¸æŠãªã—ï¼‰'}`;}
      return `${hhmm(c.t)} å‡¦ç½® ${c.body.title||c.body.cat} / ${c.body.detail||''}${c.body.end_time?` / çµ‚äº† ${hhmm(c.body.end_time)}`:''}`;
    }
    if(c.type==='drug'){const cfg=DRUG_CFG[c.body.name]||{unit:''}; return `${hhmm(c.t)} è–¬å‰¤ ${c.body.name} / é‡:${c.body.dose} ${cfg.unit}`;}
    if(c.type==='measure'){return `${hhmm(c.t)} ${c.body.name} / å€¤:${c.body.value!=null?c.body.value:'â€”'} ${c.body.unit}`;}
    if(c.type==='cpa'){return `${hhmm(c.t)} CPAæ¦‚è¦ åˆæœŸæ³¢å½¢:${c.body.rhythm||'â€”'} ç›®æ’ƒ:${c.body.witness||'â€”'} BCPR:${c.body.byst||'â€”'} ã‚·ãƒ§ãƒƒã‚¯:${c.body.shock||0}å› ã‚¨ãƒ”:${c.body.epi||0}å› ROSC:${c.body.rosc?`ã‚ã‚Š(${hhmm(c.body.rosc)})`:'ãªã—'}`;}
    return `${hhmm(c.t)} ${c.type}`;
  });
  return lines.join('\n');
}
function val(x){ return (x===null||x===undefined||x==='') ? 'â€”' : x; }

/* ====== ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ====== */
const dlgEdit=$('#dlgEdit');
function timeChooser(){ const base=new Date(); let opts=''; for(let i=-10;i<=0;i++){const t=new Date(base.getTime()+i*60000); opts+=`<option>${z(t.getHours())}:${z(t.getMinutes())}</option>`} return `<div class="row"><div class="col"><select id="eTime">${opts}</select></div><div class="col"><input id="eTimeFree" placeholder="ä»»æ„ HH:MMï¼ˆç©ºãªã‚‰å·¦ï¼‰"></div></div>`; }
function buildDrugDoseSelect(name,current){
  const cfg=DRUG_CFG[name]||{unit:"",def:""};
  let opts=[];
  if(cfg.options){opts=cfg.options;}
  else{
    const dec=(v)=> (Math.round(v*100)/100).toFixed(String(cfg.step).includes('.1')?1:0);
    for(let v=cfg.min; v<=cfg.max+1e-9; v+=cfg.step){opts.push(cfg.unit==='mg'?Math.round(v):Number(dec(v))); }
  }
  const cur=(current!=null)?current:cfg.def;
  const html=`<label>é‡ï¼ˆ${cfg.unit}${cfg.note?`ï¼‰<span class="small">${cfg.note}</span>`:')'}</label>
  <select id="eDose">${opts.map(v=>`<option ${String(v)===String(cur)?'selected':''}>${v}</option>`).join('')}</select>`;
  return html;
}
function openEdit(id){
  const c=state.tl.find(x=>x.id===id); if(!c) return;
  let html=`<div class="small">æ™‚åˆ»ä¿®æ­£</div>${timeChooser()}`;
  if(c.type==='patient'){
    html+=`<label style="margin-top:6px">å¹´é½¢</label><input id="eAge" value="${escapeHTML(c.body.age||'')}">
           <label>æ€§åˆ¥</label><input id="eSex" value="${escapeHTML(c.body.sex||'')}">
           <label>ç¾ç—…æ­´</label><textarea id="eHpi">${escapeHTML(c.body.hpi||'')}</textarea>
           <label>æ—¢å¾€æ­´</label><textarea id="ePmh">${escapeHTML(c.body.pmh||'')}</textarea>
           <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label><textarea id="eAlg">${escapeHTML(c.body.allergy||'')}</textarea>`;
  } else if(c.type==='vitals'){
    const v=c.body; html+=`<div class="grid3" style="margin-top:6px">
      <div><label>HR</label><input id="eHR" type="number" value="${safe(v.HR)}"></div>
      <div><label>RR</label><input id="eRR" type="number" value="${safe(v.RR)}"></div>
      <div><label>SBP</label><input id="eSBP" type="number" value="${safe(v.SBP)}"></div>
      <div><label>DBP</label><input id="eDBP" type="number" value="${safe(v.DBP)}"></div>
      <div><label>SpOâ‚‚</label><input id="eSpO2" type="number" value="${safe(v.SpO2)}"></div>
      <div><label>BT</label><input id="eBT" type="number" step="0.1" value="${safe(v.BT)}"></div>
      <div><label>GCS-E</label><input id="eE" type="number" min="1" max="4" value="${safe(v.GCS.E)}"></div>
      <div><label>GCS-V</label><select id="eV"><option></option><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option><option ${v.GCS.V==='1T'?'selected':''}>1T</option></select></div>
      <div><label>GCS-M</label><input id="eM" type="number" min="1" max="6" value="${safe(v.GCS.M)}"></div>
    </div>
    <label style="margin-top:6px">å‚™è€ƒ</label><input id="eNote" value="${escapeHTML(v.note||'')}">`;
  } else if(c.type==='exam'){
    html+=`<label style="margin-top:6px">ï¼ˆï¼‹ï¼‰æ‰€è¦‹</label><textarea id="ePlus">${(c.body.plus||[]).join('ã€')}</textarea>
           <label>ï¼ˆâˆ’ï¼‰æ‰€è¦‹</label><textarea id="eMinus">${(c.body.minus||[]).join('ã€')}</textarea>
           <label>å‚™è€ƒ</label><input id="eENote" value="${escapeHTML(c.body.note||'')}">`;
  } else if(c.type==='procedure'){
    if(c.body.cat==='vent'){
      const v=c.body.vent||{};
      html+=`<div class="grid2" style="margin-top:6px">
        <div><label>ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</label><select id="eVentMain"><option ${v.main==='A/C'?'selected':''}>A/C</option><option ${v.main==='PC'?'selected':''}>PC</option></select></div>
        <div><label>ã‚µãƒ–ï¼ˆPC/PSç­‰ï¼‰</label><select id="eVentSub"><option ${v.sub==='PC'?'selected':''}>PC</option><option ${v.sub==='PS'?'selected':''}>PS</option></select></div>
      </div>
      <div class="grid3" style="margin-top:6px">
        <div><label>fï¼ˆå›/åˆ†ï¼‰</label><input id="eVentF" type="number" value="${safe(v.f)||15}"></div>
        <div><label>FiOâ‚‚</label><input id="eVentFiO2" type="number" step="0.1" value="${safe(v.fio2)||1.0}"></div>
        <div><label>Piï¼ˆcmHâ‚‚Oï¼‰</label><input id="eVentPi" type="number" value="${safe(v.pi)||15}"></div>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="col"><label>PEEP</label><input id="eVentPEEP" type="number" value="${safe(v.peep)||5}"></div>
      </div>`;
    } else if(c.body.cat==='ecg'){
      html+=`<div class="grid2" style="margin-top:6px">
        <div><label>STå¤‰åŒ–</label><select id="eECGST"><option></option><option ${c.body.st==='STä¸Šæ˜‡'?'selected':''}>STä¸Šæ˜‡</option><option ${c.body.st==='STä½ä¸‹'?'selected':''}>STä½ä¸‹</option><option ${c.body.st==='ãªã—'?'selected':''}>ãªã—</option><option ${c.body.st==='ä¸æ˜'?'selected':''}>ä¸æ˜</option></select></div>
        <div><label>ä¸æ•´è„ˆ</label><select id="eECGArr"><option></option><option ${c.body.arr==='Af'?'selected':''}>Af</option><option ${c.body.arr==='VT'?'selected':''}>VT</option><option ${c.body.arr==='PVC'?'selected':''}>PVC</option><option ${c.body.arr==='PSVT'?'selected':''}>PSVT</option><option ${c.body.arr==='å¾è„ˆ'?'selected':''}>å¾è„ˆ</option><option ${c.body.arr==='é »è„ˆ'?'selected':''}>é »è„ˆ</option><option ${c.body.arr==='ãªã—'?'selected':''}>ãªã—</option><option ${c.body.arr==='ä¸æ˜'?'selected':''}>ä¸æ˜</option></select></div>
      </div>`;
    } else if(c.body.cat==='fast'){
      html+=`<label style="margin-top:6px">FAST æ‰€è¦‹ï¼ˆï¼‹/âˆ’ï¼‰</label>
      <div class="chips" id="eFAST">
        ${["å¿ƒåš¢æ°´","èƒ¸æ°´","ãƒ¢ãƒªã‚½ãƒ³çª©","è„¾å‘¨å›²","éª¨ç›¤è…”å†…","lung sliding signæ¶ˆå¤±"].map(n=>{
          const st=(c.body.plus||[]).includes(n)?1:(c.body.minus||[]).includes(n)?-1:0;
          const cls=st===1?'plus':st===-1?'minus':'';
          return `<div class="chip ${cls}" data-name="${n}" data-state="${st}">${n}</div>`;
        }).join('')}
      </div>`;
    } else {
      html+=`<label style="margin-top:6px">è©³ç´°</label><input id="ePDetail" value="${escapeHTML(c.body.detail||'')}">`;
      if((c.body.cat||'').includes('fluid')||(c.body.title||'').includes('è¼¸æ¶²')){
        html+=`<label style="margin-top:6px">è¼¸æ¶² çµ‚äº†æ™‚åˆ»ï¼ˆä»»æ„ HH:MMï¼‰</label><input id="eEnd" placeholder="ä¾‹ 12:58" value="${c.body.end_time?hhmm(c.body.end_time):''}">`;
      }
    }
  } else if(c.type==='drug'){
    html+=`<div style="margin-top:6px">${buildDrugDoseSelect(c.body.name, c.body.dose)}</div>`;
  } else if(c.type==='measure'){
    html+=`<div class="row" style="margin-top:6px">
      <div class="col"><label>${c.body.name}ï¼ˆ${c.body.unit}ï¼‰</label><input id="eMeas" type="number" value="${safe(c.body.value)}"></div>
    </div>`;
  }
  html+=`<input type="hidden" id="editId" value="${c.id}">`;
  $('#editBody').innerHTML=html;

  const eFAST=$('#eFAST');
  if(eFAST){ eFAST.addEventListener('click',ev=>{
    const x=ev.target.closest('.chip'); if(!x) return;
    const st=Number(x.dataset.state||0); const n=st===0?1:(st===1?-1:0);
    x.dataset.state=String(n); x.classList.remove('plus','minus'); if(n===1) x.classList.add('plus'); else if(n===-1) x.classList.add('minus');
  });}
  dlgEdit.showModal();
}
$('#btnSaveEdit').onclick=()=>{
  const id=$('#editId')?.value; const c=state.tl.find(x=>x.id===id); if(!c) return;
  const free=$('#eTimeFree')?.value?.trim(), sel=$('#eTime')?.value; const hh=free||sel;
  if(hh){const d=new Date(); c.t=`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${hh}`;}
  if(c.type==='patient'){ c.body.age=$('#eAge')?.value||c.body.age; c.body.sex=$('#eSex')?.value||c.body.sex; c.body.hpi=$('#eHpi')?.value||""; c.body.pmh=$('#ePmh')?.value||""; c.body.allergy=$('#eAlg')?.value||""; }
  else if(c.type==='vitals'){const v=c.body; v.HR=num($('#eHR')?.value); v.RR=num($('#eRR')?.value); v.SBP=num($('#eSBP')?.value); v.DBP=num($('#eDBP')?.value); v.SpO2=num($('#eSpO2')?.value); v.BT=$('#eBT')?.value?Number($('#eBT').value):null; v.GCS={E:num($('#eE')?.value),V:$('#eV')?.value||null,M:num($('#eM')?.value)}; v.note=$('#eNote')?.value||""; }
  else if(c.type==='exam'){c.body.plus=($('#ePlus')?.value||"").split('ã€').map(s=>s.trim()).filter(Boolean); c.body.minus=($('#eMinus')?.value||"").split('ã€').map(s=>s.trim()).filter(Boolean); c.body.note=$('#eENote')?.value||"";}
  else if(c.type==='procedure'){
    if(c.body.cat==='vent'){ c.body.vent={ main:$('#eVentMain')?.value||"A/C", sub:$('#eVentSub')?.value||"PC", f:num($('#eVentF')?.value), fio2:$('#eVentFiO2')?.value, pi:num($('#eVentPi')?.value), peep:num($('#eVentPEEP')?.value)}; }
    else if(c.body.cat==='ecg'){ c.body.st=$('#eECGST')?.value||""; c.body.arr=$('#eECGArr')?.value||""; }
    else if(c.body.cat==='fast'){ const plus=[], minus=[]; $$('#eFAST .chip').forEach(x=>{const st=Number(x.dataset.state||0); if(st===1) plus.push(x.dataset.name); else if(st===-1) minus.push(x.dataset.name);}); c.body.plus=plus; c.body.minus=minus; }
    else { c.body.detail=$('#ePDetail')?.value||c.body.detail||""; const end=$('#eEnd')?.value?.trim(); if(end){const d=new Date(); c.body.end_time=`${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${end}`;} }
  }
  else if(c.type==='drug'){ c.body.dose=$('#eDose')?.value; }
  else if(c.type==='measure'){ const v=$('#eMeas')?.value; c.body.value=v!==''?Number(v):null; }
  dlgEdit.close(); renderTL();
};

/* ====== ä¸»è¨´ãƒ»EMS ====== */
function initChief(){ $('#chiefFlags').innerHTML=CHIEF_FLAGS.map(f=>`<div class="chip" data-flag="${f}">${f}</div>`).join(''); }
$('#chiefFlags').addEventListener('click',e=>{
  const c=e.target.closest('.chip'); if(!c) return;
  c.classList.toggle('on');
  if(c.dataset.flag==='CPA'){ state.cpa.active=c.classList.contains('on'); toggleCpaPanel(state.cpa.active); }
  updateChiefSummary();
});
function toggleCpaPanel(on){ $('#cpaPanel').style.display=on?'':'none'; updateCpaCounters(); }
function updateCpaCounters(){ $('#cpaCounters').textContent=`åˆæœŸæ³¢å½¢ï¼š${state.cpa.rhythm||'â€”'} / ç›®æ’ƒï¼š${state.cpa.witness||'â€”'} / BCPRï¼š${state.cpa.byst||'â€”'} / ã‚·ãƒ§ãƒƒã‚¯ ${state.cpa.shock||0}å› / ã‚¨ãƒ” ${state.cpa.epi||0}å› / ROSCï¼š${state.cpa.rosc?('ã‚ã‚Šï¼ˆ'+hhmm(state.cpa.rosc)+'ï¼‰'):'ãªã—'}`;}
function bindCpaChips(){
  $('#cpaRhythm').addEventListener('click',e=>{const x=e.target.closest('.chip'); if(!x) return; $$('#cpaRhythm .chip').forEach(n=>n.classList.remove('on')); x.classList.add('on'); state.cpa.rhythm=x.dataset.val; updateCpaCounters();});
  $('#cpaWitness').addEventListener('click',e=>{const x=e.target.closest('.chip'); if(!x) return; $$('#cpaWitness .chip').forEach(n=>n.classList.remove('on')); x.classList.add('on'); state.cpa.witness=x.dataset.val; updateCpaCounters();});
  $('#cpaByst').addEventListener('click',e=>{const x=e.target.closest('.chip'); if(!x) return; $$('#cpaByst .chip').forEach(n=>n.classList.remove('on')); x.classList.add('on'); state.cpa.byst=x.dataset.val; updateCpaCounters();});
  $('#cpaShock').onclick=()=>{ addCard('å‡¦ç½®','procedure',{title:'é™¤ç´°å‹•',detail:'',cat:'defib'}); };
  $('#cpaEpi').onclick=()=>{ addCard('è–¬å‰¤','drug',{name:'ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³',dose:DRUG_CFG['ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'].def}); };
  $('#cpaROSC').onclick=()=>{ addCard('CPA','event',{name:'ROSC'}); };
  $('#cpaSummary').onclick=()=>{ addCard('CPA','cpa',{rhythm:state.cpa.rhythm,witness:state.cpa.witness,byst:state.cpa.byst,shock:state.cpa.shock,epi:state.cpa.epi, rosc:state.cpa.rosc}); };
}
function updateChiefSummary(){ const n=$$('#chiefFlags .chip.on').length; $('#chiefSummaryHint').textContent = n?`ï¼ˆ${n}ä»¶é¸æŠä¸­ï¼‰`:'ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦é–‹ãï¼‰';}
function bindEventChips(container){
  $(container).addEventListener('click',e=>{
    const chip=e.target.closest('.chip'); if(!chip) return;
    addCard(chip.dataset.scope,'event',{name:chip.dataset.ev});
    chip.classList.toggle('on');
    if(chip.dataset.ev==='æ¥è§¦'){ startTimer(true); }
  });
}
bindEventChips('#emsEvents'); bindEventChips('#dcEvents');
$('#vrDC').onclick=()=>{$('#vrDC').classList.add('on'); $('#vrEMS').classList.remove('on'); state.vitalRail='DC';};
$('#vrEMS').onclick=()=>{$('#vrEMS').classList.add('on'); $('#vrDC').classList.remove('on'); state.vitalRail='EMS';};

/* ====== ã‚¯ã‚¤ãƒƒã‚¯ãƒ»ãƒã‚¤ã‚¿ãƒ« ====== */
function fillRange(selId,from,to,step=1){const el=$(selId); el.innerHTML='<option value=""></option>'; for(let v=from; v<=to; v+=step){el.innerHTML+=`<option value="${v}">${v}</option>`}}
function fillFloatRange(selId,from,to,step=0.1){const el=$(selId); el.innerHTML='<option value=""></option>'; for(let v=from*10; v<=to*10; v+=step*10){const n=(v/10).toFixed(1); el.innerHTML+=`<option value="${n}">${n}</option>`}}
function syncSelectInput(sel,input){sel.addEventListener('change',()=>{input.value=sel.value}); input.addEventListener('change',()=>{sel.value=input.value})}
function stepperInit(){
  document.querySelectorAll('.step button').forEach(b=>{
    b.addEventListener('click',()=>{
      const id=b.dataset.for, el=document.getElementById(id), s=Number(b.dataset.step);
      if(el.step && String(el.step).includes('0.1')){ el.value=(Number(el.value||0)+s).toFixed(1); }
      else { el.value=Number(el.value||0)+s; }
      const sel=$('#s'+id.substring(1)); if(sel) sel.value=el.value;
    });
  });
  $('#qNorm').onclick=()=>{setQ({HR:80,RR:16,SBP:120,DBP:70,SpO2:98,BT:36.8}); $('#qE').value='4'; $('#qV').value='5'; $('#qM').value='6';};
  $('#qLowBP').onclick=()=>{setQ({SBP:90,DBP:50});};
  $('#qTachy').onclick=()=>{setQ({HR:110});};
  $('#qHypox').onclick=()=>{setQ({SpO2:88});};
}
function setQ(obj){for(const k of ['HR','RR','SBP','DBP','SpO2','BT']){if(obj[k]!=null){$('#q'+k).value=obj[k]; $('#s'+k).value=String(obj[k]);}}}
function collectQuickVitals(){return {HR:num($('#qHR').value)||num($('#sHR').value), RR:num($('#qRR').value)||num($('#sRR').value), SBP:num($('#qSBP').value)||num($('#sSBP').value), DBP:num($('#qDBP').value)||num($('#sDBP').value), SpO2:num($('#qSpO2').value)||num($('#sSpO2').value), BT:($('#qBT').value||$('#sBT').value)?Number($('#qBT').value||$('#sBT').value).toFixed(1):null, GCS:{E:$('#qE').value?Number($('#qE').value):null, V:$('#qV').value||null, M:$('#qM').value?Number($('#qM').value):null}, note: $('#qNote').value||""};}
function recordVitals(){ const v=collectQuickVitals(); addCard(state.vitalRail,'vitals',v); state.vitalsLast=JSON.parse(JSON.stringify({HR:v.HR,RR:v.RR,SBP:v.SBP,DBP:v.DBP,SpO2:v.SpO2,BT:v.BT,GCS:v.GCS})); if(!state.timer.active){ startTimer(true); } }
$('#btnRecordVitals').onclick=recordVitals;

/* ====== æ‰€è¦‹ ====== */
function initExamPad(){
  Object.values(EXAM_DICT).flat().forEach(name=>{ if(!(name in state.examState)) state.examState[name]=0; });
  const tabs=Object.keys(EXAM_DICT);
  $('#examTabs').innerHTML=tabs.map((t,i)=>`<div class="chip ${i===0?'on':''}" data-tab="${t}">${t}</div>`).join('');
  loadExamPanel(tabs[0]);
  $('#examTabs').addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    $$('#examTabs .chip').forEach(x=>x.classList.remove('on')); c.classList.add('on'); loadExamPanel(c.dataset.tab);
  });
}
function loadExamPanel(tab){
  const items=EXAM_DICT[tab]||[];
  $('#examPanel').innerHTML = items.map(n=>{
    const st=state.examState[n]||0, cls=st===1?'plus':st===-1?'minus':'';
    return `<div class="chip ${cls}" data-name="${n}" data-state="${st}">${n}</div>`;
  }).join('');
}
function cycleExamChip(el){
  const st=Number(el.dataset.state||0);
  const n=st===0?1:(st===1?-1:0);
  el.dataset.state=String(n);
  el.classList.remove('plus','minus');
  if(n===1) el.classList.add('plus'); else if(n===-1) el.classList.add('minus');
  state.examState[el.dataset.name]=n;
}
$('#examPanel').addEventListener('click',e=>{const c=e.target.closest('.chip'); if(!c) return; cycleExamChip(c);});
$('#btnRecordExam').onclick=()=>{
  const plus=[],minus=[];
  for(const [name,st] of Object.entries(state.examState)){ if(st===1) plus.push(name); else if(st===-1) minus.push(name); }
  const note=$('#examFree').value||"";
  addCard('æ‰€è¦‹','exam',{plus,minus,note});
  Object.keys(state.examState).forEach(k=>state.examState[k]=0);
  $('#examFree').value='';
  const cur=$('#examTabs .chip.on')?.dataset.tab || Object.keys(EXAM_DICT)[0];
  loadExamPanel(cur);
};

/* ====== å‡¦ç½®ï¼è–¬å‰¤ ====== */
function initAirwayPad(){
  const pad=$('#padAirway');
  pad.innerHTML=AIRWAY_PAD.base.map(x=>`<div class="chip" data-k="${x}">${x}</div>`).join('');
  pad.addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return;
    const k=c.dataset.k; $('#subAirway').style.display='none'; $('#subAirway2').style.display='none'; $('#subAirway').innerHTML=''; $('#subAirway2').innerHTML='';
    if(k==='é…¸ç´ æŠ•ä¸'){
      $('#subAirway').style.display='flex';
      $('#subAirway').innerHTML = AIRWAY_PAD.O2.device.map(d=>`<div class="chip" data-dev="${d}">${d}</div>`).join('');
      $('#subAirway').onclick=(e2)=>{const d=e2.target.closest('.chip'); if(!d) return; const dev=d.dataset.dev; const flows=AIRWAY_PAD.O2.flow[dev]||[]; $('#subAirway2').style.display='flex'; $('#subAirway2').innerHTML=flows.map(f=>`<div class="chip" data-flow="${f}">${f}</div>`).join('');
        $('#subAirway2').onclick=(e3)=>{const f=e3.target.closest('.chip'); if(!f) return; addCard('å‡¦ç½®','procedure',{title:'é…¸ç´ æŠ•ä¸',detail:`${dev} ${f.dataset.flow}`,cat:'airway_oxygen'}); $('#subAirway').style.display='none'; $('#subAirway2').style.display='none'; $('#subAirway').innerHTML=''; $('#subAirway2').innerHTML='';};};
    } else if(k==='å¸å¼•'){
      $('#subAirway').style.display='flex';
      const s1=AIRWAY_PAD.SUCT.site.map(x=>`<div class="chip" data-site="${x}">${x}</div>`).join('');
      const s2=AIRWAY_PAD.SUCT.content.map(x=>`<div class="chip" data-cont="${x}">${x}</div>`).join('');
      const s3=AIRWAY_PAD.SUCT.vol.map(x=>`<div class="chip" data-vol="${x}">${x}</div>`).join('');
      $('#subAirway').innerHTML=s1+s2+s3; let site='',cont='',vol='';
      $('#subAirway').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return;
        if(n.dataset.site) site=n.dataset.site; if(n.dataset.cont) cont=n.dataset.cont; if(n.dataset.vol) vol=n.dataset.vol;
        if(site&&cont&&vol){ addCard('å‡¦ç½®','procedure',{title:'å¸å¼•',detail:`${site} / ${cont} / ${vol}`,cat:'airway_suction'}); $('#subAirway').style.display='none'; $('#subAirway').innerHTML=''; }
      };
    } else if(k==='ç•°ç‰©é™¤å»'){
      $('#subAirway').style.display='flex';
      const m=AIRWAY_PAD.FOB.method.map(x=>`<div class="chip" data-m="${x}">${x}</div>`).join('');
      const r=AIRWAY_PAD.FOB.result.map(x=>`<div class="chip" data-r="${x}">${x}</div>`).join('');
      $('#subAirway').innerHTML=m+r; let mm='',rr='';
      $('#subAirway').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return;
        if(n.dataset.m) mm=n.dataset.m; if(n.dataset.r) rr=n.dataset.r;
        if(mm&&rr){ addCard('å‡¦ç½®','procedure',{title:'ç•°ç‰©é™¤å»',detail:`${mm} / çµæœ:${rr}`,'cat':'airway_foreign'}); $('#subAirway').style.display='none'; $('#subAirway').innerHTML=''; }
      };
    } else if(k==='BVMæ›æ°—'){
      addCard('å‡¦ç½®','procedure',{title:'BVMæ›æ°—',detail:'',cat:'airway_bvm'});
    } else if(k==='å£°é–€ä¸Šå™¨å…·'){
      $('#subAirway').style.display='flex';
      $('#subAirway').innerHTML=AIRWAY_PAD.ADJ.device.map(x=>`<div class="chip" data-a="${x}">${x}</div>`).join('');
      $('#subAirway').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return; addCard('å‡¦ç½®','procedure',{title:'å£°é–€ä¸Šå™¨å…·',detail:n.dataset.a,cat:'airway_sgad'}); $('#subAirway').style.display='none'; $('#subAirway').innerHTML=''; };
    } else if(k==='æ°—ç®¡æŒ¿ç®¡'){
      $('#subAirway').style.display='flex';
      const t=AIRWAY_PAD.INT.tube.map(x=>`<div class="chip" data-t="${x}">${x}</div>`).join('');
      const d=AIRWAY_PAD.INT.depth.map(x=>`<div class="chip" data-d="${x}">${x}</div>`).join('');
      const c2=AIRWAY_PAD.INT.confirm.map(x=>`<div class="chip" data-c="${x}">${x}</div>`).join('');
      $('#subAirway').innerHTML=t+d+c2; let tube='',depth=''; const conf=new Set();
      $('#subAirway').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return;
        if(n.dataset.t) tube=n.dataset.t; if(n.dataset.d) depth=n.dataset.d;
        if(n.dataset.c){ if(conf.has(n.dataset.c)) conf.delete(n.dataset.c); else conf.add(n.dataset.c); n.classList.toggle('on'); }
        if(tube&&depth&&conf.size>0){ addCard('å‡¦ç½®','procedure',{title:'æ°—ç®¡æŒ¿ç®¡',detail:`${tube} / ${depth} / ç¢ºèª:${[...conf].join('ãƒ»')}`,cat:'airway_intubation'}); $('#subAirway').style.display='none'; $('#subAirway').innerHTML=''; }
      };
    } else if(k==='äººå·¥å‘¼å¸å™¨'){
      addCard('å‡¦ç½®','procedure',{title:'äººå·¥å‘¼å¸å™¨',cat:'vent',vent:{main:"A/C",sub:"PC",f:15,fio2:1.0,pi:15,peep:5}});
    }
  });
}
function initCircPad(){
  const pad=$('#padCirc');
  pad.innerHTML=CIRC_PAD.base.map(x=>`<div class="chip" data-k="${x}">${x}</div>`).join('');
  pad.addEventListener('click',e=>{
    const c=e.target.closest('.chip'); if(!c) return; const k=c.dataset.k;
    $('#subCirc').style.display='none'; $('#subCirc').innerHTML='';
    if(k==='IVãƒ«ãƒ¼ãƒˆ#1'||k==='IVãƒ«ãƒ¼ãƒˆ#2'){
      $('#subCirc').style.display='flex';
      const site=CIRC_PAD.IV.site.map(x=>`<div class="chip" data-s="${x}">${x}</div>`).join('');
      const g=CIRC_PAD.IV.gauge.map(x=>`<div class="chip" data-g="${x}">${x}</div>`).join('');
      $('#subCirc').innerHTML=site+g; let s='',gg='';
      $('#subCirc').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return; if(n.dataset.s) s=n.dataset.s; if(n.dataset.g) gg=n.dataset.g; if(s&&gg){ addCard('å‡¦ç½®','procedure',{title:k,detail:`${s} / ${gg}`,cat:'iv_line'}); $('#subCirc').style.display='none'; $('#subCirc').innerHTML=''; }};
    } else if(k==='è¼¸æ¶²é–‹å§‹'){
      $('#subCirc').style.display='flex';
      const kind=CIRC_PAD.FLUID.kind.map(x=>`<div class="chip" data-kd="${x}">${x}</div>`).join('');
      const vol=CIRC_PAD.FLUID.vol.map(x=>`<div class="chip" data-v="${x}">${x}</div>`).join('');
      $('#subCirc').innerHTML=kind+vol; let kd='',v='';
      $('#subCirc').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return; if(n.dataset.kd) kd=n.dataset.kd; if(n.dataset.v) v=n.dataset.v; if(kd&&v){ addCard('å‡¦ç½®','procedure',{title:'è¼¸æ¶²é–‹å§‹',detail:`${kd} / ${v}`,cat:'fluid'}); $('#subCirc').style.display='none'; $('#subCirc').innerHTML=''; }};
    } else if(k==='æ­¢è¡€'){
      $('#subCirc').style.display='flex';
      const m=CIRC_PAD.HEMO.method.map(x=>`<div class="chip" data-m="${x}">${x}</div>`).join(''); const s=CIRC_PAD.HEMO.site.map(x=>`<div class="chip" data-s="${x}">${x}</div>`).join('');
      $('#subCirc').innerHTML=m+s; let mm='',ss='';
      $('#subCirc').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return; if(n.dataset.m) mm=n.dataset.m; if(n.dataset.s) ss=n.dataset.s; if(mm&&ss){ addCard('å‡¦ç½®','procedure',{title:'æ­¢è¡€',detail:`${mm} / ${ss}`,cat:'hemostasis'}); $('#subCirc').style.display='none'; $('#subCirc').innerHTML=''; }};
    } else if(k==='éª¨ç›¤å›ºå®š'){
      addCard('å‡¦ç½®','procedure',{title:'éª¨ç›¤å›ºå®š',detail:'',cat:'pelvic'});
    } else if(k==='èƒ¸è…”ãƒ‰ãƒ¬ãƒ¼ãƒ³'){
      $('#subCirc').style.display='flex';
      const s=CIRC_PAD.DRAIN.side.map(x=>`<div class="chip" data-sd="${x}">${x}</div>`).join(''); const sz=CIRC_PAD.DRAIN.size.map(x=>`<div class="chip" data-sz="${x}">${x}</div>`).join('');
      $('#subCirc').innerHTML=s+sz; let sd='',size='';
      $('#subCirc').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return; if(n.dataset.sd) sd=n.dataset.sd; if(n.dataset.sz) size=n.dataset.sz; if(sd&&size){ addCard('å‡¦ç½®','procedure',{title:'èƒ¸è…”ãƒ‰ãƒ¬ãƒ¼ãƒ³',detail:`${sd} / ${size}`,cat:'chest_drain'}); $('#subCirc').style.display='none'; $('#subCirc').innerHTML=''; }};
    } else if(k==='å¿ƒåš¢ç©¿åˆº'){
      addCard('å‡¦ç½®','procedure',{title:'å¿ƒåš¢ç©¿åˆº',detail:'',cat:'pericardiocentesis'});
    } else if(k==='ç¸«åˆ'){
      $('#subCirc').style.display='flex';
      const st=CIRC_PAD.SUTURE.site.map(x=>`<div class="chip" data-s="${x}">${x}</div>`).join('');
      $('#subCirc').innerHTML=st; let s='';
      $('#subCirc').onclick=(e2)=>{const n=e2.target.closest('.chip'); if(!n) return; if(n.dataset.s) s=n.dataset.s; if(s){ addCard('å‡¦ç½®','procedure',{title:'ç¸«åˆ',detail:`${s}`,cat:'suture'}); $('#subCirc').style.display='none'; $('#subCirc').innerHTML=''; }};
    }
  });
}

/* è¨˜éŒ²è£œåŠ© */
function initQuickPad(){
  $('#padQuick').innerHTML = QUICK_PAD.map(x=>`<div class="chip" data-title="${x.title}" data-cat="${x.cat}" data-type="${x.type}">${x.title}</div>`).join('');
  $('#padQuick').onclick=(e)=>{
    const c=e.target.closest('.chip'); if(!c) return;
    const type=c.dataset.type;
    $('#subQuick').style.display='none'; $('#subQuickCtl').style.display='none'; $('#subQuick').innerHTML='';
    if(type==='ecg'){
      addCard('å‡¦ç½®','procedure',{title:'12èª˜å°å¿ƒé›»å›³',cat:'ecg',st:'',arr:''});
    } else if(type==='fast'){
      const items=["å¿ƒåš¢æ°´","èƒ¸æ°´","ãƒ¢ãƒªã‚½ãƒ³çª©","è„¾å‘¨å›²","éª¨ç›¤è…”å†…","lung sliding signæ¶ˆå¤±"];
      $('#subQuick').style.display='flex';
      $('#subQuick').innerHTML = items.map(n=>`<div class="chip" data-name="${n}" data-state="0">${n}</div>`).join('');
      $('#subQuickCtl').style.display='flex';
    } else if(type==='glucose'){
      addCard('æ¸¬å®š','measure',{name:'è¡€ç³–æ¸¬å®š',value:null,unit:'mg/dL'});
    } else if(type==='defib'){
      addCard('å‡¦ç½®','procedure',{title:'é™¤ç´°å‹•',detail:'',cat:'defib'});
    } else {
      addCard('å‡¦ç½®','procedure',{title:c.dataset.title,detail:'',cat:c.dataset.cat});
    }
  };
  $('#btnFastRecord').onclick=()=>{
    const plus=[], minus=[];
    $$('#subQuick .chip').forEach(x=>{const st=Number(x.dataset.state||0); if(st===1) plus.push(x.dataset.name); else if(st===-1) minus.push(x.dataset.name);});
    addCard('å‡¦ç½®','procedure',{title:'ã‚¨ã‚³ãƒ¼FAST',cat:'fast',plus,minus});
    $('#subQuick').style.display='none'; $('#subQuick').innerHTML=''; $('#subQuickCtl').style.display='none';
  };
  $('#subQuick').addEventListener('click',ev=>{
    const x=ev.target.closest('.chip'); if(!x) return;
    const st=Number(x.dataset.state||0); const n=st===0?1:(st===1?-1:0);
    x.dataset.state=String(n); x.classList.remove('plus','minus'); if(n===1) x.classList.add('plus'); else if(n===-1) x.classList.add('minus');
  });
}

/* è–¬å‰¤ */
function initDrugs(){
  $('#padDrugs').innerHTML = DRUGS.map(n=>`<div class="chip" data-name="${n}">${n}</div>`).join('');
  $('#padDrugs').onclick=(e)=>{
    const c=e.target.closest('.chip'); if(!c) return;
    const name=c.dataset.name; const def=DRUG_CFG[name]?.def;
    addCard('è–¬å‰¤','drug',{name,dose:def});
  };
}

/* ====== ã‚¿ã‚¤ãƒãƒ¼ï¼ˆ5åˆ†ï¼‰ ====== */
let uiInterval=null; const dlgTimer=$('#dlgTimer');
function formatRemain(ms){ if(ms<0) ms=0; const s=Math.floor(ms/1000); const m=Math.floor(s/60), r=s%60; return `Tâˆ’${z(m)}:${z(r)}`; }
function startTimer(vibrate=false){
  if(state.timer.active) return;
  state.timer.active=true; state.timer.next=Date.now()+5*60*1000;
  $('#timerToggle').classList.add('on'); $('#timerToggle').textContent='â± 5åˆ†ã‚¿ã‚¤ãƒãƒ¼ï¼šON'; $('#timerRemain').style.display='inline-block';
  if(uiInterval) clearInterval(uiInterval);
  uiInterval=setInterval(()=>{
    if(!state.timer.active){ clearInterval(uiInterval); return; }
    const remain = state.timer.next - Date.now();
    $('#timerRemain').textContent = formatRemain(remain);
    if(remain<=0){
      state.timer.next += 5*60*1000;
      try{navigator.vibrate?.(200);}catch(e){}
      if(typeof dlgTimer.showModal==='function' && !dlgTimer.open){ dlgTimer.showModal(); }
    }
  },1000);
  if(vibrate){ try{navigator.vibrate?.(50);}catch(e){} }
}
function stopTimer(){ state.timer.active=false; state.timer.next=null; if(uiInterval) clearInterval(uiInterval); $('#timerToggle').classList.remove('on'); $('#timerToggle').textContent='â± 5åˆ†ã‚¿ã‚¤ãƒãƒ¼ï¼šOFF'; $('#timerRemain').style.display='none';}
$('#timerToggle').onclick=()=>{ if(state.timer.active) stopTimer(); else startTimer(true); };
$('#timerRecord').onclick=()=>{ dlgTimer.close(); recordVitals(); };
$('#timerSkip').onclick=()=>{ dlgTimer.close(); };
$('#timerStop').onclick=()=>{ dlgTimer.close(); stopTimer(); };

/* ====== å‡ºåŠ›/ã‚³ãƒ”ãƒ¼/åˆæœŸåŒ– ====== */
$('#btnExport').onclick=()=> $('#out').value=buildOutput(false);
$('#btnExportChrono').onclick=()=> $('#out').value=buildOutput(true);
$('#btnCopy').onclick=async()=>{ if(!$('#out').value) $('#out').value=buildOutput(false); try{await navigator.clipboard.writeText($('#out').value); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');}catch(e){alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');}};
$('#btnReset').onclick=()=>{ if(confirm('å…¨å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) location.reload(); };

/* ====== æ‚£è€…æƒ…å ± ====== */
function fillAges(){ const sel=$('#ageSelect'); sel.innerHTML='<option value=""></option>'; for(let i=0;i<=110;i++){ sel.innerHTML+=`<option>${i}</option>`; } }
$('#ageCertain').onclick=()=>{ $('#ageCertain').classList.add('on'); $('#ageEstimated').classList.remove('on'); $('#ageCertainRow').style.display='flex'; $('#ageEstimatedRow').style.display='none'; };
$('#ageEstimated').onclick=()=>{ $('#ageEstimated').classList.add('on'); $('#ageCertain').classList.remove('on'); $('#ageCertainRow').style.display='none'; $('#ageEstimatedRow').style.display='flex'; };
$('#sexChips').addEventListener('click',e=>{const c=e.target.closest('.chip'); if(!c) return; $$('#sexChips .chip').forEach(x=>x.classList.remove('on')); c.classList.add('on');});
$('#btnRecordPatient').onclick=()=>{
  const certain=$('#ageCertain').classList.contains('on');
  const age= certain ? ($('#ageSelect').value?`${$('#ageSelect').value}æ­³`:'â€”') : ($('#ageDecade').value||'â€”');
  const sex = $('#sexChips .chip.on')?.dataset.sex || 'â€”';
  const hpi=$('#hpi').value||''; const pmh=$('#pmh').value||''; const allergy=$('#allergy').value||'';
  addCard('æ‚£è€…','patient',{age,sex,hpi,pmh,allergy});
};

/* ====== æŠ˜ã‚ŠãŸãŸã¿ã®UX ====== */
['accChief','accVitals'].forEach(id=>{
  const el=document.getElementById(id);
  el?.addEventListener('toggle',()=>{ if(el.open){ setTimeout(()=>{ el.scrollIntoView({block:'start'}); },0); }});
});

/* ====== èµ·å‹• ====== */
function boot(){
  fillRange('#sHR',30,180,1); fillRange('#sRR',6,40,1); fillRange('#sSBP',60,220,1); fillRange('#sDBP',30,140,1); fillRange('#sSpO2',50,100,1); fillFloatRange('#sBT',34.0,41.0,0.1);
  syncSelectInput($('#sHR'),$('#qHR')); syncSelectInput($('#sRR'),$('#qRR')); syncSelectInput($('#sSBP'),$('#qSBP')); syncSelectInput($('#sDBP'),$('#qDBP')); syncSelectInput($('#sSpO2'),$('#qSpO2')); syncSelectInput($('#sBT'),$('#qBT'));
  initChief(); bindCpaChips();
  initExamPad(); initAirwayPad(); initCircPad(); initQuickPad(); initDrugs();
  stepperInit(); fillAges();
  renderTL();
}
boot();
</script>
</body>
</html>

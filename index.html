<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼æ´»å‹•è¨˜éŒ² v3.0 (2026/01/19) - ã‚¿ãƒ–ç‰ˆ</title>
<style>
:root{
  --ink:#111827;--muted:#6b7280;--bg:#f2f2f7;--card:#fff;
  --line:#c6c6c8;--brand:#007aff;--chip:#f2f2f7;
  --safe-top:env(safe-area-inset-top);
  --safe-bottom:env(safe-area-inset-bottom);
}
/* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã€-webkit-tap-highlight-color: transparent ã‚’å‰Šé™¤ */
*{box-sizing:border-box;}
html,body{margin:0;padding:0;overscroll-behavior:none}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",sans-serif;
  color:var(--ink);background:var(--bg);
  padding-bottom:calc(60px + var(--safe-bottom));
}
header{
  position:sticky;top:0;z-index:100;
  background:rgba(242,242,247,0.94);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-bottom:0.5px solid var(--line);
  padding:calc(12px + var(--safe-top)) 16px 12px;
}
h1{margin:0;font-size:17px;font-weight:600;text-align:center}
.version{margin:4px 0 0;color:var(--muted);font-size:12px;text-align:center}
main{padding:12px}
.card{
  background:#fff;border-radius:12px;
  margin-bottom:12px;overflow:hidden;
}
.card-header{
  padding:14px 16px 10px;
  font-size:15px;font-weight:600;
  border-bottom:0.5px solid var(--line);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card-body{padding:12px 16px}
h3{margin:12px 0 8px;font-size:13px;color:var(--muted);font-weight:500}
label{font-size:13px;color:var(--muted);display:block;margin:8px 0 4px}
input,textarea,select{
  width:100%;padding:12px;
  border:none;border-radius:10px;
  background:var(--chip);font-size:16px;
  -webkit-appearance:none;
}
textarea{resize:none;min-height:80px}
select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.time-row{display:flex;gap:8px;align-items:center}
.time-row input{flex:1}
.time-btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:8px;
  padding:12px 14px;font-size:14px;font-weight:500;
  white-space:nowrap;
}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.chip{
  background:var(--chip);border:1.5px solid transparent;
  border-radius:20px;padding:8px 14px;
  font-size:12px;font-weight:500;
  user-select:none;cursor:pointer;
  transition:all 0.15s;
}
.chip:active{transform:scale(0.95)}
.chip.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.chip[data-state="on"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="+"]{background:#fee2e2;border-color:#f87171;color:#b91c1c}
.chip[data-state="-"]{background:#dcfce7;border-color:#4ade80;color:#15803d}
.chip[data-state="proc"]{background:var(--brand);color:#fff}
.btn{
  background:var(--brand);color:#fff;
  border:none;border-radius:10px;
  padding:14px 20px;font-size:15px;font-weight:600;
  width:100%;
}
.btn:active{opacity:0.8}
.btn.ghost{background:var(--chip);color:var(--ink)}
.btn.small{padding:10px 16px;font-size:14px}
.btn-row{display:flex;gap:10px;margin-top:12px}
.btn-row .btn{flex:1}

/* ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆç›®æ’ƒã‚ã‚Š/ãªã—ç­‰ï¼‰ */
.toggle-btn{
  background:var(--chip);
  border:1.5px solid var(--line);
  border-radius:10px;
  padding:10px 16px;
  font-size:15px;font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  text-align:center;
  user-select:none;
}
.toggle-btn:active{transform:scale(0.97)}
.toggle-btn.active{
  background:#dcfce7;
  border-color:#4ade80;
  color:#15803d;
}

/* æ–°ã—ã„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒˆã‚°ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
.check-toggle {
  background: var(--chip);
  border: 1.5px solid var(--line);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  user-select: none;
  min-width: 120px; /* è¦‹æ „ãˆã®ãŸã‚ã«å¹…ã‚’èª¿æ•´ */
}
.check-toggle:active{transform:scale(0.97)}
.check-toggle input[type="checkbox"] {
  display: none; /* å…ƒã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯éè¡¨ç¤ºã« */
}
.check-toggle.active {
  background: #dcfce7;
  border-color: #4ade80;
  color: #15803d;
}
.check-toggle.active:before {
  content: "âœ… "; /* ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¿½åŠ  */
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
@keyframes checkFlash {
  0% { background: transparent; }
  50% { background: rgba(0, 122, 255, 0.15); }
  100% { background: transparent; }
}
.check-flash {
  animation: checkFlash 0.4s ease-out;
  border-radius: 8px;
}

/* ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ - ãƒ€ã‚¤ãƒ¤ãƒ«å¼ */
.vital-card{
  background:#fff;border-radius:12px;
  margin-top:10px;overflow:hidden;
  border:1px solid var(--line);
}
.vital-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 14px;background:#f9fafb;
  border-bottom:0.5px solid var(--line);
}
.vital-time{
  display:flex;align-items:center;gap:8px;
}
.vital-time input{
  width:100px;padding:8px 10px;
  font-size:15px;font-weight:600;
  color:var(--brand);background:#fff;
  border:1px solid var(--line);border-radius:8px;
}
.vital-del{
  background:#fee2e2;color:#dc2626;
  border:none;border-radius:8px;
  padding:8px 12px;font-size:13px;font-weight:500;
}
.vital-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:1px;background:var(--line);
}
.vital-item{
  background:#fff;padding:10px 8px;
  text-align:center;cursor:pointer;
  transition:background 0.15s;
}
.vital-item:active{background:#f3f4f6}
.vital-label{font-size:11px;color:var(--muted);margin-bottom:4px}
.vital-value{font-size:20px;font-weight:600;color:var(--ink)}
.vital-unit{font-size:11px;color:var(--muted)}
.vital-gcs{
  grid-column:span 3;
  display:flex;justify-content:center;gap:20px;
  padding:12px;
}
.gcs-part{text-align:center;cursor:pointer}
.gcs-part span{display:block}
.gcs-part .lbl{font-size:12px;color:var(--muted)}
.gcs-part .val{font-size:22px;font-weight:600;color:var(--brand)}
.gcs-sum{
  background:var(--brand);color:#fff;
  border-radius:20px;padding:6px 16px;
  font-size:16px;font-weight:600;
  align-self:center;
}

/* ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ */
.dial-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.4);
  z-index:1000;display:none;
  align-items:flex-end;justify-content:center;
  touch-action:none;
  overscroll-behavior:contain;
}
.dial-overlay.show{display:flex}
/* iOSã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã€position:fixedã‚’å‰Šé™¤ã—ã€vhã§é«˜ã•ã‚’å›ºå®š */
body.dial-open{
  height: 100vh;
  overflow: hidden;
  /* position: fixed; ã‚’å‰Šé™¤ */
} 
.dial-container{
  background:#fff;
  border-radius:16px 16px 0 0;
  width:100%;max-width:500px;
  padding-bottom:var(--safe-bottom);
  animation:slideUp 0.25s ease-out;
}
@keyframes slideUp{from{transform:translateY(100%)}}
.dial-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 20px;border-bottom:0.5px solid var(--line);
}
.dial-title{font-size:17px;font-weight:600}
.dial-done{
  background:none;border:none;
  color:var(--brand);font-size:17px;font-weight:600;
}
.dial-body{
  display:flex;justify-content:center;
  padding:20px;gap:10px;
}
.dial-wheel{
  height:200px;width:120px;
  overflow:hidden;position:relative;
  touch-action:pan-y;
}
.dial-wheel::before,.dial-wheel::after{
  content:'';position:absolute;left:0;right:0;
  height:80px;pointer-events:none;z-index:2;
}
.dial-wheel::before{
  top:0;
  background:linear-gradient(to bottom,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-wheel::after{
  bottom:0;
  background:linear-gradient(to top,rgba(255,255,255,1),rgba(255,255,255,0));
}
.dial-highlight{
  position:absolute;top:50%;left:0;right:0;
  height:40px;transform:translateY(-50%);
  background:var(--chip);border-radius:8px;
  z-index:1;
}
.dial-scroll{
  position:relative;z-index:3;
  padding:80px 0;
  transition:transform 0.15s ease-out;
}
.dial-option{
  height:40px;display:flex;
  align-items:center;justify-content:center;
  font-size:18px;font-weight:500;
  color:#999;
  transition:all 0.15s;
}
.dial-option.selected{
  color:var(--ink);font-weight:600;
  font-size:22px;
}
.dial-unit{
  font-size:14px;color:var(--muted);
  align-self:center;
}

/* æ‰€è¦‹ã‚¿ãƒ– */
.exam-tabs{
  display:flex;gap:8px;overflow-x:auto;
  padding:0 0 10px;margin:0 -16px;padding-left:16px;
  -webkit-overflow-scrolling:touch;
}
.exam-tabs::-webkit-scrollbar{display:none}
.exam-tab{
  flex-shrink:0;
  padding:10px 16px;border-radius:20px;
  background:var(--chip);font-size:14px;font-weight:500;
  cursor:pointer;
}
.exam-tab.active{background:var(--brand);color:#fff}
.exam-pane{display:none}
.exam-pane.active{display:block}
.memo{
  margin-top:8px;background:var(--chip);
  border-radius:10px;padding:12px;
  font-size:14px;min-height:60px;
}

/* å‡ºåŠ›ã‚¨ãƒªã‚¢ */
.result{
  white-space:pre-wrap;
  background:#fafafa;border-radius:12px;
  padding:14px;font-size:13px;line-height:1.7;
  min-height:300px;
  border:1px dashed var(--line);
}

/* ä¸‹éƒ¨ãƒŠãƒ“ */
.bottom-nav{display:none;}
.bottom-nav .btn{flex:1;padding:12px}

/* ç—…é™¢ãƒªã‚¹ãƒˆ */
.hospital-item{
  display:flex;justify-content:space-between;
  align-items:center;padding:12px 0;
  border-bottom:0.5px solid var(--line);
}
.hospital-item:last-child{border-bottom:none}

/* ãƒã‚§ãƒƒã‚¯ãƒ©ã‚¤ãƒ³ */
.checkline{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
.checkline label{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  margin: 0;
}

.checkline input[type="checkbox"]{
  width:22px;height:22px;
  accent-color:var(--brand);
}

/* CPAã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰å†…ã®ãƒã‚§ãƒƒã‚¯ãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ”¹å–„ */
.vital-card .checkline {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 8px;
  margin-bottom: 8px; /* checklineã«ä½™ç™½ãŒãªã„å ´åˆã«å¯¾å¿œ */
}
.vital-card .checkline .check-toggle {
    padding: 8px 12px;
    font-size: 14px;
    border-radius: 8px;
    min-width: unset;
    flex-grow: 1;
}

/* ãƒ©ãƒœãƒ”ãƒ« */
.labline{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.labpill{
  display:flex;align-items:center;gap:6px;
  background:var(--chip);border-radius:20px;
  padding:8px 12px;
}
.labpill label{margin:0;font-size:13px;font-weight:500}
.labpill input{
  width:70px;padding:6px 8px;
  background:#fff;border:1px solid var(--line);
  border-radius:6px;font-size:14px;
}
.labpill .unit{font-size:12px;color:var(--muted)}
.labpill button{
  background:none;border:none;
  font-size:16px;color:#dc2626;padding:0 4px;
}

/* å•é¡Œãƒªã‚¹ãƒˆ */
/* ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿®æ­£ */
.problem-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  background:var(--chip);
  border-radius:10px;
  margin-bottom:8px;
}
.problem-item span{
  font-size:14px;
  flex:1;
  min-width:0;
}
.problem-item .del-btn{
  margin-left:12px;
  flex-shrink:0;
  padding:6px 12px;
  font-size:13px;
  background:none;
  border:1px solid #dc2626;
  color:#dc2626;
  border-radius:6px;
}

/* NIHSSãƒœã‚¿ãƒ³ */
.nihss-btn{
  min-width:36px;height:36px;
  border:1px solid var(--line);border-radius:8px;
  background:#fff;font-size:15px;font-weight:500;
  cursor:pointer;
}
.nihss-btn.active{
  background:var(--brand);color:#fff;border-color:var(--brand);
}
/* ã‚¿ãƒ–ãƒãƒ¼ */
.tab-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: calc(56px + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: #fff;
  border-top: 1px solid var(--line);
  display: flex;
  z-index: 100;
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
}
.tab-bar-item {
  flex: 0 0 auto;
  min-width: 70px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  color: var(--muted);
  font-size: 10px;
  cursor: pointer;
  transition: color 0.15s;
  padding: 4px 8px;
}
.tab-bar-item.active { color: var(--brand); font-weight: 600; }
.tab-bar-item svg {
  width: 24px;
  height: 24px;
}
.tab-bar-item span { font-weight: 500; }

/* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
.tab-content { display: none; padding: 12px; padding-bottom: 24px; }
.tab-content.active { display: block; }

/* mainã®èª¿æ•´ */
main {
  position: fixed;
  top: calc(var(--safe-top) + 60px);
  bottom: calc(56px + var(--safe-bottom));
  left: 0;
  right: 0;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
}

</style>
</head>
<body>
<header>
  <h1>ğŸš— ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼</h1>
  <div class="version">v3.0 (2026/01/19)</div>
</header>

<main>
<div class="tab-content active" data-tab="patient">
<div class="card">
    <div class="card-header">
      <span>ğŸ“ è¦è«‹æƒ…å ±</span>
      <div style="display:flex;gap:6px;align-items:center">
        <button class="btn ghost" onclick="reloadApp()" style="padding:6px 12px;font-size:12px;color:#2563eb;width:auto;flex-shrink:0">ğŸ”„ æ›´æ–°</button>
        <button class="btn ghost" onclick="resetData()" style="padding:6px 12px;font-size:12px;color:#dc2626;width:auto;flex-shrink:0">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>
    <div class="card-body">
      <label>è¦è«‹æ–¹æ³•</label>
      <select id="request_type">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¦è«‹</option>
        <option value="ç¾ç€å¾Œè¦è«‹">ç¾ç€å¾Œè¦é¸é …</option>
      </select>
      <label>å¹´ä»£</label>
      <div class="chips" id="patient_age_chips"></div>
      <label>æ€§åˆ¥</label>
      <div class="chips" id="patient_sex_chips"></div>
      <label>å…ˆè¡Œæ•‘æ€¥éšŠ</label>
      <div class="chips" id="ems_team_chips"></div>
      <label>è¦è«‹å†…å®¹</label>
      <div class="chips" id="request_content_chips"></div>
      <textarea id="request_detail" placeholder="è¦è«‹ã®è©³ç´°å†…å®¹ã‚’è¨˜è¼‰"></textarea>
      
      <h3>æ‚£è€…æƒ…å ±</h3>
      <label>æ—¢å¾€æ­´</label>
      <div class="chips" id="patient_history_chips"></div>
      <textarea id="patient_history" placeholder="æ—¢å¾€æ­´ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>å¸¸ç”¨è–¬</label>
      <div class="chips" id="patient_medication_chips"></div>
      <div id="anticoagulant_accordion" style="display:none;margin-top:8px;margin-bottom:8px">
        <details style="background:#f8fafc;border-radius:10px;padding:12px;border:1px solid var(--line)">
          <summary style="font-weight:600;cursor:pointer">æŠ—å‡å›ºè–¬é¸æŠ</summary>
          <div class="chips" id="anticoagulant_drugs" style="margin-top:8px"></div>
        </details>
      </div>
      <div id="antiplatelet_accordion" style="display:none;margin-top:8px;margin-bottom:8px">
        <details style="background:#f8fafc;border-radius:10px;padding:12px;border:1px solid var(--line)" open>
          <summary style="font-weight:600;cursor:pointer">æŠ—è¡€å°æ¿è–¬é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</summary>
          <div class="chips" id="antiplatelet_drugs" style="margin-top:8px"></div>
        </details>
      </div>
      <textarea id="patient_medication" placeholder="å¸¸ç”¨è–¬ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼</label>
      <div class="chips" id="patient_allergy_chips"></div>
      <textarea id="patient_allergy" placeholder="ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
      <label>æœ€çµ‚å¥å¸¸</label>
      <div class="time-row">
        <input type="time" id="last_well_time">
        <button class="time-btn" onclick="setNow('last_well_time')">Now</button>
      </div>
      <label>æœ€çµ‚é£Ÿäº‹æ™‚åˆ»</label>
      <div class="time-row">
        <input type="time" id="last_meal_time">
        <button class="time-btn" onclick="setNow('last_meal_time')">Now</button>
      </div>
      <label>ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢</label>
      <textarea id="patient_hospital" placeholder="ã‹ã‹ã‚Šã¤ã‘åŒ»ç™‚æ©Ÿé–¢ã‚’è¨˜è¼‰" style="min-height:60px"></textarea>
    </div>
  </div>
</div>

<div class="tab-content" data-tab="car-time">
<div class="card">
    <div class="card-header">â±ï¸ ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    <div class="card-body">
      <div class="grid2">
        <div>
          <label>è¦è«‹</label>
          <div class="time-row">
            <input type="time" id="cardr_request_time">
            <button class="time-btn" onclick="setNow('cardr_request_time')">Now</button>
          </div>
        </div>
        <div>
          <label>å‡ºå‹•</label>
          <div class="time-row">
            <input type="time" id="car_departure">
            <button class="time-btn" onclick="setNow('car_departure')">Now</button>
          </div>
        </div>
        <div>
          <label>ç¾å ´/RPåˆ°ç€</label>
          <div class="time-row">
            <input type="time" id="scene_arrival">
            <button class="time-btn" onclick="setNow('scene_arrival')">Now</button>
          </div>
        </div>
        <div>
          <label>ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ æ¥è§¦</label>
          <div class="time-row">
            <input type="time" id="cardr_contact">
            <button class="time-btn" onclick="setNow('cardr_contact')">Now</button>
          </div>
        </div>
      </div>
      <label style="margin-top:12px">æ´»å‹•å ´æ‰€</label>
      <select id="activity_place">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="ç¾å ´">ç¾å ´</option>
        <option value="RPï¼ˆãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰">RPï¼ˆãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰</option>
      </select>
    </div>
  </div>
</div>

<div class="tab-content" data-tab="ems">
<div class="card">
    <div class="card-header">ğŸš‘ å…ˆè¡Œæ•‘æ€¥éšŠ</div>
    <div class="card-body">
      <div class="grid2">
        <div>
          <label>è¦šçŸ¥</label>
          <div class="time-row">
            <input type="time" id="ems_aware">
            <button class="time-btn" onclick="setNow('ems_aware')">Now</button>
          </div>
        </div>
        <div>
          <label>ç¾ç€</label>
          <div class="time-row">
            <input type="time" id="ems_arrival">
            <button class="time-btn" onclick="setNow('ems_arrival')">Now</button>
          </div>
        </div>
        <div>
          <label>æ¥è§¦</label>
          <div class="time-row">
            <input type="time" id="ems_contact">
            <button class="time-btn" onclick="setNow('ems_contact')">Now</button>
          </div>
        </div>
        <div>
          <label>åå®¹</label>
          <div class="time-row">
            <input type="time" id="ems_pickup">
            <button class="time-btn" onclick="setNow('ems_pickup')">Now</button>
          </div>
        </div>
        <div>
          <label>ç¾ç™º</label>
          <div class="time-row">
            <input type="time" id="ems_departure">
            <button class="time-btn" onclick="setNow('ems_departure')">Now</button>
          </div>
        </div>
        <div>
          <label>RPåˆ°ç€</label>
          <div class="time-row">
            <input type="time" id="ems_rp">
            <button class="time-btn" onclick="setNow('ems_rp')">Now</button>
          </div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addEmsVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="ems_vitals_container"></div>

      <h3>æ¥è§¦æ™‚æ‰€è¦‹</h3>
      <div class="exam-tabs" id="ems_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="ems-gen-head"></div>
        <textarea class="memo" id="memo-ems-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="ems-gen-resp"></div>
        <textarea class="memo" id="memo-ems-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="ems-gen-card"></div>
        <textarea class="memo" id="memo-ems-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="ems-gen-abd"></div>
        <textarea class="memo" id="memo-ems-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="ems-gen-limb"></div>
        <textarea class="memo" id="memo-ems-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="ems-gen-neuro"></div>
        <textarea class="memo" id="memo-ems-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="ems-tra-head"></div>
        <textarea class="memo" id="memo-ems-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="ems-tra-neck"></div>
        <textarea class="memo" id="memo-ems-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="ems-tra-chest"></div>
        <textarea class="memo" id="memo-ems-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="ems-tra-abd"></div>
        <textarea class="memo" id="memo-ems-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3>
        <div class="chips" id="ems-tra-pelvis"></div>
        <textarea class="memo" id="memo-ems-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="ems-tra-limb"></div>
        <textarea class="memo" id="memo-ems-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>æ„è­˜</h3>
        <div class="chips" id="ems-str-conscious"></div>
        <h3>é¡”é¢ãƒ»ç™ºèª</h3>
        <div class="chips" id="ems-str-face"></div>
        <h3>é‹å‹•</h3>
        <div class="chips" id="ems-str-motor"></div>
        <h3>ãã®ä»–ç—‡çŠ¶</h3>
        <div class="chips" id="ems-str-other"></div>
        <label style="margin-top:12px">ç™ºç—‡æ™‚åˆ»ï¼ˆã‚ã‹ã‚Œã°ï¼‰</label>
        <div class="time-row">
          <input type="time" id="ems_stroke_onset">
          <button class="time-btn" onclick="setNow('ems_stroke_onset')">Now</button>
        </div>
        <textarea class="memo" id="memo-ems-str" placeholder="è„³å’ä¸­æ‰€è¦‹ãƒ¡ãƒ¢ï¼ˆæœ€çµ‚å¥å¸¸ç¢ºèªæ™‚åˆ»ãªã©ï¼‰"></textarea>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>åˆæœŸæ³¢å½¢</h3>
        <div class="chips" id="ems-cpa-rhythm"></div>
        <h3>ç›®æ’ƒãƒ»ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼</h3>
        <div class="chips" id="ems-cpa-witness"></div>
        <h3>æ°—é“</h3>
        <div class="chips" id="ems-cpa-airway"></div>
        <h3>å¾ªç’°</h3>
        <div class="chips" id="ems-cpa-circulation"></div>
        <h3>èƒ¸è…¹éƒ¨</h3>
        <div class="chips" id="ems-cpa-chest"></div>
        <textarea class="memo" id="memo-ems-cpa" placeholder="CPAæ‰€è¦‹ãƒ¡ãƒ¢"></textarea>
      </div>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="ems_procedures"></div>
      <div id="ems_o2_amount" style="display:none;margin-top:8px">
        <label>é…¸ç´ æŠ•ä¸é‡</label>
        <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:12px;cursor:pointer;display:inline-block;min-width:100px" onclick="openO2FlowDial()">
          <div id="o2_flow_display" style="font-size:20px;font-weight:600;color:var(--brand)">ï¼</div>
        </div>
      </div>
      <label>å‡¦ç½®è©³ç´°</label>
      <textarea id="ems_procedures_detail" placeholder="ãã®ä»–ã®å‡¦ç½®"></textarea>
    </div>
  </div>
</div>

<div class="tab-content" data-tab="doctor">
<div class="card">
    <div class="card-header">ğŸ‘¨â€âš•ï¸ ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ </div>
    <div class="card-body">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³</h3>
        <button class="btn small" onclick="addCarDrVital()">ï¼‹ è¿½åŠ </button>
      </div>
      <div id="cardr_vitals_container"></div>

      <h3 style="margin-top:16px">èº«ä½“æ‰€è¦‹</h3>
      <div class="exam-tabs" id="cardr_examTabs">
        <div class="exam-tab active" data-exam="general">æ±ç”¨</div>
        <div class="exam-tab" data-exam="trauma">å¤–å‚·</div>
        <div class="exam-tab" data-exam="stroke">è„³å’ä¸­</div>
        <div class="exam-tab" data-exam="cpa">CPA</div>
      </div>

      <div class="exam-pane active" data-pane="general">
        <h3>é ­é šéƒ¨</h3>
        <div class="chips" id="cardr-gen-head"></div>
        <textarea class="memo" id="memo-cardr-gen-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å‘¼å¸å™¨</h3>
        <div class="chips" id="cardr-gen-resp"></div>
        <textarea class="memo" id="memo-cardr-gen-resp" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å¾ªç’°å™¨</h3>
        <div class="chips" id="cardr-gen-card"></div>
        <textarea class="memo" id="memo-cardr-gen-card" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="cardr-gen-abd"></div>
        <textarea class="memo" id="memo-cardr-gen-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="cardr-gen-limb"></div>
        <textarea class="memo" id="memo-cardr-gen-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>ç¥çµŒ</h3>
        <div class="chips" id="cardr-gen-neuro"></div>
        <textarea class="memo" id="memo-cardr-gen-neuro" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="trauma">
        <h3>é ­éƒ¨ãƒ»é¡”é¢</h3>
        <div class="chips" id="cardr-tra-head"></div>
        <textarea class="memo" id="memo-cardr-tra-head" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>é ¸éƒ¨</h3>
        <div class="chips" id="cardr-tra-neck"></div>
        <textarea class="memo" id="memo-cardr-tra-neck" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>èƒ¸éƒ¨</h3>
        <div class="chips" id="cardr-tra-chest"></div>
        <textarea class="memo" id="memo-cardr-tra-chest" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>è…¹éƒ¨</h3>
        <div class="chips" id="cardr-tra-abd"></div>
        <textarea class="memo" id="memo-cardr-tra-abd" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>éª¨ç›¤</h3>
        <div class="chips" id="cardr-tra-pelvis"></div>
        <textarea class="memo" id="memo-cardr-tra-pelvis" placeholder="ãƒ¡ãƒ¢"></textarea>
        <h3>å››è‚¢</h3>
        <div class="chips" id="cardr-tra-limb"></div>
        <textarea class="memo" id="memo-cardr-tra-limb" placeholder="ãƒ¡ãƒ¢"></textarea>
      </div>

      <div class="exam-pane" data-pane="stroke">
        <h3>è„³ç¥çµŒæ‰€è¦‹</h3>
        <div class="chips" id="cardr-str-cn"></div>
        <textarea class="memo" id="memo-cardr-str-cn" placeholder="è„³ç¥çµŒãƒ¡ãƒ¢ï¼ˆè¦–åŠ›ãƒ»è¦–é‡ã€çœ¼çƒé‹å‹•ãªã©ï¼‰"></textarea>

        <h3>ç³å­”ãƒ»çœ¼çƒé‹å‹•</h3>
        <div class="grid2">
          <div>
            <label>ç³å­”å¾„ å·¦(mm)</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openPupilDial('L')">
              <span class="vital-value" id="pupilL_display">3.0</span>
            </div>
          </div>
          <div>
            <label>ç³å­”å¾„ å³(mm)</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openPupilDial('R')">
              <span class="vital-value" id="pupilR_display">3.0</span>
            </div>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>å¯¾å…‰åå°„ å·¦</label>
            <select id="plrL">
              <option value="">--</option>
              <option value="è¿…é€Ÿ">è¿…é€Ÿ</option>
              <option value="é…å»¶">é…å»¶</option>
              <option value="æ¶ˆå¤±">æ¶ˆå¤±</option>
            </select>
          </div>
          <div>
            <label>å¯¾å…‰åå°„ å³</label>
            <select id="plrR">
              <option value="">--</option>
              <option value="è¿…é€Ÿ">è¿…é€Ÿ</option>
              <option value="é…å»¶">é…å»¶</option>
              <option value="æ¶ˆå¤±">æ¶ˆå¤±</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label>å…±åŒåè¦–</label>
            <select id="str_gaze">
              <option value="">--</option>
              <option value="ãªã—">ãªã—</option>
              <option value="å³æ–¹">å³æ–¹</option>
              <option value="å·¦æ–¹">å·¦æ–¹</option>
            </select>
          </div>
          <div>
            <label>çœ¼æŒ¯</label>
            <select id="str_nyst">
              <option value="">--</option>
              <option value="ãªã—">ãªã—</option>
              <option value="æ°´å¹³">æ°´å¹³</option>
              <option value="å‚ç›´">å‚ç›´</option>
              <option value="å›æ—‹">å›æ—‹</option>
            </select>
          </div>
        </div>
        <textarea class="memo" id="memo-cardr-str-eye" placeholder="çœ¼æ‰€è¦‹ãƒ¡ãƒ¢ï¼ˆè¿½è¦–éšœå®³ã€è¤‡è¦–ãªã©ï¼‰"></textarea>

        <h3>é‹å‹•ï¼ˆMMT 0-5ï¼‰</h3>
        <div class="grid2">
          <div>
            <label>å³ä¸Šè‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('ru')">
              <span class="vital-value" id="mmt_ru_display">5</span>
            </div>
          </div>
          <div>
            <label>å·¦ä¸Šè‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('lu')">
              <span class="vital-value" id="mmt_lu_display">5</span>
            </div>
          </div>
          <div>
            <label>å³ä¸‹è‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('rl')">
              <span class="vital-value" id="mmt_rl_display">5</span>
            </div>
          </div>
          <div>
            <label>å·¦ä¸‹è‚¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px;cursor:pointer;text-align:center" onclick="openMmtDial('ll')">
              <span class="vital-value" id="mmt_ll_display">5</span>
            </div>
          </div>
        </div>
        <textarea class="memo" id="memo-cardr-str-motor" placeholder="é‹å‹•æ‰€è¦‹ãƒ¡ãƒ¢ï¼ˆç‰‡éº»ç—ºå„ªä½å´ã€ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ãƒ¼ãƒ ãªã©ï¼‰"></textarea>

        <h3>åå°„ãƒ»éŒä½“è·¯</h3>
        <div class="grid2">
          <div>
            <label>BTR</label>
            <select id="str_btr">
              <option value="">--</option>
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="äº¢é€²">äº¢é€²</option>
              <option value="ä½ä¸‹">ä½ä¸‹</option>
            </select>
          </div>
          <div>
            <label>PTR</label>
            <select id="str_ptr">
              <option value="">--</option>
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="äº¢é€²">äº¢é€²</option>
              <option value="ä½ä¸‹">ä½ä¸‹</option>
            </select>
          </div>
        </div>
        <div class="checkline" style="margin-top:8px">
          <label><input type="checkbox" id="str_babinski"> Babinskié™½æ€§</label>
          <label><input type="checkbox" id="str_chaddock"> Chaddocké™½æ€§</label>
        </div>
        <textarea class="memo" id="memo-cardr-str-reflex" placeholder="åå°„ãƒ¡ãƒ¢"></textarea>

        <h3>é«˜æ¬¡è„³æ©Ÿèƒ½ãƒ»å°è„³</h3>
        <div class="chips" id="cardr-str-higher"></div>
        <textarea class="memo" id="memo-cardr-str-higher" placeholder="è¦‹å½“è­˜ã€å¤±èªã®å‹ã€ã‚¢ã‚¿ã‚­ã‚·ã‚¢ãªã©"></textarea>

        <details style="margin-top:12px;background:#f8fafc;border-radius:10px;padding:12px;border:1px solid var(--line)">
          <summary style="font-weight:600;cursor:pointer">NIHSSï¼ˆã‚¿ãƒƒãƒ—ã§å±•é–‹ï¼‰<span id="nihss_sum" style="margin-left:8px;background:var(--brand);color:#fff;padding:2px 10px;border-radius:12px;font-size:13px">0ç‚¹</span></summary>
          <div style="margin-top:12px" id="nihss_area"></div>
          <label style="margin-top:8px">NIHSSãƒ¡ãƒ¢</label>
          <textarea class="memo" id="nihss_memo" placeholder="è©•ä¾¡æ™‚ã®æ³¨æ„ç‚¹"></textarea>
        </details>
      </div>

      <div class="exam-pane" data-pane="cpa">
        <h3>å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
        <div id="cpa_events_container"></div>
        <button class="btn small" style="margin-top:12px" onclick="addCpaEvent()">ï¼‹ å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </button>
      </div>
    </div>
  </div>
</div>

<div class="tab-content" data-tab="exam">
<div class="card">
    <div class="card-header">ğŸ§ª æ¤œæŸ»ãƒ»å‡¦ç½®ãƒ»è–¬å‰¤</div>
    <div class="card-body">
      <div class="chips" id="exam_chips"></div>
      <div id="exam_bs_area" style="display:none;margin-top:8px">
        <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:12px;cursor:pointer;display:inline-block;min-width:100px" onclick="openBsDial()">
          <div class="vital-value" id="cardr_bs_display">120</div>
          <div class="vital-unit">mg/dL</div>
        </div>
        <input type="hidden" id="cardr_bs" value="120">
      </div>
      <textarea id="exam_ucg_txt" placeholder="UCGæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_us_abd_txt" placeholder="è…¹éƒ¨USæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_us_lung_txt" placeholder="è‚ºUSæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_us_neck_txt" placeholder="é ¸éƒ¨è¡€ç®¡USæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_ecg_txt" placeholder="12èª˜å°å¿ƒé›»å›³æ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_fast_txt" placeholder="FASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      <textarea id="exam_efast_txt" placeholder="eFASTæ‰€è¦‹" style="display:none;margin-top:8px"></textarea>
      
      <div class="grid2" style="margin-top:8px">
        <div>
          <label>è¡€ã‚¬ã‚¹</label>
          <select id="cardr_abg_type" onchange="toggleAbg()">
            <option value="">æœªå®Ÿæ–½</option>
            <option value="ABG">ABG</option>
            <option value="VBG">VBG</option>
          </select>
        </div>
      </div>
      <div id="abg_area" style="display:none;margin-top:10px">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn small" onclick="addAbgSet()">ã‚»ãƒƒãƒˆè¿½åŠ </button>
          <button class="btn small ghost" onclick="clearAbg()">ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="abg_pills" class="labline"></div>
      </div>
      
      <label>æ¤œæŸ»è©³ç´°</label>
      <textarea id="cardr_exam_detail" placeholder="ãã®ä»–æ¤œæŸ»æ‰€è¦‹"></textarea>

      <h3>å®Ÿæ–½å‡¦ç½®</h3>
      <div class="chips" id="cardr_procedures"></div>
      <label>å‡¦ç½®è©³ç´°</label>
      <textarea id="cardr_procedure_detail" placeholder="å‡¦ç½®ã®è©³ç´°"></textarea>

      <h3>è–¬å‰¤æŠ•ä¸</h3>
      <div class="chips" id="cardr_drugs"></div>
      <label>è–¬å‰¤è©³ç´°</label>
      <textarea id="cardr_drug_detail" placeholder="æŠ•ä¸é‡ã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°"></textarea>
    </div>
  </div>
</div>

<div class="tab-content" data-tab="assess">
<div class="card">
    <div class="card-header">ğŸ“‹ è©•ä¾¡</div>
    <div class="card-body">
      <h3>ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆ</h3>
      <!-- ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ãƒªã‚¹ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿®æ­£æ¸ˆã¿ -->
      <div style="display:flex; gap:8px; margin-bottom:10px; align-items:flex-end;">
        <input type="text" id="new_problem" placeholder="ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ã‚’å…¥åŠ›" style="flex:1">
        <button class="btn small" style="padding:10px 12px; width:auto; flex-shrink:0" onclick="addProblem()">è¿½åŠ </button>
      </div>
      <div id="problems"></div>
      
      <label>è€ƒå¯Ÿ</label>
      <textarea id="consideration" placeholder="ç—…æ…‹ç”Ÿç†ã‚„è‡¨åºŠæ¨è«–"></textarea>
    </div>
  </div>
  
<div class="card">
  <div class="card-header">ğŸ“Š JTAS / NACA</div>
  <div class="card-body">
    <h3>JTAS</h3>
    <div class="chips" id="triage_chips"></div>
    
    <h3>NACA</h3>
    <div class="chips" id="severity_chips"></div>
  </div>
</div>
</div>

<div class="tab-content" data-tab="consider">
<div class="card">
    <div class="card-header">ğŸ¥ æ¬é€å…ˆ</div>
    <div class="card-body">
      <label>åŒ»ç™‚æ©Ÿé–¢ï¼ˆç°¡æ˜“é¸æŠï¼‰</label>
      <div class="chips" id="destination_chips"></div>
      <label>ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¼‰ï¼‰</label>
      <input type="text" id="destination_custom" placeholder="ä¸Šè¨˜ä»¥å¤–ã®åŒ»ç™‚æ©Ÿé–¢åã‚’å…¥åŠ›">
      <div id="destination_display" style="margin-top:8px;padding:10px;background:#e0f2fe;border-radius:8px;display:none">
        <span style="font-size:13px;color:#0369a1">é¸æŠä¸­ï¼š</span>
        <strong id="destination_selected"></strong>
      </div>
      <label style="margin-top:12px">é¸å®šç†ç”±</label>
      <textarea id="selection_reason" placeholder="æ¬é€å…ˆé¸å®šã®ç†ç”±"></textarea>
      
      <h3>æ¬é€æ–¹æ³•</h3>
      <select id="transport_method" onchange="toggleTransportTimes()">
        <option value="Uã‚¿ãƒ¼ãƒ³">Uã‚¿ãƒ¼ãƒ³</option>
        <option value="Jã‚¿ãƒ¼ãƒ³">Jã‚¿ãƒ¼ãƒ³</option>
        <option value="Iã‚¿ãƒ¼ãƒ³">Iã‚¿ãƒ¼ãƒ³</option>
      </select>
      
      <div id="transport_times" style="display:block">
        <div class="grid2" style="margin-top:10px">
          <div>
            <label>ç¾å ´å‡ºç™º</label>
            <div class="time-row">
              <input type="time" id="scene_departure">
              <button class="time-btn" onclick="setNow('scene_departure')">Now</button>
            </div>
          </div>
          <div>
            <label>ç—…é™¢ç€</label>
            <div class="time-row">
              <input type="time" id="hospital_arrival">
              <button class="time-btn" onclick="setNow('hospital_arrival')">Now</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="tab-content" data-tab="symptom">
<div class="card">
  <div class="card-header">ğŸ“ ç—‡çŠ¶è©³è¨˜</div>
  <div class="card-body">
    <label>â‘  è¦è«‹ç†ç”±ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
    <input type="text" id="inputTrigger" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;font-size:14px;margin-bottom:8px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn ghost" onclick="toggleTriggerCategory('trauma')" id="trigger_trauma_btn" style="flex:1">å¤–å‚·</button>
      <button class="btn ghost" onclick="toggleTriggerCategory('internal')" id="trigger_internal_btn" style="flex:1">å†…å› </button>
    </div>
    <div id="trigger_chips_container" style="display:none"></div>

    <label style="margin-top:12px">â‘¡ ç–‘ã„ç—…æ…‹ãƒ»è¨ºæ–­å</label>
    <input type="text" id="inputSuspicion" placeholder="é¸æŠã¾ãŸã¯å…¥åŠ›" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;font-size:14px;margin-bottom:8px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn ghost" onclick="toggleSuspicionCategory('trauma')" id="suspicion_trauma_btn" style="flex:1">å¤–å‚·</button>
      <button class="btn ghost" onclick="toggleSuspicionCategory('internal')" id="suspicion_internal_btn" style="flex:1">å†…å› </button>
    </div>
    <div id="suspicion_chips_container" style="display:none"></div>

    <label style="margin-top:12px">â‘¢ ç›£è¦–ã®ä¸»ãªç›®çš„ï¼ˆãƒªã‚¹ã‚¯ï¼‰</label>
    <select id="selectRisk" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;font-size:14px;background:#fff">
      <option value="general">æ±ç”¨ï¼ˆçŠ¶æ…‹ä¸è‰¯ãƒ»æ€¥å¤‰ãƒªã‚¹ã‚¯ï¼‰</option>
      <option value="shock_hemorrhagic">ã‚·ãƒ§ãƒƒã‚¯ãƒ»å¤§é‡å‡ºè¡€</option>
      <option value="shock_cardiogenic">å¿ƒåœæ­¢ãƒ»è‡´æ­»çš„ä¸æ•´è„ˆ</option>
      <option value="shock_anaphylaxis">ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼</option>
      <option value="resp_failure">å‘¼å¸ä¸å…¨ãƒ»æ°—é“ç®¡ç†</option>
      <option value="resp_sedation">é®é™ãƒ»é®ç—›ä¸‹ã®ç®¡ç†</option>
      <option value="neuro_icp">è„³å’ä¸­ãƒ»è„³åœ§ç®¡ç†</option>
      <option value="neuro_seizure">ç—™æ”£ãƒ»ã¦ã‚“ã‹ã‚“</option>
      <option value="pain_control">ç–¼ç—›ç®¡ç†ãƒ»å¤–å‚·æ¬é€</option>
      <option value="pediatric">å°å…ãƒ»ä¹³å¹¼å…</option>
      <option value="maternal">å¦Šå©¦ãƒ»èƒå…ç®¡ç†</option>
      <option value="agitation">ä¸ç©ãƒ»ç²¾ç¥ç§‘æ•‘æ€¥</option>
    </select>

    <button onclick="updateReason()" class="btn" style="margin-top:12px;width:100%">æ–‡ç« ç”Ÿæˆ</button>
    
    <label style="margin-top:12px">å‡ºåŠ›çµæœï¼ˆã‚³ãƒ”ãƒ¼å¯ï¼‰</label>
    <textarea id="outputReason" rows="4" placeholder="ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;font-size:14px;min-height:100px"></textarea>
  </div>
</div>
</div>

<div class="tab-content" data-tab="output">
<div class="card">
    <div class="card-header">ğŸ“„ æ´»å‹•è¨˜éŒ²</div>
    <div class="card-body">
      <div class="result" id="outText"></div>
    
<div style="display:flex;gap:10px;margin-top:16px;flex-wrap:wrap">
  <button class="btn" id="copyOut" style="flex:1;min-width:120px">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
  <button class="btn ghost" onclick="saveData()" style="flex:1;min-width:120px">ğŸ’¾ ä¿å­˜</button>
  <button class="btn ghost" onclick="loadData()" style="flex:1;min-width:120px">ğŸ“‚ èª­è¾¼</button>
  <button class="btn ghost" onclick="reloadApp()" style="flex:1;min-width:120px;color:#2563eb">ğŸ”„ ã‚¢ãƒ—ãƒªã‚’æ›´æ–°</button>
  <button class="btn ghost" onclick="resetData()" style="flex:1;min-width:120px;color:#dc2626">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
</div>
    </div>
  </div>
</div>

</main>

<nav class="tab-bar">
  <div class="tab-bar-item active" data-tab="patient">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
    <span>æ‚£è€…</span>
  </div>
  <div class="tab-bar-item" data-tab="car-time">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <span>ã‚«ãƒ¼æ™‚åˆ»</span>
  </div>
  <div class="tab-bar-item" data-tab="ems">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
    <span>æ•‘æ€¥éšŠ</span>
  </div>
  <div class="tab-bar-item" data-tab="doctor">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <span>æ‰€è¦‹</span>
  </div>
  <div class="tab-bar-item" data-tab="exam">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
    <span>æ¤œæŸ»</span>
  </div>
  <div class="tab-bar-item" data-tab="assess">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
    <span>è©•ä¾¡</span>
  </div>
  <div class="tab-bar-item" data-tab="consider">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
    <span>æ¬é€å…ˆ</span>
  </div>
  <div class="tab-bar-item" data-tab="symptom">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-6m-7-1a3 3 0 110-6 3 3 0 010 6z"/></svg>
    <span>ç—‡çŠ¶è©³è¨˜</span>
  </div>
  <div class="tab-bar-item" data-tab="output">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <span>å‡ºåŠ›</span>
  </div>
</nav>




<div class="dial-overlay" id="dialOverlay" onclick="closeDial(event)">
  <div class="dial-container" onclick="event.stopPropagation()" ontouchmove="event.stopPropagation()">
    <div class="dial-header">
      <span class="dial-title" id="dialTitle">å€¤ã‚’é¸æŠ</span>
      <button class="dial-done" onclick="confirmDial()">å®Œäº†</button>
    </div>
    <div class="dial-body" id="dialBody"></div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é–¢æ•°ã‚’å®šç¾©ã—ã¦ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
window.switchTab = (tab) => {
  $$('.tab-content').forEach(el => el.classList.remove('active'));
  $$('.tab-bar-item').forEach(el => el.classList.remove('active'));
  const content = $(`.tab-content[data-tab="${tab}"]`);
  const navItem = $(`.tab-bar-item[data-tab="${tab}"]`);
  if (content) content.classList.add('active');
  if (navItem) {
    navItem.classList.add('active');
    // ã‚¿ãƒ–ãƒãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãŒç”»é¢å†…ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    setTimeout(() => {
      navItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }, 50);
  }
  if (tab === 'output') render();
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
  const tabNames = {
    'patient': 'æ‚£è€…',
    'car-time': 'ã‚«ãƒ¼æ™‚åˆ»',
    'ems': 'æ•‘æ€¥éšŠ',
    'doctor': 'æ‰€è¦‹',
    'exam': 'æ¤œæŸ»',
    'assess': 'è©•ä¾¡',
    'consider': 'æ¬é€å…ˆ',
    'symptom': 'ç—‡çŠ¶è©³è¨˜',
    'output': 'å‡ºåŠ›'
  };
  const headerTitle = $('header h1');
  if (headerTitle && tabNames[tab]) {
    headerTitle.textContent = `ğŸš— ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ - ${tabNames[tab]}`;
  }
  
  // ç—‡çŠ¶è©³è¨˜ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆç‰¹ã«å¿…è¦ãªå‡¦ç†ãªã—ï¼‰
};

// ç—‡çŠ¶è©³è¨˜ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
const MedicalReasonGenerator = {
  riskTypes: {
    shock_hemorrhagic: {
      label: "å‡ºè¡€æ€§ã‚·ãƒ§ãƒƒã‚¯ãƒ»å¤–å‚·",
      text: "æ´»å‹•æ€§å‡ºè¡€ã«ã‚ˆã‚‹å¾ªç’°è¡€æ¶²é‡æ¸›å°‘æ€§ã‚·ãƒ§ãƒƒã‚¯ã¸ã®ç§»è¡Œã‚„æ€¥æ¿€ãªãƒã‚¤ã‚¿ãƒ«å¤‰å‹•ã‚’æ—©æœŸã«æ¢çŸ¥ã—ã€è¼¸æ¶²ãƒ»è¼¸è¡€ç®¡ç†ã‚’è¡Œã†ãŸã‚ã«å³é‡ãªå…¨èº«ç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    shock_cardiogenic: {
      label: "å¿ƒåŸæ€§ã‚·ãƒ§ãƒƒã‚¯ãƒ»ä¸æ•´è„ˆ",
      text: "è‡´æ­»çš„ä¸æ•´è„ˆã®å‡ºç¾ã‚„å¿ƒåœæ­¢ã«è‡³ã‚‹ãƒªã‚¹ã‚¯ãŒæ¥µã‚ã¦é«˜ãã€é™¤ç´°å‹•å™¨è£…ç€ä¸‹ã§ã®å³æ™‚å‡¦ç½®ãŠã‚ˆã³å¾ªç’°ä½œå‹•è–¬ã®åå¿œã‚’ç›£è¦–ã™ã‚‹ãŸã‚ã«æŒç¶šãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    shock_anaphylaxis: {
      label: "ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼",
      text: "æ°—é“é–‰å¡ã‚„æ€¥æ¿€ãªè¡€åœ§ä½ä¸‹ãŒé€²è¡Œã™ã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã€ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸å¾Œã®å†ç‡ƒï¼ˆäºŒç›¸æ€§åå¿œï¼‰ã‚’å«ã‚ãŸå‘¼å¸å¾ªç’°ã®å³é‡ãªç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    resp_failure: {
      label: "å‘¼å¸ä¸å…¨ãƒ»æ°—é“ç·Šæ€¥",
      text: "å‘¼å¸çŠ¶æ…‹ã®æ‚ªåŒ–ã‚„SpO2ä½ä¸‹ã«å¯¾ã—ã€é…¸ç´ æŠ•ä¸ã‚„æ°—é“ç¢ºä¿ï¼ˆæŒ¿ç®¡ãƒ»å¤–ç§‘çš„æ°—é“ç¢ºä¿ç­‰ï¼‰ã®ä»‹å…¥ã‚’é…æ»ãªãè¡Œã†ãŸã‚ã€æŒç¶šçš„ãªå‘¼å¸å¾ªç’°ç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    resp_sedation: {
      label: "é®é™ãƒ»é®ç—›ä¸‹",
      text: "æ¬é€ã®å®‰å…¨ç¢ºä¿ã®ãŸã‚ã«å®Ÿæ–½ã—ãŸé®é™ãƒ»é®ç—›è–¬ã«ã‚ˆã‚‹å‘¼å¸æŠ‘åˆ¶ã‚„è¡€åœ§ä½ä¸‹ã®å‰¯ä½œç”¨ã‚’ç›£è¦–ã—ã€æ°—é“ç®¡ç†ã‚’ç¶™ç¶šã™ã‚‹ãŸã‚ã«å¸¸æ™‚ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    neuro_icp: {
      label: "è„³åœ§äº¢é€²ãƒ»è„³å’ä¸­",
      text: "è„³ãƒ˜ãƒ«ãƒ‹ã‚¢ã®é€²è¡Œã‚„å†å‡ºè¡€ã‚’é˜²ããŸã‚ã€æ¬é€ä¸­ã®å³æ ¼ãªé™åœ§ç®¡ç†ãŠã‚ˆã³æ„è­˜ãƒ¬ãƒ™ãƒ«ã®æ¨ç§»ã‚’ç—…é™¢åˆ°ç€ã¾ã§ç›£è¦–ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚"
    },
    neuro_seizure: {
      label: "ç—™æ”£ãƒ»ã¦ã‚“ã‹ã‚“",
      text: "æ¬é€ä¸­ã®ç—™æ”£å†ç™ºã‚„é‡ç©åŒ–ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã€æŠ—ç—™æ”£è–¬æŠ•ä¸å¾Œã®å‘¼å¸æŠ‘åˆ¶ç›£è¦–ãŠã‚ˆã³èª¤åš¥é˜²æ­¢ã®ãŸã‚ã«æŒç¶šçš„ãªå…¨èº«ç®¡ç†ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    pain_control: {
      label: "ç–¼ç—›ç®¡ç†ãƒ»ä¸­ç­‰ç—‡å¤–å‚·",
      text: "ç–¼ç—›ã«ã‚ˆã‚‹è¿·èµ°ç¥çµŒåå°„ã‚„ã‚·ãƒ§ãƒƒã‚¯ã®èª˜ç™ºã‚’é˜²ãã€é®ç—›å‡¦ç½®å¾Œã®åå¿œã‚’è¦³å¯Ÿã—ãªãŒã‚‰å®‰å…¨ã«æ¬é€ã™ã‚‹ãŸã‚ã«ç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    pediatric: {
      label: "å°å…ãƒ»ä¹³å¹¼å…",
      text: "å°å…ç‰¹æœ‰ã®æ€¥æ¿€ãªä»£å„Ÿä¸å…¨ï¼ˆShock indexç­‰ã®å¤‰å‹•ï¼‰ã‚„ä½ä½“æ¸©ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã€æˆäººã¨æ¯”è¼ƒã—ã¦ã‚ˆã‚Šå³å¯†ãªãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã®æŒç¶šç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    maternal: {
      label: "å¦Šå©¦ãƒ»ç”£ç§‘æ•‘æ€¥",
      text: "æ¯ä½“ã®ã‚·ãƒ§ãƒƒã‚¯ãŒèƒå…æ©Ÿèƒ½ä¸å…¨ã«ç›´çµã™ã‚‹ãŸã‚ã€å·¦å´è‡¥ä½ä¿æŒç­‰ã®ä½“ä½ç®¡ç†ã¨ä½µã›ã¦ã€æ¯ä½“ã®å‘¼å¸å¾ªç’°å‹•æ…‹ã‚’å³é‡ã«ç›£è¦–ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚"
    },
    agitation: {
      label: "ä¸ç©ãƒ»ç²¾ç¥ç§‘æ•‘æ€¥",
      text: "è‘—ã—ã„ä¸ç©çŠ¶æ…‹ã«ã‚ˆã‚Šè‡ªèº«ã‚„å‘¨å›²ã¸ã®å±é™ºãŒåŠã¶å¯èƒ½æ€§ãŒã‚ã‚Šã€é®é™å‡¦ç½®ãŠã‚ˆã³èº«ä½“æ‹˜æŸä¸‹ã§ã®å®‰å…¨ãªæ¬é€ã‚’è¡Œã†ãŸã‚ã«ã€å‘¼å¸å¾ªç’°ã®å¸¸æ™‚ç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    },
    general: {
      label: "æ±ç”¨ãƒ»çŠ¶æ…‹ä¸è‰¯",
      text: "æ¬é€ä¸­ã®æ€¥å¤‰ãƒªã‚¹ã‚¯ãŒé«˜ãã€çŠ¶æ…‹å¤‰åŒ–ã«å¯¾ã—å³åº§ã«åŒ»å¸«ã«ã‚ˆã‚‹ä»‹å…¥ã‚’è¡Œãˆã‚‹ã‚ˆã†ã€ç—…é™¢åˆ°ç€ã¾ã§æŒç¶šçš„ãªå‘¼å¸å¾ªç’°ç›£è¦–ãŒå¿…è¦ã§ã‚ã£ãŸã€‚"
    }
  },
  triggers: {
    trauma: {
      head: ["é ­éƒ¨æ‰“æ’²", "é¡”é¢å¤–å‚·", "é«˜æ‰€è»¢è½", "é«˜ã‚¨ãƒãƒ«ã‚®ãƒ¼å¤–å‚·"],
      neck: ["é ¸éƒ¨å¤–å‚·", "é ¸éƒ¨æ‰“æ’²"],
      chest: ["èƒ¸å£å¤–å‚·", "äº¤é€šå¤–å‚·(è»Šå†…)", "äº¤é€šå¤–å‚·(æ­©è¡Œè€…)", "ãƒã‚¤ã‚¯äº‹æ•…"],
      abdomen: ["è…¹éƒ¨å¤–å‚·", "æŒŸã¾ã‚Œãƒ»å·»ãè¾¼ã¾ã‚Œ"],
      pelvis: ["éª¨ç›¤å¤–å‚·", "éª¨ç›¤éª¨æŠ˜ç–‘ã„"],
      limb: ["å››è‚¢ã®å¤‰å½¢", "åˆºå‰µãƒ»åˆ‡å‰µ", "é–‹æ”¾å‰µ"],
      other: ["åºƒç¯„å›²ç†±å‚·", "æººæ°´", "ä½ä½“æ¸©"]
    },
    internal: {
      head: ["çªç„¶ã®æ„è­˜æ¶ˆå¤±", "æ¿€ã—ã„é ­ç—›", "éº»ç—ºãƒ»æ§‹èªéšœå®³", "ç—™æ”£ç™ºä½œ", "CPA(è˜‡ç”Ÿå¾Œ)", "å°å…ã®æ„è­˜éšœå®³"],
      chest: ["æ¿€ã—ã„èƒ¸ç—›", "èƒŒéƒ¨ç—›", "å‘¼å¸å›°é›£", "å–˜é³´", "å–€è¡€"],
      abdomen: ["åè¡€ãƒ»ä¸‹è¡€", "æ¿€ã—ã„è…¹ç—›"],
      other: ["è–¬ç‰©éé‡å†…æœ(OD)", "ã‚¢ãƒŠãƒ•ã‚£ãƒ©ã‚­ã‚·ãƒ¼ç–‘ã„", "ç†±ä¸­ç—‡ç–‘ã„", "åˆ†å¨©é€²è¡Œãƒ»ç ´æ°´"]
    }
  },
  suspicions: {
    trauma: {
      head: ["è„³æŒ«å‚·ãƒ»æ€¥æ€§ç¡¬è†œä¸‹è¡€è…«", "æ€¥æ€§ç¡¬è†œå¤–è¡€è…«", "é ­è“‹éª¨éª¨æŠ˜", "é¡”é¢éª¨éª¨æŠ˜"],
      neck: ["é ¸æ¤æå‚·", "è„Šé«„æå‚·"],
      chest: ["è‚ºæŒ«å‚·", "è¡€èƒ¸", "ç·Šå¼µæ€§æ°—èƒ¸", "æ°—é“ç†±å‚·", "è‚‹éª¨éª¨æŠ˜", "èƒ¸éª¨éª¨æŠ˜"],
      abdomen: ["è…¹è…”å†…å‡ºè¡€(è‚ãƒ»è„¾æå‚·)", "æ¶ˆåŒ–ç®¡ç©¿å­”", "è…æå‚·"],
      pelvis: ["éª¨ç›¤éª¨æŠ˜", "è†€èƒ±æå‚·", "å°¿é“æå‚·"],
      limb: ["å¤§è…¿éª¨éª¨æŠ˜", "é–‹æ”¾éª¨æŠ˜", "ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ç—‡å€™ç¾¤", "å››è‚¢åˆ‡æ–­"],
      spine: ["è„Šæ¤ãƒ»è„Šé«„æå‚·"]
    },
    internal: {
      head: ["è„³å‡ºè¡€ãƒ»ãã‚‚è†œä¸‹å‡ºè¡€", "è„³æ¢—å¡", "ã¦ã‚“ã‹ã‚“é‡ç©", "è„³ç‚ãƒ»é«„è†œç‚"],
      chest: ["æ€¥æ€§å† ç—‡å€™ç¾¤(ACS)", "æ€¥æ€§å¿ƒä¸å…¨", "è‡´æ­»çš„ä¸æ•´è„ˆ", "å¤§å‹•è„ˆè§£é›¢", "è‚ºå¡æ “ç—‡", "å¿ƒã‚¿ãƒ³ãƒãƒŠãƒ¼ãƒ‡", "COPDå¢—æ‚ª", "é‡ç—‡å–˜æ¯ç™ºä½œ", "çª’æ¯ãƒ»æ°—é“ç•°ç‰©"],
      abdomen: ["æ¶ˆåŒ–ç®¡å‡ºè¡€", "è…¸é–‰å¡", "æ€¥æ€§è†µç‚", "æ€¥æ€§è…¹è†œç‚"],
      other: ["æ•—è¡€ç—‡æ€§ã‚·ãƒ§ãƒƒã‚¯", "ä½è¡€ç³–æ˜ç¡", "DKA/HHS", "æ€¥æ€§è–¬ç‰©ä¸­æ¯’", "é‡ç—‡è„±æ°´ç—‡", "æ·±éƒ¨ä½“æ¸©ç•°å¸¸"]
    }
  },
  generate: function(trigger, suspicion, riskKey) {
    const risk = this.riskTypes[riskKey] || this.riskTypes['general'];
    return `${trigger}ã§è¦è«‹ã•ã‚Œã€åˆæœŸè©•ä¾¡ã«ã¦${suspicion}ã®å¯èƒ½æ€§ãŒè€ƒãˆã‚‰ã‚ŒãŸãŸã‚ã€${risk.text}`;
  }
};

// è¦è«‹ç†ç”±ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ‡ã‚Šæ›¿ãˆ
let currentTriggerCategory = null;
window.toggleTriggerCategory = function(category) {
  currentTriggerCategory = category;
  const traumaBtn = $('#trigger_trauma_btn');
  const internalBtn = $('#trigger_internal_btn');
  const container = $('#trigger_chips_container');
  
  if(traumaBtn && internalBtn) {
    traumaBtn.classList.remove('active');
    internalBtn.classList.remove('active');
    if(category === 'trauma') {
      traumaBtn.classList.add('active');
    } else {
      internalBtn.classList.add('active');
    }
  }
  
  if(container && MedicalReasonGenerator.triggers[category]) {
    container.innerHTML = '';
    container.style.display = 'block';
    
    const categories = MedicalReasonGenerator.triggers[category];
    const categoryNames = {
      head: 'é ­éƒ¨',
      neck: 'é ¸éƒ¨',
      chest: 'èƒ¸éƒ¨',
      abdomen: 'è…¹éƒ¨',
      pelvis: 'éª¨ç›¤',
      limb: 'å››è‚¢',
      spine: 'è„Šæ¤',
      other: 'ãã®ä»–'
    };
    
    Object.keys(categories).forEach(key => {
      if(categories[key].length > 0) {
        const h4 = document.createElement('h4');
        h4.textContent = categoryNames[key] || key;
        h4.style.marginTop = '12px';
        h4.style.marginBottom = '8px';
        h4.style.fontSize = '14px';
        h4.style.fontWeight = '600';
        container.appendChild(h4);
        
        const chipsDiv = document.createElement('div');
        chipsDiv.className = 'chips';
        categories[key].forEach(item => {
          const chip = document.createElement('button');
          chip.className = 'chip';
          chip.textContent = item;
          chip.onclick = () => {
            $('#inputTrigger').value = item;
            container.style.display = 'none';
            traumaBtn.classList.remove('active');
            internalBtn.classList.remove('active');
            currentTriggerCategory = null;
            updateState();
          };
          chipsDiv.appendChild(chip);
        });
        container.appendChild(chipsDiv);
      }
    });
  }
};

// ç–‘ã„ç—…æ…‹ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ‡ã‚Šæ›¿ãˆ
let currentSuspicionCategory = null;
window.toggleSuspicionCategory = function(category) {
  currentSuspicionCategory = category;
  const traumaBtn = $('#suspicion_trauma_btn');
  const internalBtn = $('#suspicion_internal_btn');
  const container = $('#suspicion_chips_container');
  
  if(traumaBtn && internalBtn) {
    traumaBtn.classList.remove('active');
    internalBtn.classList.remove('active');
    if(category === 'trauma') {
      traumaBtn.classList.add('active');
    } else {
      internalBtn.classList.add('active');
    }
  }
  
  if(container && MedicalReasonGenerator.suspicions[category]) {
    container.innerHTML = '';
    container.style.display = 'block';
    
    const categories = MedicalReasonGenerator.suspicions[category];
    const categoryNames = {
      head: 'é ­éƒ¨',
      neck: 'é ¸éƒ¨',
      chest: 'èƒ¸éƒ¨',
      abdomen: 'è…¹éƒ¨',
      pelvis: 'éª¨ç›¤',
      limb: 'å››è‚¢',
      spine: 'è„Šæ¤',
      other: 'ãã®ä»–'
    };
    
    Object.keys(categories).forEach(key => {
      if(categories[key].length > 0) {
        const h4 = document.createElement('h4');
        h4.textContent = categoryNames[key] || key;
        h4.style.marginTop = '12px';
        h4.style.marginBottom = '8px';
        h4.style.fontSize = '14px';
        h4.style.fontWeight = '600';
        container.appendChild(h4);
        
        const chipsDiv = document.createElement('div');
        chipsDiv.className = 'chips';
        categories[key].forEach(item => {
          const chip = document.createElement('button');
          chip.className = 'chip';
          chip.textContent = item;
          chip.onclick = () => {
            $('#inputSuspicion').value = item;
            container.style.display = 'none';
            traumaBtn.classList.remove('active');
            internalBtn.classList.remove('active');
            currentSuspicionCategory = null;
            updateState();
          };
          chipsDiv.appendChild(chip);
        });
        container.appendChild(chipsDiv);
      }
    });
  }
};

// ç—‡çŠ¶è©³è¨˜ç”Ÿæˆé–¢æ•°
window.updateReason = function() {
  const trigger = $('#inputTrigger')?.value || '';
  const suspicion = $('#inputSuspicion')?.value || '';
  const riskKey = $('#selectRisk')?.value || 'general';
  
  if(!trigger || !suspicion) {
    alert("è¦è«‹ç†ç”±ã¨ç–‘ã„ç—…æ…‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const text = MedicalReasonGenerator.generate(trigger, suspicion, riskKey);
  const outputEl = $('#outputReason');
  if(outputEl) {
    outputEl.value = text;
    state.symptom_detail = text;
    updateState();
  }
};

// æ‰€è¦‹å®šç¾©
const EMS_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”è‰²è‰¯å¥½'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','å†·æ±—','ç™ºç†±']},
  resp: {normal:['å‘¼å¸å®‰å®š','å‘¼å¸è‹¦ãªã—'], abn:['å‘¼å¸å›°é›£','åŠªåŠ›å‘¼å¸','é »å‘¼å¸','èµ·åå‘¼å¸','é™¥æ²¡å‘¼å¸']},
  card: {normal:['è„ˆæ‹æ•´','æœ«æ¢¢æ¸©ã‹ã„'], abn:['è„ˆæ‹ä¸æ•´','é »è„ˆ','å¾è„ˆ','æœ«æ¢¢å†·æ„Ÿ','å†·æ±—']},
  abd: {normal:['è…¹éƒ¨å¹³å¦','åœ§ç—›ãªã—'], abn:['è…¹éƒ¨è†¨æº€','åœ§ç—›','ç­‹æ€§é˜²å¾¡','å˜”å']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','ä¸‹è…¿æµ®è…«','å¤‰å½¢']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”å·¦å³å·®']}
};
const EMS_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²','å‰é¡éƒ¨è¡€è…«','å‰é¡éƒ¨æŒ«å‰µ','å´é ­éƒ¨æ‰“æ’²','å´é ­éƒ¨è¡€è…«','å¾Œé ­éƒ¨æ‰“æ’²','å¾Œé ­éƒ¨æŒ«å‰µ','é¡”é¢æ‰“æ’²','é¡”é¢æŒ«å‰µ','é¡”é¢å¤‰å½¢','çœ¼å‘¨å›²è…«è„¹','é¼»å‡ºè¡€','è€³å‡ºè¡€','å£è…”å†…å‡ºè¡€','æ­¯ç‰™æå‚·']},
  neck: {normal:['å¾Œé ¸éƒ¨åœ§ç—›ãªã—','æ°—ç®¡åä½ãªã—'], abn:['é ¸éƒ¨æ‰“æ’²','é ¸éƒ¨æŒ«å‰µ','å¾Œé ¸éƒ¨åœ§ç—›','é ¸éƒ¨çš®ä¸‹æ°—è…«','é ¸é™è„ˆæ€’å¼µ','æ°—ç®¡åä½']},
  chest: {normal:['å‘¼å¸éŸ³å·¦å³å·®ãªã—'], abn:['èƒ¸å£æ‰“æ’²','èƒ¸å£æŒ«å‰µ','èƒ¸å£åœ§ç—›','èƒ¸éƒ­å¤‰å½¢','å‹•æºèƒ¸éƒ­','èƒ¸å£çš®ä¸‹æ°—è…«','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±']},
  abd: {normal:[], abn:['è…¹å£æ‰“æ’²','è…¹å£æŒ«å‰µ','è…¹éƒ¨åœ§ç—›','è…¹éƒ¨è†¨æº€','ç­‹æ€§é˜²å¾¡','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³','ãƒãƒ³ãƒ‰ãƒ«ç—•']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—'], abn:['éª¨ç›¤åœ§ç—›','éª¨ç›¤å‹•æº','ä¼šé™°éƒ¨å‡ºè¡€','ä¸‹è…¹éƒ¨è†¨æº€']},
  limb: {normal:['æœ«æ¢¢å‹•è„ˆè§¦çŸ¥è‰¯å¥½'], abn:['ä¸Šè‚¢æ‰“æ’²','ä¸Šè‚¢æŒ«å‰µ','ä¸Šè‚¢å¤‰å½¢','ä¸Šè‚¢è…«è„¹','ä¸‹è‚¢æ‰“æ’²','ä¸‹è‚¢æŒ«å‰µ','ä¸‹è‚¢å¤‰å½¢','ä¸‹è‚¢è…«è„¹','é–‹æ”¾å‰µ','æœ«æ¢¢å†·æ„Ÿ','æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯']}
};
const EMS_CPA_GROUPS = {
  rhythm: {normal:[], abn:['Vf','Pulseless VT','PEA','Asystole']},
  witness: {normal:['ç›®æ’ƒã‚ã‚Š','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š'], abn:['ç›®æ’ƒãªã—','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—']},
  airway: {normal:['å£è…”å†…ç•°ç‰©ãªã—','æ°—é“é–‹é€šè‰¯å¥½'], abn:['å£è…”å†…ç•°ç‰©','æ°—é“é–‰å¡','åç‰©','å‡ºè¡€']},
  circulation: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','æ©ˆéª¨å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  chest: {normal:['èƒ¸éƒ­æŒ™ä¸Šè‰¯å¥½','å‘¼å¸éŸ³å·¦å³å·®ãªã—','è…¹éƒ¨è†¨éš†ãªã—'], abn:['èƒ¸éƒ­æŒ™ä¸Šä¸è‰¯','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±','çš®ä¸‹æ°—è…«','è…¹éƒ¨è†¨éš†','ä¸‹è…¿æµ®è…«']}
};
const EMS_STR_GROUPS = {
  conscious: {normal:['æ„è­˜æ¸…æ˜'], abn:['æ„è­˜éšœå®³','JCS 1æ¡','JCS 2æ¡','JCS 3æ¡']},
  face: {normal:['é¡”é¢éº»ç—ºãªã—','æ§‹éŸ³éšœå®³ãªã—'], abn:['é¡”é¢éº»ç—º','æ§‹éŸ³éšœå®³','å‘‚å¾‹éšœå®³']},
  motor: {normal:['ä¸Šè‚¢æŒ™ä¸Šä¿æŒå¯','ä¸‹è‚¢æŒ™ä¸Šä¿æŒå¯'], abn:['ä¸Šè‚¢æŒ™ä¸Šä¸å¯(å³)','ä¸Šè‚¢æŒ™ä¸Šä¸å¯(å·¦)','ä¸‹è‚¢æŒ™ä¸Šä¸å¯(å³)','ä¸‹è‚¢æŒ™ä¸Šä¸å¯(å·¦)','ç‰‡éº»ç—º(å³)','ç‰‡éº»ç—º(å·¦)']},
  other: {normal:[], abn:['ç³å­”ä¸åŒ','å…±åŒåè¦–','é ­ç—›','å˜”å','ã‚ã¾ã„','ç—™æ”£','å¤±èª']}
};
const CARDR_GEN_GROUPS = {
  head: {normal:['æ„è­˜æ¸…æ˜','é¡”é¢è’¼ç™½ãªã—','ãƒã‚¢ãƒãƒ¼ã‚¼ãªã—'], abn:['æ„è­˜éšœå®³','é¡”é¢è’¼ç™½','ãƒã‚¢ãƒãƒ¼ã‚¼','ç™ºç†±']},
  resp: {normal:['å‘¼å¸éŸ³æ¸…','å–˜é³´ãªã—'], abn:['å‘¼å¸å›°é›£','å–˜é³´','æ¹¿æ€§ãƒ©éŸ³','coarse crackles','fine crackles']},
  card: {normal:['å¿ƒéŸ³ç´”','ä¸æ•´ãªã—','ä¸‹è…¿æµ®è…«ãªã—'], abn:['ã‚·ãƒ§ãƒƒã‚¯å…†å€™','å¿ƒé›‘éŸ³','ä¸æ•´è„ˆ','å†·æ±—','ä¸‹è…¿æµ®è…«']},
  abd: {normal:['è…¹éƒ¨å¹³å¦è»Ÿ','åœ§ç—›ãªã—','åè·³ç—›ãªã—'], abn:['è…¹ç—›','åœ§ç—›','åè·³ç—›','ç­‹æ€§é˜²å¾¡','æ¿çŠ¶ç¡¬']},
  limb: {normal:['å››è‚¢å†·æ„Ÿãªã—','æµ®è…«ãªã—'], abn:['å››è‚¢å†·æ„Ÿ','æµ®è…«','å¤‰å½¢','æœ«æ¢¢å¾ªç’°ä¸å…¨']},
  neuro: {normal:['éº»ç—ºãªã—','ç—™æ”£ãªã—'], abn:['ç‰‡éº»ç—º','ç—™æ”£','ç³å­”ä¸åŒ','å¯¾å…‰åå°„ç•°å¸¸']}
};
const CARDR_TRA_GROUPS = {
  head: {normal:[], abn:['å‰é¡éƒ¨æ‰“æ’²è¡€è…«','å´é ­éƒ¨æ‰“æ’²è¡€è…«','å¾Œé ­éƒ¨æŒ«å‰µ','é ­çš®è£‚å‚·','é¡”é¢æŒ«å‰µ','é¡”é¢è…«è„¹','ãƒ‘ãƒ³ãƒ€ã®ç›®å¾´å€™','ãƒãƒˆãƒ«ã‚µã‚¤ãƒ³','é¼»æ ¹éƒ¨è…«è„¹','å³é ¬éƒ¨å¤‰å½¢è…«è„¹','å·¦é ¬éƒ¨å¤‰å½¢è…«è„¹','é¼»å‡ºè¡€','è€³å‡ºè¡€','é«„æ¶²è€³æ¼','é«„æ¶²é¼»æ¼','å£è…”å†…å‡ºè¡€','æ­¯ç‰™æå‚·','çµè†œå‡ºè¡€','è§’è†œæå‚·','çœ¼çƒåä½','è¤‡è¦–']},
  neck: {normal:['æ°—ç®¡æ­£ä¸­','é ¸éƒ¨çš®ä¸‹æ°—è…«ãªã—','é ¸é™è„ˆæ€’å¼µãªã—','å¾Œé ¸éƒ¨åœ§ç—›ãªã—'], abn:['æ°—ç®¡åä½','é ¸éƒ¨çš®ä¸‹æ°—è…«','é ¸é™è„ˆæ€’å¼µ','å¾Œé ¸éƒ¨åœ§ç—›','é ¸éƒ¨æ‰“æ’²','é ¸éƒ¨æŒ«å‰µ','é ¸éƒ¨è¡€è…«']},
  chest: {normal:['èƒ¸éƒ­å¯¾ç§°','å‘¼å¸éŸ³æ¸…å·¦å³å·®ãªã—','å¿ƒéŸ³æ•´'], abn:['èƒ¸éƒ­å¤‰å½¢','å‹•æºèƒ¸éƒ­','èƒ¸å£æ‰“æ’²','èƒ¸å£æŒ«å‰µ','èƒ¸å£åœ§ç—›','èƒ¸å£çš®ä¸‹æ°—è…«','å³å‘¼å¸éŸ³æ¸›å¼±','å·¦å‘¼å¸éŸ³æ¸›å¼±','å³å‘¼å¸éŸ³æ¶ˆå¤±','å·¦å‘¼å¸éŸ³æ¶ˆå¤±','å¿ƒéŸ³æ¸›å¼±']},
  abd: {normal:['è…¹éƒ¨å¹³å¦è»Ÿ'], abn:['è…¹å£æ‰“æ’²','è…¹å£æŒ«å‰µ','ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚µã‚¤ãƒ³','ãƒãƒ³ãƒ‰ãƒ«ç—•','è…¹éƒ¨åœ§ç—›','å³ä¸Šè…¹éƒ¨åœ§ç—›','å·¦ä¸Šè…¹éƒ¨åœ§ç—›','ä¸‹è…¹éƒ¨åœ§ç—›','ç­‹æ€§é˜²å¾¡','åè·³ç—›','è…¹éƒ¨è†¨æº€','è…¸è •å‹•éŸ³æ¸›å¼±']},
  pelvis: {normal:['éª¨ç›¤å‹•æºãªã—','ç›´è…¸è¨ºç•°å¸¸ãªã—'], abn:['éª¨ç›¤å‹•æº','éª¨ç›¤åœ§ç—›','æ¥éª¨åœ§ç—›','ä¼šé™°éƒ¨å‡ºè¡€','å°¿é“å‡ºè¡€']},
  limb: {normal:['æœ«æ¢¢å‹•è„ˆè§¦çŸ¥è‰¯å¥½'], abn:['å³ä¸Šè‚¢æ‰“æ’²','å³ä¸Šè‚¢æŒ«å‰µ','å³ä¸Šè‚¢å¤‰å½¢','å³ä¸Šè‚¢è…«è„¹','å·¦ä¸Šè‚¢æ‰“æ’²','å·¦ä¸Šè‚¢æŒ«å‰µ','å·¦ä¸Šè‚¢å¤‰å½¢','å·¦ä¸Šè‚¢è…«è„¹','å³ä¸‹è‚¢æ‰“æ’²','å³ä¸‹è‚¢æŒ«å‰µ','å³ä¸‹è‚¢å¤‰å½¢','å³ä¸‹è‚¢è…«è„¹','å·¦ä¸‹è‚¢æ‰“æ’²','å·¦ä¸‹è‚¢æŒ«å‰µ','å·¦ä¸‹è‚¢å¤‰å½¢','å·¦ä¸‹è‚¢è…«è„¹','é–‹æ”¾å‰µ','éª¨éœ²å‡º','æœ«æ¢¢å‹•è„ˆè§¦çŸ¥ä¸è‰¯','æœ«æ¢¢å†·æ„Ÿ','CRTå»¶é•·']}
};
const CARDR_STR_GROUPS = {
  cn: {normal:[], abn:['è¦–åŠ›ä½ä¸‹','è¦–é‡æ¬ æ','è¤‡è¦–','çœ¼ç¼ä¸‹å‚','é¡”é¢éº»ç—º','é¡”é¢æ„Ÿè¦šä½ä¸‹','è´åŠ›ä½ä¸‹','ã‚ã¾ã„','æ§‹éŸ³éšœå®³','åš¥ä¸‹éšœå®³','èˆŒåä½','ã‚«ãƒ¼ãƒ†ãƒ³å¾´å€™']},
  higher: {normal:[], abn:['å¤±èª','é‹å‹•æ€§å¤±èª','æ„Ÿè¦šæ€§å¤±èª','æ§‹éŸ³éšœå®³','å¤±è¡Œ','å¤±èª','åŠå´ç©ºé–“ç„¡è¦–','æ³¨æ„éšœå®³','è¦‹å½“è­˜éšœå®³','å°è„³å¤±èª¿','æŒ‡é¼»è©¦é¨“ç•°å¸¸','è¸µè†è©¦é¨“ç•°å¸¸']}
};
const CARDR_CPA_GROUPS = {
  rhythm: ['Vf','Pulseless VT','PEA','Asystole'],
  witness: ['ç›®æ’ƒã‚ã‚Š','ç›®æ’ƒãªã—','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š','ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—'],
  body: {normal:[], abn:['å¿ƒåœæ­¢','å‘¼å¸åœæ­¢','ãƒã‚¢ãƒãƒ¼ã‚¼','å››è‚¢å†·æ„Ÿ','çš®è†šè’¼ç™½','æ­»æ–‘','æ­»å¾Œç¡¬ç›´']},
  head: {normal:[], abn:['é ¸å‹•è„ˆè§¦çŸ¥ä¸å¯','å¯¾å…‰åå°„æ¶ˆå¤±','ç³å­”æ•£å¤§å›ºå®š']},
  trunk: {normal:[], abn:['å¿ƒéŸ³è´å–ä¸å¯','å‘¼å¸éŸ³è´å–ä¸å¯','è…¹éƒ¨è†¨éš†']}
};

// çŠ¶æ…‹
let state = {
  request: {type:'', detail:'', age:'', sex:'', ems_team:'', content:''},
  patient: {history:'', medication:'', allergy:'', lastWell:'', lastMeal:'', hospital:'', history_chips:{}, anticoagulant:'', anticoagulant_drugs:[], antiplatelet:'', antiplatelet_drugs:[], food_allergy:'', drug_allergy:''},
  car: {request_time:'', departure:'', scene_arrival:'', cardr_contact:'', activity_place:'', scene_departure:'', hospital_arrival:'', transport_method:'Uã‚¿ãƒ¼ãƒ³'},
  ems: {
    aware:'', arrival:'', contact:'', pickup:'', departure:'', rp:'',
    vitals: [],
    exam_tab: 'general',
    chips: {},
    memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{memo:''},cpa:{memo:''}},
    stroke_onset: '',
    procedures: {},
    procedures_items: ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ãƒ–ãƒ‰ã‚¦ç³–æŠ•ä¸','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'],
    o2_flow:'', procedures_detail:''
  },
  cardr: {
    vitals: [],
    exam_tab: 'general',
    chips: {},
    memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{neuro:'',motor:'',eye:'',higher:''},cpa:{body:'',head:'',trunk:''}},
    exams: {bs:false, ucg:false, us_abd:false, us_lung:false, us_neck:false, ecg:false, fast:false, efast:false},
    exam_texts: {ucg:'', us_abd:'', us_lung:'', us_neck:'', ecg:'', fast:'', efast:''},
    bs:120, abg_type:'', abg_data: [], exam_detail:'',
    cpaEvents: [],
    stroke: {
      pupilL:3.0, pupilR:3.0, plrL:'', plrR:'', gaze:'', nyst:'', 
      mmt:{ru:5, lu:5, rl:5, ll:5},
      btr:'', ptr:'', babinski:false, chaddock:false,
      nihss:{}, nihssMemo:''
    },
    procedures: {},
    procedures_items: ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'],
    procedure_detail:'',
    drugs: {},
    // è–¬å‰¤ãƒã‚¹ã‚¿ã‚’æ›´æ–°
    drugs_items: ['ç”Ÿé£Ÿ','ã‚½ãƒ«ã‚¢ã‚»ãƒˆF','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ­ã‚¯ãƒ­ãƒ‹ã‚¦ãƒ ','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹','ãƒ–ãƒ‰ã‚¦ç³–æ¶²'],
    drug_detail:'',
    intubation: {time: '', size: '7.0'},
    // è–¬å‰¤æŠ•ä¸ã®è©³ç´°æƒ…å ±ã‚’æ ¼ç´ã€‚ã‚­ãƒ¼ã¯è–¬å‰¤åã€‚å€¤ã¯ {time: 'HH:mm', amount: 'X.X'} ã®é…åˆ—ã€‚
    drug_details: {}
  },
  problems: [],
  consideration: '',
  triage: null,
  severity: null,
  symptom_detail: '',
  destination: {hospital:'', custom:'', reason:''},
  hospitals: {
    'é¹¿å…å³¶å¸‚': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','å—é¢¨ç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢']
  }
};

// ãƒ€ã‚¤ãƒ¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ (ãƒ˜ãƒª v3.3ã‹ã‚‰ç§»æ¤)
let dialCallback = null;
let dialWheels = [];

let scrollPosition = 0;

function openDial(title, wheels, callback) {
  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
  scrollPosition = window.pageYOffset;
  document.body.classList.add('dial-open');
  document.body.style.top = `-${scrollPosition}px`;
  
  dialCallback = callback;
  dialWheels = wheels;
  $('#dialTitle').textContent = title;
  const body = $('#dialBody');
  body.innerHTML = '';
  
  wheels.forEach((w, wi) => {
    const wheel = document.createElement('div');
    wheel.className = 'dial-wheel';
    wheel.innerHTML = '<div class="dial-highlight"></div>';
    
    const scroll = document.createElement('div');
    scroll.className = 'dial-scroll';
    scroll.dataset.wheelIndex = wi;
    
    w.options.forEach((opt, oi) => {
      const div = document.createElement('div');
      div.className = 'dial-option';
      // ãƒ©ãƒ™ãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°valueã‚’ãã®ã¾ã¾ä½¿ç”¨
      div.textContent = opt.label !== undefined ? opt.label : opt.value;
      div.dataset.value = opt.value;
      div.dataset.index = oi;
      if(String(opt.value) === String(w.selected)) div.classList.add('selected');
      scroll.appendChild(div);
    });
    
    wheel.appendChild(scroll);
    body.appendChild(wheel);
    
    if(w.unit) {
      const unit = document.createElement('div');
      unit.className = 'dial-unit';
      unit.textContent = w.unit;
      body.appendChild(unit);
    }
    
    // ç¾åœ¨ã®é¸æŠä½ç½®ã‚’è¨˜æ†¶
    let currentIndex = w.options.findIndex(o => String(o.value) === String(w.selected));
    if(currentIndex < 0) {
        currentIndex = 0; // è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã¯ä¸€ç•ªä¸Š
        if (w.options.length > 0) w.selected = w.options[0].value;
    }
    
    // ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆåŠ é€Ÿåº¦ä»˜ãï¼‰
    let startY = 0, lastY = 0, lastTime = 0;
    let currentOffset = -currentIndex * 40;
    let velocityY = 0;
    let animationId = null;
    
    const stopAnimation = () => {
      if(animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    };
    
    const snapToNearest = () => {
      const optionHeight = 40;
      let newIndex = Math.round(-currentOffset / optionHeight);
      newIndex = Math.max(0, Math.min(w.options.length - 1, newIndex));
      
      currentOffset = -newIndex * optionHeight;
      currentIndex = newIndex;
      if (w.options[newIndex]) w.selected = w.options[newIndex].value; // é¸æŠå€¤ã‚’æ›´æ–°
      
      scroll.style.transition = 'transform 0.2s ease-out';
      scroll.style.transform = `translateY(${currentOffset}px)`;
      updateDialSelection(scroll, newIndex);
    };
    
    const momentumScroll = () => {
      const friction = 0.92;
      const minVelocity = 0.5;
      
      velocityY *= friction;
      currentOffset += velocityY;
      
      const maxOffset = 0;
      const minOffset = -(w.options.length - 1) * 40;
      
      if(currentOffset > maxOffset) {
        currentOffset = maxOffset;
        velocityY = 0;
      } else if(currentOffset < minOffset) {
        currentOffset = minOffset;
        velocityY = 0;
      }
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      if(Math.abs(velocityY) > minVelocity) {
        animationId = requestAnimationFrame(momentumScroll);
      } else {
        snapToNearest();
      }
    };
    
    scroll.addEventListener('touchstart', e => {
      e.preventDefault();
      stopAnimation();
      scroll.style.transition = 'none';
      startY = e.touches[0].clientY;
      lastY = startY;
      lastTime = Date.now();
      velocityY = 0;
    }, {passive: false});
    
    scroll.addEventListener('touchmove', e => {
      e.preventDefault();
      const y = e.touches[0].clientY;
      const dy = y - lastY;
      
      const acceleration = 1.5;
      currentOffset += dy * acceleration;
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      const now = Date.now();
      const dt = now - lastTime;
      if(dt > 0) {
        velocityY = (dy * acceleration) / dt * 16;
      }
      
      lastY = y;
      lastTime = now;
    }, {passive: false});
    
    scroll.addEventListener('touchend', e => {
      e.preventDefault();
      
      if(Math.abs(velocityY) > 2) {
        animationId = requestAnimationFrame(momentumScroll);
      } else {
        snapToNearest();
      }
    }, {passive: false});
    
    // ãƒã‚¦ã‚¹æ“ä½œå¯¾å¿œ
    let isMouseDown = false;
    
    scroll.addEventListener('mousedown', e => {
      e.preventDefault();
      isMouseDown = true;
      stopAnimation();
      scroll.style.transition = 'none';
      startY = e.clientY;
      lastY = startY;
      lastTime = Date.now();
      velocityY = 0;
    });
    
    document.addEventListener('mousemove', e => {
      if(!isMouseDown) return;
      e.preventDefault();
      const y = e.clientY;
      const dy = y - lastY;
      
      const acceleration = 1.5;
      currentOffset += dy * acceleration;
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      const now = Date.now();
      const dt = now - lastTime;
      if(dt > 0) {
        velocityY = (dy * acceleration) / dt * 16;
      }
      
      lastY = y;
      lastTime = now;
    });
    
    document.addEventListener('mouseup', e => {
      if(!isMouseDown) return;
      isMouseDown = false;
      
      if(Math.abs(velocityY) > 2) {
        animationId = requestAnimationFrame(momentumScroll);
      } else {
        snapToNearest();
      }
    });
    
    // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«å¯¾å¿œ
    wheel.addEventListener('wheel', e => {
      e.preventDefault();
      stopAnimation();
      scroll.style.transition = 'none';
      
      currentOffset -= e.deltaY * 0.5;
      
      const maxOffset = 0;
      const minOffset = -(w.options.length - 1) * 40;
      currentOffset = Math.max(minOffset, Math.min(maxOffset, currentOffset));
      
      scroll.style.transform = `translateY(${currentOffset}px)`;
      
      clearTimeout(wheel.snapTimeout);
      wheel.snapTimeout = setTimeout(snapToNearest, 150);
    }, {passive: false});
    
    // ã‚¯ãƒªãƒƒã‚¯ã§ç›´æ¥é¸æŠï¼†è‡ªå‹•æ±ºå®š
    scroll.querySelectorAll('.dial-option').forEach((opt, oi) => {
      opt.addEventListener('click', e => {
        e.stopPropagation();
        currentIndex = oi;
        currentOffset = -oi * 40;
        w.selected = w.options[oi].value;
        scroll.style.transition = 'transform 0.2s ease-out';
        scroll.style.transform = `translateY(${currentOffset}px)`;
        updateDialSelection(scroll, oi);
        
        // å˜ä¸€ãƒ›ã‚¤ãƒ¼ãƒ«ã®å ´åˆã¯å³ç¢ºå®š
        if(dialWheels.length === 1) {
          setTimeout(confirmDial, 200);
        }
      });
    });
    
    // åˆæœŸä½ç½®è¨­å®šï¼ˆé¸æŠå€¤ã‚’ä¸­å¤®ã«ï¼‰
    scroll.style.transform = `translateY(${currentOffset}px)`;
    updateDialSelection(scroll, currentIndex);
  });
  
  $('#dialOverlay').classList.add('show');
  
  // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…¨ä½“ã®ã‚¿ãƒƒãƒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
  $('#dialOverlay').ontouchmove = e => e.preventDefault();
}

function updateDialSelection(scroll, index) {
  scroll.querySelectorAll('.dial-option').forEach((o, i) => {
    o.classList.toggle('selected', i === index);
  });
  const wi = parseInt(scroll.dataset.wheelIndex);
  // w.options[index]ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
  if (dialWheels[wi] && dialWheels[wi].options[index]) {
    dialWheels[wi].selected = dialWheels[wi].options[index].value;
  }
}

function closeDial(e) {
  if(e && e.target !== $('#dialOverlay')) return;
  $('#dialOverlay').classList.remove('show');
  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ
  document.body.classList.remove('dial-open');
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
  window.scrollTo(0, scrollPosition); 
}

function confirmDial() {
  if(dialCallback) {
    const values = dialWheels.map(w => w.selected);
    dialCallback(values);
  }
  $('#dialOverlay').classList.remove('show');
  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾©å…ƒ
  document.body.classList.remove('dial-open');
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
  window.scrollTo(0, scrollPosition); 
}

// å…±é€šãƒ¬ãƒ³ã‚¸ç”Ÿæˆ
function genRange(from, to, step) {
  const arr = [];
  for(let i = from; i <= to; i = parseFloat((i + step).toFixed(2))) { // æµ®å‹•å°æ•°ç‚¹èª¤å·®å¯¾ç­–
    const value = parseFloat(i.toFixed(2));
    arr.push({label: String(value), value: value});
  }
  return arr;
}

// ãƒã‚¤ã‚¿ãƒ«ç”¨ãƒ€ã‚¤ãƒ¤ãƒ«
window.openVitalDial = (type, idx, field) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const v = state[type].vitals[idx];
  let wheels = [];
  let title = '';
  
  switch(field) {
    case 'bp':
      title = 'è¡€åœ§';
      wheels = [
        {options: genRange(0, 250, 1), selected: v.sbp, unit: '/'},
        {options: genRange(0, 150, 1), selected: v.dbp, unit: 'mmHg'}
      ];
      break;
    case 'hr':
      title = 'å¿ƒæ‹æ•°';
      wheels = [{options: genRange(0, 250, 1), selected: v.hr, unit: 'bpm'}];
      break;
    case 'rr':
      title = 'å‘¼å¸æ•°';
      wheels = [{options: genRange(0, 45, 1), selected: v.rr, unit: '/min'}];
      break;
    case 'spo2':
      title = 'SpOâ‚‚';
      wheels = [{options: genRange(40, 100, 1), selected: v.spo2, unit: '%'}];
      break;
    case 'bt':
      title = 'ä½“æ¸©';
      wheels = [{options: genRangeBT(), selected: v.bt, unit: 'â„ƒ'}];
      break;
    case 'gcs_e':
      title = 'GCS - E';
      wheels = [{options: [{label:'1',value:1},{label:'2',value:2},{label:'3',value:3},{label:'4',value:4}], selected: v.gcs.e}];
      break;
    case 'gcs_v':
      title = 'GCS - V';
      wheels = [{options: [{label:'1',value:1},{label:'2',value:2},{label:'3',value:3},{label:'4',value:4},{label:'5',value:5},{label:'T',value:'T'}], selected: v.gcs.v}];
      break;
    case 'gcs_m':
      title = 'GCS - M';
      wheels = [{options: [{label:'1',value:1},{label:'2',value:2},{label:'3',value:3},{label:'4',value:4},{label:'5',value:5},{label:'6',value:6}], selected: v.gcs.m}];
      break;
    case 'jcs':
      title = 'JCS';
      wheels = [{options: [
        {label:'0 (æ¸…æ˜)',value:'0'},{label:'I-1',value:'1'},{label:'I-2',value:'2'},{label:'I-3',value:'3'},
        {label:'II-10',value:'10'},{label:'II-20',value:'20'},{label:'II-30',value:'30'},
        {label:'III-100',value:'100'},{label:'III-200',value:'200'},{label:'III-300',value:'300'}
      ], selected: v.jcs}];
      break;
  }
  
  openDial(title, wheels, vals => {
    switch(field) {
      case 'bp': v.sbp = vals[0]; v.dbp = vals[1]; break;
      case 'hr': v.hr = vals[0]; break;
      case 'rr': v.rr = vals[0]; break;
      case 'spo2': v.spo2 = vals[0]; break;
      case 'bt': v.bt = vals[0]; break;
      case 'gcs_e': v.gcs.e = vals[0]; break;
      case 'gcs_v': v.gcs.v = vals[0]; break;
      case 'gcs_m': v.gcs.m = vals[0]; break;
      case 'jcs': v.jcs = vals[0]; break;
    }
    if(type === 'ems') renderEmsVitals();
    else renderCarDrVitals();
    updateState();
  });
};

function genRangeBT() {
  const arr = [];
  for(let i = 32.0; i <= 42.0; i += 0.1) {
    arr.push({label: i.toFixed(1), value: parseFloat(i.toFixed(1))});
  }
  return arr;
}

// è¡€ç³–å€¤ãƒ€ã‚¤ãƒ¤ãƒ«
window.openBsDial = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const currentBs = state.cardr.bs || 120;
  const wheels = [{options: genRange(0, 600, 1), selected: currentBs, unit: 'mg/dL'}];
  
  openDial('è¡€ç³–å€¤', wheels, vals => {
    state.cardr.bs = vals[0];
    $('#cardr_bs').value = vals[0];
    $('#cardr_bs_display').textContent = vals[0];
    updateState();
  });
};

// CPA ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
window.addCpaEvent = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  const newEvent = {
    arrestTime: time,
    rhythm: 'Asystole',
    witnessed: false,
    bystander: false,
    cprStart: '',
    ivTime: '',
    adrenalineTimes: [],
    lt: false,
    intubation: false,
    intubationTime: '',
    pericardio: false,
    pericardioTime: '',
    roscTime: '',
    memo: ''
  };
  
  state.cardr.cpaEvents.push(newEvent);
  renderCpaEvents();
  updateState();
};

window.deleteCpaEvent = (idx) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if(confirm('ã“ã®å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
    state.cardr.cpaEvents.splice(idx, 1);
    renderCpaEvents();
    updateState();
  }
};

function renderCpaEvents() {
  const container = $('#cpa_events_container');
  if(!container) return;
  container.innerHTML = '';
  
  if(state.cardr.cpaEvents.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    return;
  }
  
  state.cardr.cpaEvents.forEach((event, idx) => {
    const card = document.createElement('div');
    card.className = 'vital-card';
    card.style.marginBottom = '12px';
    
    // ã‚¤ãƒ™ãƒ³ãƒˆ1ï¼ˆåˆå›å¿ƒåœæ­¢ï¼‰ã®å ´åˆ
    if(idx === 0) {
      card.innerHTML = `
      <div class="vital-header">
        <div style="font-weight:600">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}${event.roscTime ? ' (ROSC)' : ''}</div>
        <button class="vital-del" onclick="deleteCpaEvent(${idx})">å‰Šé™¤</button>
      </div>
      <div style="padding:12px">
        <div class="grid2" style="margin-bottom:12px">
          <div>
            <label>å¿ƒåœæ­¢æ™‚åˆ»</label>
            <div class="time-row">
              <input type="time" value="${event.arrestTime}" onchange="updateCpaEventField(${idx}, 'arrestTime', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'arrestTime')">Now</button>
            </div>
          </div>
          <div>
            <label>åˆæœŸæ³¢å½¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;text-align:center" onclick="openCpaRhythmDial(${idx})">
              <div class="vital-value" style="font-size:16px">${event.rhythm}</div>
            </div>
          </div>
        </div>
        
        <div class="grid2" style="margin-top:12px">
          <div class="toggle-btn ${event.witnessed ? 'active' : ''}" onclick="toggleCpaField(${idx}, 'witnessed')">
            ${event.witnessed ? 'ç›®æ’ƒã‚ã‚Š' : 'ç›®æ’ƒãªã—'}
          </div>
          <div class="toggle-btn ${event.bystander ? 'active' : ''}" onclick="toggleCpaField(${idx}, 'bystander')">
            ${event.bystander ? 'ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRã‚ã‚Š' : 'ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRãªã—'}
          </div>
        </div>
        
        <h3 style="margin-top:12px">è˜‡ç”Ÿå‡¦ç½®</h3>
        <div class="grid2">
          <div>
            <label>èƒ¸éª¨åœ§è¿«é–‹å§‹</label>
            <div class="time-row">
              <input type="time" value="${event.cprStart}" onchange="updateCpaEventField(${idx}, 'cprStart', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'cprStart')">Now</button>
            </div>
          </div>
          <div>
            <label>æœ«æ¢¢ç¢ºä¿</label>
            <div class="time-row">
              <input type="time" value="${event.ivTime}" onchange="updateCpaEventField(${idx}, 'ivTime', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'ivTime')">Now</button>
            </div>
          </div>
        </div>
        
        <h3 style="margin-top:12px">ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸</h3>
        <div id="adrenaline_times_${idx}"></div>
        <button class="btn small" style="margin-top:8px" onclick="addAdrenalineTime(${idx})">ï¼‹ ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³è¿½åŠ </button>
        
        <h3 style="margin-top:12px">æ°—é“ç¢ºä¿</h3>
        <div class="checkline">
          <label class="check-toggle ${event.lt ? 'active' : ''}" data-event-index="${idx}" data-target="lt">
            <input type="checkbox" id="cpa_lt_check_${idx}" ${event.lt ? 'checked' : ''} onchange="updateCpaEventField(${idx}, 'lt', this.checked); toggleCheckState(this)"> LTæŒ¿å…¥
          </label>
        </div>
        <div class="checkline">
          <label class="check-toggle ${event.intubation ? 'active' : ''}" data-event-index="${idx}" data-target="intubation">
            <input type="checkbox" id="cpa_intubation_check_${idx}" ${event.intubation ? 'checked' : ''} onchange="toggleCpaIntubation(this)"> æ°—ç®¡æŒ¿ç®¡
          </label>
        </div>
        <div id="cpa_intubation_time_area_${idx}" style="${event.intubation ? '' : 'display:none'};margin-top:8px">
          <div class="time-row">
            <input type="time" value="${event.intubationTime}" onchange="updateCpaEventField(${idx}, 'intubationTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'intubationTime')">Now</button>
          </div>
        </div>
        
        <h3 style="margin-top:12px">ãã®ä»–å‡¦ç½®</h3>
        <div class="checkline">
          <label class="check-toggle ${event.pericardio ? 'active' : ''}" data-event-index="${idx}" data-target="pericardio">
            <input type="checkbox" id="cpa_pericardio_check_${idx}" ${event.pericardio ? 'checked' : ''} onchange="toggleCpaPericardio(this)"> å¿ƒè†œè…”ç©¿åˆº
          </label>
        </div>
        <div id="cpa_pericardio_time_area_${idx}" style="${event.pericardio ? '' : 'display:none'};margin-top:8px">
          <div class="time-row">
            <input type="time" value="${event.pericardioTime}" onchange="updateCpaEventField(${idx}, 'pericardioTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'pericardioTime')">Now</button>
          </div>
        </div>
        
        <h3 style="margin-top:12px">è»¢å¸°</h3>
        <div>
          <label>å¿ƒæ‹å†é–‹(ROSC)æ™‚åˆ»</label>
          <div class="time-row">
            <input type="time" value="${event.roscTime}" onchange="updateCpaEventField(${idx}, 'roscTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'roscTime')">Now</button>
          </div>
        </div>
        
        <div id="flow_times_${idx}" style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:10px;border:1px solid #0ea5e9">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <span style="font-weight:600;color:#0369a1">No Flow Time</span>
            <span id="no_flow_time_${idx}" style="font-weight:600;color:#0369a1">-- åˆ†</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span style="font-weight:600;color:#0369a1">Low Flow Time</span>
            <span id="low_flow_time_${idx}" style="font-weight:600;color:#0369a1">-- åˆ†</span>
          </div>
        </div>
        
        <label style="margin-top:12px">ãƒ¡ãƒ¢</label>
        <textarea class="memo" placeholder="ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢" onchange="updateCpaEventField(${idx}, 'memo', this.value)">${event.memo}</textarea>
      </div>
    `;
    } else {
      // ã‚¤ãƒ™ãƒ³ãƒˆ2ä»¥é™ï¼ˆå†å¿ƒåœæ­¢ï¼‰ã®å ´åˆ
      card.innerHTML = `
      <div class="vital-header">
        <div style="font-weight:600">å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}ï¼ˆå†å¿ƒåœæ­¢ï¼‰${event.roscTime ? ' (ROSC)' : ''}</div>
        <button class="vital-del" onclick="deleteCpaEvent(${idx})">å‰Šé™¤</button>
      </div>
      <div style="padding:12px">
        <div class="grid2" style="margin-bottom:12px">
          <div>
            <label>å¿ƒåœæ­¢æ™‚åˆ»</label>
            <div class="time-row">
              <input type="time" value="${event.arrestTime}" onchange="updateCpaEventField(${idx}, 'arrestTime', this.value)">
              <button class="time-btn" onclick="setCpaEventNow(${idx}, 'arrestTime')">Now</button>
            </div>
          </div>
          <div>
            <label>æ³¢å½¢</label>
            <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer;text-align:center" onclick="openCpaRhythmDial(${idx})">
              <div class="vital-value" style="font-size:16px">${event.rhythm}</div>
            </div>
          </div>
        </div>
        
        <h3 style="margin-top:12px">ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸</h3>
        <div id="adrenaline_times_${idx}"></div>
        <button class="btn small" style="margin-top:8px" onclick="addAdrenalineTime(${idx})">ï¼‹ ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³è¿½åŠ </button>
        
        <h3 style="margin-top:12px">è»¢å¸°</h3>
        <div>
          <label>å¿ƒæ‹å†é–‹(ROSC)æ™‚åˆ»</label>
          <div class="time-row">
            <input type="time" value="${event.roscTime}" onchange="updateCpaEventField(${idx}, 'roscTime', this.value)">
            <button class="time-btn" onclick="setCpaEventNow(${idx}, 'roscTime')">Now</button>
          </div>
        </div>
        
        <div id="flow_times_${idx}" style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:10px;border:1px solid #0ea5e9">
          <div style="display:flex;justify-content:space-between">
            <span style="font-weight:600;color:#0369a1">Low Flow Time</span>
            <span id="low_flow_time_${idx}" style="font-weight:600;color:#0369a1">-- åˆ†</span>
          </div>
        </div>
        
        <label style="margin-top:12px">ãƒ¡ãƒ¢</label>
        <textarea class="memo" placeholder="ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢" onchange="updateCpaEventField(${idx}, 'memo', this.value)">${event.memo}</textarea>
      </div>
    `;
    }
    
    container.appendChild(card);
    renderAdrenalineTimes(idx);
    calcFlowTimes(idx);
  });
}

function updateCpaEventField(idx, field, value) {
  if (state.cardr.cpaEvents[idx]) {
    state.cardr.cpaEvents[idx][field] = value;
    if(field === 'arrestTime' || field === 'cprStart' || field === 'roscTime') {
      calcFlowTimes(idx);
    }
    updateState();
  }
}

window.toggleCpaField = (idx, field) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if (state.cardr.cpaEvents[idx]) {
    state.cardr.cpaEvents[idx][field] = !state.cardr.cpaEvents[idx][field];
    renderCpaEvents();
    updateState();
  }
};

window.toggleCheckState = (checkbox) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const label = checkbox.closest('.check-toggle');
  label.classList.toggle('active', checkbox.checked);
  
  // LTæŒ¿å…¥ã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆçŠ¶æ…‹ã‚‚æ›´æ–°
  if(label.dataset.target === 'lt') {
    const idx = parseInt(label.dataset.eventIndex);
    if (state.cardr.cpaEvents[idx]) {
      state.cardr.cpaEvents[idx].lt = checkbox.checked;
      updateState();
    }
  }
};


window.setCpaEventNow = (idx, field) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  if (state.cardr.cpaEvents[idx]) {
    state.cardr.cpaEvents[idx][field] = time;
    renderCpaEvents();
    updateState();
  }
};

window.openCpaRhythmDial = (idx) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const rhythms = ['Asystole', 'PEA', 'Vf', 'Pulseless VT'];
  const current = state.cardr.cpaEvents[idx]?.rhythm;
  const options = rhythms.map(r => ({label: r, value: r}));
  const wheels = [{options, selected: current}];
  
  openDial(`åˆæœŸæ³¢å½¢`, wheels, vals => {
    if (state.cardr.cpaEvents[idx]) {
      state.cardr.cpaEvents[idx].rhythm = vals[0];
      renderCpaEvents();
      updateState();
    }
  });
};

window.toggleCpaIntubation = (checkbox) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const label = checkbox.closest('.check-toggle');
  label.classList.toggle('active', checkbox.checked);
  
  const idx = parseInt(label.dataset.eventIndex);
  if (state.cardr.cpaEvents[idx]) {
    state.cardr.cpaEvents[idx].intubation = checkbox.checked;
    
    const timeArea = $(`#cpa_intubation_time_area_${idx}`);
    if(timeArea) {
      timeArea.style.display = checkbox.checked ? 'block' : 'none';
    }
    updateState();
  }
};

window.toggleCpaPericardio = (checkbox) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const label = checkbox.closest('.check-toggle');
  label.classList.toggle('active', checkbox.checked);
  
  const idx = parseInt(label.dataset.eventIndex);
  if (state.cardr.cpaEvents[idx]) {
    state.cardr.cpaEvents[idx].pericardio = checkbox.checked;
    
    const timeArea = $(`#cpa_pericardio_time_area_${idx}`);
    if(timeArea) {
      timeArea.style.display = checkbox.checked ? 'block' : 'none';
    }
    updateState();
  }
};

window.addAdrenalineTime = (idx) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if(!state.cardr.cpaEvents[idx]) return;

  if(!state.cardr.cpaEvents[idx].adrenalineTimes) state.cardr.cpaEvents[idx].adrenalineTimes = [];
  
  let newTime;
  if(state.cardr.cpaEvents[idx].adrenalineTimes.length === 0) {
    const now = new Date();
    newTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  } else {
    const lastTime = state.cardr.cpaEvents[idx].adrenalineTimes[state.cardr.cpaEvents[idx].adrenalineTimes.length - 1];
    // æœ€æ–°æ™‚åˆ»ã®1åˆ†å¾Œã‚’é–‹å§‹æ™‚åˆ»ã¨ã™ã‚‹ (4åˆ†ãƒ«ãƒ¼ãƒ«ã¯æ‰‹å‹•èª¿æ•´ã‚’æ¨å¥¨)
    newTime = addMinutesToTime(lastTime, 1);
  }
  
  state.cardr.cpaEvents[idx].adrenalineTimes.push(newTime);
  renderAdrenalineTimes(idx);
  updateState();
};

function addMinutesToTime(timeStr, minutes) {
  const [h, m] = timeStr.split(':').map(Number);
  const totalMinutes = h * 60 + m + minutes;
  const newH = Math.floor(totalMinutes / 60) % 24;
  const newM = totalMinutes % 60;
  return `${String(newH).padStart(2,'0')}:${String(newM).padStart(2,'0')}`;
}

window.removeAdrenalineTime = (idx, adrIdx) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if (state.cardr.cpaEvents[idx]?.adrenalineTimes) {
    state.cardr.cpaEvents[idx].adrenalineTimes.splice(adrIdx, 1);
    renderAdrenalineTimes(idx);
    updateState();
  }
};

function renderAdrenalineTimes(idx) {
  const container = $(`#adrenaline_times_${idx}`);
  if(!container) return;
  container.innerHTML = '';
  
  const times = state.cardr.cpaEvents[idx]?.adrenalineTimes || [];
  times.forEach((time, adrIdx) => {
    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:8px';
    row.innerHTML = `
      <span style="font-weight:500;min-width:60px">${adrIdx + 1}å›ç›®</span>
      <div class="vital-item" style="border:1px solid var(--line);border-radius:10px;padding:8px 12px;cursor:pointer;flex:1;text-align:center" onclick="openAdrenalineTimeDial(${idx}, ${adrIdx})">
        <span style="font-size:18px;font-weight:600;color:var(--brand)">${time}</span>
      </div>
      <button class="btn small ghost" style="padding:8px 12px;width:auto" onclick="removeAdrenalineTime(${idx}, ${adrIdx})">å‰Šé™¤</button>
    `;
    container.appendChild(row);
  });
}

window.openAdrenalineTimeDial = (idx, adrIdx) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const currentTime = state.cardr.cpaEvents[idx]?.adrenalineTimes?.[adrIdx] || '00:00';
  const [h, m] = currentTime.split(':').map(Number);
  
  const hours = Array.from({length: 24}, (_, i) => ({label: String(i).padStart(2,'0'), value: String(i).padStart(2,'0')}));
  const minutes = Array.from({length: 60}, (_, i) => ({label: String(i).padStart(2,'0'), value: String(i).padStart(2,'0')}));
  
  const wheels = [
    {options: hours, selected: String(h).padStart(2,'0'), unit: ':'},
    {options: minutes, selected: String(m).padStart(2,'0'), unit: ''}
  ];
  
  openDial(`ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³ ${adrIdx + 1}å›ç›®`, wheels, vals => {
    if (state.cardr.cpaEvents[idx]?.adrenalineTimes) {
      const newTime = `${vals[0]}:${vals[1]}`;
      state.cardr.cpaEvents[idx].adrenalineTimes[adrIdx] = newTime;
      renderAdrenalineTimes(idx);
      updateState();
    }
  });
};

// Flow Timeè¨ˆç®—é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
function calcFlowTimes(idx) {
  const event = state.cardr.cpaEvents[idx];
  if (!event) return;
  
  const arrestTime = event.arrestTime;
  const cprStart = event.cprStart;
  const roscTime = event.roscTime;
  
  // ã‚¤ãƒ™ãƒ³ãƒˆ1ï¼ˆåˆå›ï¼‰ã®å ´åˆã®ã¿No Flow Timeã‚’è¨ˆç®—
  if(idx === 0) {
    // No Flow Time = å¿ƒåœæ­¢ã‹ã‚‰èƒ¸éª¨åœ§è¿«é–‹å§‹ã¾ã§
    if(arrestTime && cprStart) {
      const noFlow = calcTimeDiffMinutes(arrestTime, cprStart);
      const el = $(`#no_flow_time_${idx}`);
      if(el) el.textContent = noFlow >= 0 ? `${noFlow} åˆ†` : '-- åˆ†';
    } else {
      const el = $(`#no_flow_time_${idx}`);
      if(el) el.textContent = '-- åˆ†';
    }
    
    // Low Flow Time = èƒ¸éª¨åœ§è¿«é–‹å§‹ã‹ã‚‰ROSCã¾ã§
    if(cprStart && roscTime) {
      const lowFlow = calcTimeDiffMinutes(cprStart, roscTime);
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = lowFlow >= 0 ? `${lowFlow} åˆ†` : '-- åˆ†';
    } else {
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = '-- åˆ†';
    }
  } else {
    // ã‚¤ãƒ™ãƒ³ãƒˆ2ä»¥é™ï¼ˆå†å¿ƒåœæ­¢ï¼‰ã®å ´åˆã¯Low Flow Timeã®ã¿ = å¿ƒåœæ­¢ã‹ã‚‰ROSCã¾ã§
    if(arrestTime && roscTime) {
      const lowFlow = calcTimeDiffMinutes(arrestTime, roscTime);
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = lowFlow >= 0 ? `${lowFlow} åˆ†` : '-- åˆ†';
    } else {
      const el = $(`#low_flow_time_${idx}`);
      if(el) el.textContent = '-- åˆ†';
    }
  }
}

function calcTimeDiffMinutes(startTime, endTime) {
  const [sh, sm] = startTime.split(':').map(Number);
  const [eh, em] = endTime.split(':').map(Number);
  const startMinutes = sh * 60 + sm;
  const endMinutes = eh * 60 + em;
  // æ—¥ä»˜ã‚’ã¾ãŸãå ´åˆã®è€ƒæ…®ï¼ˆ23:50 -> 00:10 ã®å ´åˆã€20åˆ†ã¨ã—ã¦è¨ˆç®—ï¼‰
  return endMinutes >= startMinutes ? endMinutes - startMinutes : (endMinutes + 24 * 60) - startMinutes;
}

// ç³å­”å¾„ãƒ€ã‚¤ãƒ¤ãƒ«é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
window.openPupilDial = (side) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  // state.cardr.strokeãŒæœªå®šç¾©ã®å ´åˆã‚’è€ƒæ…®ã—ã¦åˆæœŸåŒ–
  if(!state.cardr.stroke) state.cardr.stroke = {mmt:{}, nihss:{}, pupilL:3.0, pupilR:3.0};
  
  const current = state.cardr.stroke[`pupil${side}`] ?? 3.0;
  const options = [];
  for(let i = 1; i <= 9; i += 0.5) {
    // valueã¯å°æ•°ã‚’å«ã‚€æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒ
    const val = i.toFixed(1);
    options.push({label: val, value: val});
  }
  const wheels = [{options, selected: current.toFixed(1), unit: 'mm'}];
  
  openDial(`ç³å­”å¾„ ${side === 'L' ? 'å·¦' : 'å³'}`, wheels, vals => {
    state.cardr.stroke[`pupil${side}`] = parseFloat(vals[0]);
    $(`#pupil${side}_display`).textContent = vals[0];
    updateState();
  });
};

// MMTãƒ€ã‚¤ãƒ¤ãƒ«é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
window.openMmtDial = (limb) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const labels = {ru:'å³ä¸Šè‚¢', lu:'å·¦ä¸Šè‚¢', rl:'å³ä¸‹è‚¢', ll:'å·¦ä¸‹è‚¢'};
  // state.cardr.stroke.mmtãŒæœªå®šç¾©ã®å ´åˆã‚’è€ƒæ…®ã—ã¦åˆæœŸåŒ–
  if(!state.cardr.stroke) state.cardr.stroke = {mmt:{}, nihss:{}};
  if(!state.cardr.stroke.mmt) state.cardr.stroke.mmt = {};
  
  const current = state.cardr.stroke.mmt[limb] ?? 5;
  const options = [];
  for(let i = 0; i <= 5; i++) {
    options.push({label: i.toString(), value: i});
  }
  const wheels = [{options, selected: current}];
  
  openDial(`MMT ${labels[limb]}`, wheels, vals => {
    state.cardr.stroke.mmt[limb] = vals[0];
    $(`#mmt_${limb}_display`).textContent = vals[0];
    updateState();
  });
};

// NIHSSé–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
const NIHSS_ITEMS = [
  {id:'1a', label:'1a æ„è­˜æ°´æº–', hint:'0:è¦šé†’ 1:è»½åº¦éˆéº» 2:å¼·ã„åˆºæ¿€ã§é–‹çœ¼ 3:åå¿œãªã—', max:3},
  {id:'1b', label:'1b è³ªå•ï¼ˆå¹´é½¢/æœˆï¼‰', hint:'0:ä¸¡æ–¹æ­£è§£ 1:1ã¤æ­£è§£ 2:ä¸¡æ–¹ä¸æ­£è§£', max:2},
  {id:'1c', label:'1c å¾“å‘½ï¼ˆé–‹é–‰çœ¼/æ¡æ‰‹ï¼‰', hint:'0:ä¸¡æ–¹æ­£è§£ 1:1ã¤æ­£è§£ 2:ä¸¡æ–¹ä¸æ­£è§£', max:2},
  {id:'2', label:'2 æ³¨è¦–', hint:'0:æ­£å¸¸ 1:éƒ¨åˆ†çš„æ³¨è¦–éº»ç—º 2:å®Œå…¨æ³¨è¦–éº»ç—º', max:2},
  {id:'3', label:'3 è¦–é‡', hint:'0:æ­£å¸¸ 1:éƒ¨åˆ†çš„åŠç›² 2:å®Œå…¨åŠç›² 3:ä¸¡å´æ€§', max:3},
  {id:'4', label:'4 é¡”é¢éº»ç—º', hint:'0:ãªã— 1:è»½åº¦ 2:éƒ¨åˆ†çš„ 3:å®Œå…¨', max:3},
  {id:'5a', label:'5a ä¸Šè‚¢é‹å‹• å³', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'5b', label:'5b ä¸Šè‚¢é‹å‹• å·¦', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'6a', label:'6a ä¸‹è‚¢é‹å‹• å³', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'6b', label:'6b ä¸‹è‚¢é‹å‹• å·¦', hint:'0:ä¿æŒ 1-4:è½ä¸‹ç¨‹åº¦', max:4},
  {id:'7', label:'7 é‹å‹•å¤±èª¿', hint:'0:ãªã— 1:1è‚¢ 2:2è‚¢', max:2},
  {id:'8', label:'8 æ„Ÿè¦š', hint:'0:æ­£å¸¸ 1:è»½åº¦ä½ä¸‹ 2:é‡åº¦ä½ä¸‹', max:2},
  {id:'9', label:'9 è¨€èª', hint:'0:æ­£å¸¸ 1:è»½åº¦ 2:é‡åº¦ 3:å…¨å¤±èª', max:3},
  {id:'10', label:'10 æ§‹éŸ³éšœå®³', hint:'0:æ­£å¸¸ 1:è»½åº¦ 2:é‡åº¦', max:2},
  {id:'11', label:'11 æ¶ˆå»/æ³¨æ„éšœå®³', hint:'0:ãªã— 1:è»½åº¦ 2:é‡åº¦', max:2}
];

function renderNihss() {
  const container = $('#nihss_area');
  if(!container) return;
  container.innerHTML = '';
  
  NIHSS_ITEMS.forEach(item => {
    const val = state.cardr.stroke?.nihss?.[item.id] ?? 0;
    
    const row = document.createElement('div');
    row.style.cssText = 'margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e5e7eb';
    
    row.innerHTML = `
      <div style="font-weight:600;font-size:13px">${item.label}</div>
      <div style="font-size:11px;color:#6b7280;margin:2px 0 6px">${item.hint}</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${Array.from({length: item.max + 1}, (_, i) => 
          `<button class="nihss-btn ${val === i ? 'active' : ''}" data-item="${item.id}" data-val="${i}" onclick="setNihss('${item.id}',${i})">${i}</button>`
        ).join('')}
      </div>
    `;
    container.appendChild(row);
  });
  
  calcNihssSum();
}

function setNihss(itemId, val) {
  if(!state.cardr.stroke) state.cardr.stroke = {mmt:{}, nihss:{}};
  if(!state.cardr.stroke.nihss) state.cardr.stroke.nihss = {};

  state.cardr.stroke.nihss[itemId] = val;
  
  $$(`[data-item="${itemId}"]`).forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.val) === val);
  });
  
  calcNihssSum();
  updateState();
}

function calcNihssSum() {
  const nihss = state.cardr.stroke?.nihss || {};
  let sum = 0;
  NIHSS_ITEMS.forEach(item => {
    sum += nihss[item.id] || 0;
  });
  const el = $('#nihss_sum');
  if(el) el.textContent = `${sum}ç‚¹`;
  return sum;
}

// ãƒã‚¤ã‚¿ãƒ«è¿½åŠ ãƒ»æç”»é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
window.addEmsVital = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  let newVital;
  if(state.ems.vitals.length > 0) {
    const prev = state.ems.vitals[state.ems.vitals.length - 1];
    newVital = {
      time,
      sbp: prev.sbp,
      dbp: prev.dbp,
      hr: prev.hr,
      rr: prev.rr,
      spo2: prev.spo2,
      bt: prev.bt,
      gcs: {e: prev.gcs.e, v: prev.gcs.v, m: prev.gcs.m},
      jcs: prev.jcs
    };
  } else {
    newVital = {time, sbp:120, dbp:80, hr:80, rr:16, spo2:98, bt:36.5, gcs:{e:4,v:5,m:6}, jcs:'0'};
  }
  
  state.ems.vitals.push(newVital);
  renderEmsVitals();
  updateState();
};

window.addCarDrVital = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const now = new Date();
  const time = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
  
  let newVital;
  if(state.cardr.vitals.length > 0) {
    const prev = state.cardr.vitals[state.cardr.vitals.length - 1];
    newVital = {
      time,
      sbp: prev.sbp,
      dbp: prev.dbp,
      hr: prev.hr,
      rr: prev.rr,
      spo2: prev.spo2,
      bt: prev.bt,
      gcs: {e: prev.gcs.e, v: prev.gcs.v, m: prev.gcs.m},
      jcs: prev.jcs
    };
  } else {
    newVital = {time, sbp:120, dbp:80, hr:80, rr:16, spo2:98, bt:36.5, gcs:{e:4,v:5,m:6}, jcs:'0'};
  }
  
  state.cardr.vitals.push(newVital);
  renderCarDrVitals();
  updateState();
};

window.removeVital = (type, idx) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    state[type].vitals.splice(idx, 1);
    if(type === 'ems') renderEmsVitals();
    else renderCarDrVitals();
    updateState();
  }
};

function renderEmsVitals() {
  const c = $('#ems_vitals_container');
  if(c) c.innerHTML = '';
  if(c) state.ems.vitals.forEach((v, i) => c.appendChild(createVitalCard('ems', i, v)));
}

function renderCarDrVitals() {
  const c = $('#cardr_vitals_container');
  if(c) c.innerHTML = '';
  if(c) state.cardr.vitals.forEach((v, i) => c.appendChild(createVitalCard('cardr', i, v)));
}

function createVitalCard(type, idx, v) {
  const card = document.createElement('div');
  card.className = 'vital-card';
  
  const gcsV = v.gcs.v === 'T' ? 'T' : parseInt(v.gcs.v);
  const gcsM = parseInt(v.gcs.m);
  const gcsSum = v.gcs.v === 'T' ? `${v.gcs.e + gcsM}T` : (v.gcs.e + gcsV + gcsM);
  const spo2Display = v.spo2 === 0 ? '--' : v.spo2;
  
  card.innerHTML = `
    <div class="vital-header">
      <div class="vital-time">
        <input type="time" value="${v.time}" onchange="state.${type}.vitals[${idx}].time=this.value;updateState()">
      </div>
      <button class="vital-del" onclick="removeVital('${type}',${idx})">å‰Šé™¤</button>
    </div>
    <div class="vital-grid">
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'bp')">
        <div class="vital-label">BP</div>
        <div class="vital-value">${v.sbp}/${v.dbp}</div>
        <div class="vital-unit">mmHg</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'hr')">
        <div class="vital-label">HR</div>
        <div class="vital-value">${v.hr}</div>
        <div class="vital-unit">bpm</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'rr')">
        <div class="vital-label">RR</div>
        <div class="vital-value">${v.rr}</div>
        <div class="vital-unit">/min</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'spo2')">
        <div class="vital-label">SpOâ‚‚</div>
        <div class="vital-value">${spo2Display}</div>
        <div class="vital-unit">%</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'bt')">
        <div class="vital-label">BT</div>
        <div class="vital-value">${v.bt}</div>
        <div class="vital-unit">â„ƒ</div>
      </div>
      <div class="vital-item" onclick="openVitalDial('${type}',${idx},'jcs')">
        <div class="vital-label">JCS</div>
        <div class="vital-value">${v.jcs}</div>
      </div>
      <div class="vital-gcs">
        <div class="gcs-part" onclick="openVitalDial('${type}',${idx},'gcs_e')">
          <span class="lbl">E</span>
          <span class="val">${v.gcs.e}</span>
        </div>
        <div class="gcs-part" onclick="openVitalDial('${type}',${idx},'gcs_v')">
          <span class="lbl">V</span>
          <span class="val">${v.gcs.v}</span>
        </div>
        <div class="gcs-part" onclick="openVitalDial('${type}',${idx},'gcs_m')">
          <span class="lbl">M</span>
          <span class="val">${v.gcs.m}</span>
        </div>
        <div class="gcs-sum">${gcsSum}</div>
      </div>
    </div>
  `;
  return card;
}

// æ™‚åˆ»è¨­å®šé–¢æ•°ç¾¤
window.setNow = (id) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const el = $(`#${id}`);
  if(el) {
    const now = new Date();
    el.value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    updateState();
  }
};

// ãƒãƒƒãƒ—ãƒ»æ‰€è¦‹é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
function mkChip(label, mode, prefix) {
  const el = document.createElement('span');
  el.className = 'chip';
  el.textContent = label;
  el.dataset.state = state[prefix].chips[label] || '';
  
  el.onclick = () => {
    const cur = el.dataset.state || '';
    let nxt = '';
    // 'normal'ãƒ¢ãƒ¼ãƒ‰ã¯ON/OFFã®ãƒˆã‚°ãƒ«
    if(mode === 'normal') nxt = cur === 'on' ? '' : 'on';
    // 'abn'ãƒ¢ãƒ¼ãƒ‰ã¯ç©º -> + -> - -> ç©º ã®ãƒˆã‚°ãƒ«
    else nxt = cur === '' ? '+' : cur === '+' ? '-' : '';
    el.dataset.state = nxt;
    if(nxt) state[prefix].chips[label] = nxt;
    else delete state[prefix].chips[label];
    updateState();
  };
  return el;
}

function mountChips(id, def, prefix) {
  const box = $(id);
  if(!box) return;
  box.innerHTML = '';
  if(Array.isArray(def)) {
    def.forEach(x => box.appendChild(mkChip(x, 'abn', prefix)));
  } else {
    (def.normal || []).forEach(x => box.appendChild(mkChip(x, 'normal', prefix)));
    (def.abn || []).forEach(x => box.appendChild(mkChip(x, 'abn', prefix)));
  }
}

// å‡¦ç½®ãƒ»è–¬å‰¤ãƒãƒƒãƒ— (æ©Ÿèƒ½æ‹¡å¼µ)
function renderProcedureChips(containerId, items, stateObj) {
  const c = $(`#${containerId}`);
  if (!c) return;
  
  c.innerHTML = '';
  
  // å¿µã®ãŸã‚ã€intubationã¨drug_detailsã®åˆæœŸåŒ–
  if (containerId === 'cardr_procedures' && !state.cardr.intubation) state.cardr.intubation = {time: '', size: '7.0'};
  if (containerId === 'cardr_drugs' && !state.cardr.drug_details) state.cardr.drug_details = {};

  items.forEach(item => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    
    let chipText = item;
    
    // è–¬å‰¤æŠ•ä¸ãƒãƒƒãƒ—ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚’ã€æŠ•ä¸å›æ•°ã§æ›´æ–°
    if(containerId === 'cardr_drugs' && state.cardr.drugs[item] && state.cardr.drug_details[item]?.length > 0) {
        const details = state.cardr.drug_details[item];
        const lastDetail = details[details.length - 1];
        if(details.length > 1) {
            chipText = `${item} (${details.length}å›)`;
        } else {
            // ç‚¹æ»´/è¼¸æ¶²ã¯é‡ã§ã¯ãªãé–‹å§‹ã®ã¿
            if(['ç”Ÿé£Ÿ', 'ã‚½ãƒ«ã‚¢ã‚»ãƒˆF', 'ãƒ–ãƒ‰ã‚¦ç³–æ¶²'].includes(item)) {
                chipText = `${item} ${lastDetail.time} (é–‹å§‹)`;
            } else {
                chipText = `${item} ${lastDetail.time} (${lastDetail.amount}mg)`;
            }
        }
    } else if(containerId === 'cardr_procedures' && item === 'æ°—ç®¡æŒ¿ç®¡' && state.cardr.procedures[item] && state.cardr.intubation.time) {
        // æ°—ç®¡æŒ¿ç®¡ã¯è¤‡æ•°å›ãªã„ã®ã§ãã®ã¾ã¾
        chipText = `${item} ${state.cardr.intubation.time} (${state.cardr.intubation.size}mm)`;
    }
    // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¿½åŠ 
    if(stateObj[item]) {
      chip.textContent = `âœ“ ${chipText}`;
      chip.dataset.state = 'proc';
    } else {
      chip.textContent = chipText;
    }
    
    chip.onclick = () => {
      // è–¬å‰¤ãƒãƒƒãƒ—ï¼ˆç‚¹æ»´/ãã®ä»–ï¼‰
      if(containerId === 'cardr_drugs') {
          // ç”Ÿé£Ÿã€ã‚½ãƒ«ã‚¢ã‚»ãƒˆFã€ãƒ–ãƒ‰ã‚¦ç³–æ¶²ã¯æŠ•ä¸é‡/æ™‚åˆ»ã®å…¥åŠ›ãªã—ï¼ˆå˜ç´”ãªãƒã‚§ãƒƒã‚¯ï¼‰
          if(['ç”Ÿé£Ÿ', 'ã‚½ãƒ«ã‚¢ã‚»ãƒˆF', 'ãƒ–ãƒ‰ã‚¦ç³–æ¶²'].includes(item)) {
              if (stateObj[item]) {
                  // æ—¢ã«ONã®å ´åˆã€æ™‚åˆ»ã‚’è¨˜éŒ²æ¸ˆã¿ã®å ´åˆã¯è§£é™¤ã‚’å°‹ã­ã‚‹
                  if(state.cardr.drug_details[item]?.length > 0) {
                     // æ—¢å­˜ã®æ™‚åˆ»ã‚’å‰Šé™¤ã—ã€çŠ¶æ…‹ã‚’OFFã«ã™ã‚‹
                     stateObj[item] = false;
                     delete state.cardr.drug_details[item];
                  } else {
                     // æœªè¨˜éŒ²ã§ONã ã£ãŸå ´åˆã€åˆå›è¨˜éŒ²ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
                     stateObj[item] = true;
                     openIVStartDial(item);
                     return;
                  }
              } else {
                  // OFFã®å ´åˆã€ONã«ã—ã¦æ™‚åˆ»ã‚’è¨˜éŒ²
                  stateObj[item] = true;
                  openIVStartDial(item);
              }
          }
          
          // ãã®ä»–ã®è–¬å‰¤ã¯ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’é–‹ã
          else {
              if(stateObj[item]) {
                  // æ—¢ã«æŠ•ä¸æ¸ˆã¿ã®å ´åˆã¯ã€è¿½åŠ æŠ•ä¸ã¾ãŸã¯è§£é™¤ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
                  openDrugDetailDial(item, true); // true: è¤‡æ•°å›æŠ•ä¸ãƒ¢ãƒ¼ãƒ‰
              } else {
                  // åˆå›æŠ•ä¸ã®å ´åˆã¯ã€æŠ•ä¸æ™‚åˆ»ã¨é‡ã‚’è¨­å®šã™ã‚‹
                  stateObj[item] = true;
                  openDrugDetailDial(item, false);
              }
          }
          
          // çŠ¶æ…‹å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã¯ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’åæ˜ 
          renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
          updateState();
          return;
      }
      
      // æ°—ç®¡æŒ¿ç®¡ã¯ãƒ€ã‚¤ãƒ¤ãƒ«ã‚’é–‹ã (ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ)
      if(containerId === 'cardr_procedures' && item === 'æ°—ç®¡æŒ¿ç®¡') {
        if(stateObj[item]) {
            // æ—¢ã«ONã®å ´åˆ: è§£é™¤å‡¦ç†
            if(confirm('æ°—ç®¡æŒ¿ç®¡ã®è¨˜éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                stateObj[item] = false;
                // æ°—ç®¡æŒ¿ç®¡ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆ
                state.cardr.intubation = {time: '', size: '7.0'}; 
            } else {
                // è§£é™¤ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„ (ãƒ€ã‚¤ã‚¢ãƒ«ã‚‚é–‹ã‹ãªã„)
                return;
            }
        } else {
            // OFFã®å ´åˆ: è¨˜éŒ²ãƒ€ã‚¤ã‚¢ãƒ«ã‚’é–‹ã
            stateObj[item] = true;
            openIntubationDial();
        }
        
        // çŠ¶æ…‹å¤‰æ›´ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å‘¼ã³å‡ºã™
        renderProcedureChips('cardr_procedures', state.cardr.procedures_items, state.cardr.procedures); 
        updateState();
        return;
      }
      
      // é€šå¸¸ã®ãƒˆã‚°ãƒ«
      stateObj[item] = !stateObj[item];
      chip.dataset.state = stateObj[item] ? 'proc' : '';
      
      if(containerId === 'ems_procedures' && item === 'é…¸ç´ æŠ•ä¸') {
        const o2AmountEl = $('#ems_o2_amount');
        if (o2AmountEl) {
          o2AmountEl.style.display = stateObj[item] ? 'block' : 'none';
          if(stateObj[item] && !state.ems.o2_flow) {
            setTimeout(() => openO2FlowDial(), 100);
          }
        }
      }
      
      updateState();
    };
    c.appendChild(chip);
  });
}

// æ—¢å¾€æ­´ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹é–¢æ•°
function syncHistoryChipsFromText() {
  if (!state.patient.history_chips) {
    state.patient.history_chips = {};
  }
  
  const historyTextarea = $('#patient_history');
  if (!historyTextarea) return;
  
  const historyItems = ['é«˜è¡€åœ§', 'ç³–å°¿ç—…', 'è„‚è³ªç•°å¸¸ç—‡', 'è™šè¡€æ€§å¿ƒç–¾æ‚£', 'è„³è¡€ç®¡éšœå®³', 'å–˜æ¯', 'COPD', 'æ‚ªæ€§è…«ç˜', 'ã¦ã‚“ã‹ã‚“', 'ç·‘å†…éšœ'];
  const currentValue = historyTextarea.value || state.patient.history || '';
  
  if (currentValue) {
    const items = currentValue.split('ã€').map(item => item.trim());
    historyItems.forEach(item => {
      state.patient.history_chips[item] = items.includes(item);
    });
  } else {
    // ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã®å ´åˆã¯ã™ã¹ã¦false
    historyItems.forEach(item => {
      state.patient.history_chips[item] = false;
    });
  }
}

// æ—¢å¾€æ­´ãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
function renderHistoryChips() {
  const c = $('#patient_history_chips');
  if (!c) return;
  
  c.innerHTML = '';
  
  const historyItems = ['é«˜è¡€åœ§', 'ç³–å°¿ç—…', 'è„‚è³ªç•°å¸¸ç—‡', 'è™šè¡€æ€§å¿ƒç–¾æ‚£', 'è„³è¡€ç®¡éšœå®³', 'å–˜æ¯', 'COPD', 'æ‚ªæ€§è…«ç˜', 'ã¦ã‚“ã‹ã‚“', 'ç·‘å†…éšœ'];
  
  if (!state.patient.history_chips) {
    state.patient.history_chips = {};
  }
  
  historyItems.forEach(item => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    
    const isSelected = state.patient.history_chips[item] || false;
    if (isSelected) chip.classList.add('on');
    chip.textContent = item;
    
    chip.onclick = () => {
      // ãƒˆã‚°ãƒ«å‡¦ç†
      const currentState = state.patient.history_chips[item] || false;
      state.patient.history_chips[item] = !currentState;
      
      // ãƒãƒƒãƒ—ã®è¡¨ç¤ºã‚’æ›´æ–°
      if (state.patient.history_chips[item]) {
        chip.classList.add('on');
      } else {
        chip.classList.remove('on');
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«åæ˜ 
      updateHistoryTextarea();
      updateState();
    };
    
    c.appendChild(chip);
  });
}

// æ—¢å¾€æ­´ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateHistoryTextarea() {
  const historyTextarea = $('#patient_history');
  if (!historyTextarea) return;
  
  const historyItems = ['é«˜è¡€åœ§', 'ç³–å°¿ç—…', 'è„‚è³ªç•°å¸¸ç—‡', 'è™šè¡€æ€§å¿ƒç–¾æ‚£', 'è„³è¡€ç®¡éšœå®³', 'å–˜æ¯', 'COPD', 'æ‚ªæ€§è…«ç˜', 'ã¦ã‚“ã‹ã‚“', 'ç·‘å†…éšœ'];
  
  // é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒƒãƒ—ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
  const selectedItems = Object.keys(state.patient.history_chips || {})
    .filter(key => state.patient.history_chips[key]);
  
  // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ç¾åœ¨ã®å€¤ã‚’å–å¾—
  const currentValue = historyTextarea.value || '';
  
  // æ—¢å­˜ã®å€¤ã‹ã‚‰ãƒãƒƒãƒ—é …ç›®ã‚’æŠ½å‡ºï¼ˆæ‰‹å‹•å…¥åŠ›ã•ã‚ŒãŸé …ç›®ã‚’ä¿æŒï¼‰
  const existingItems = currentValue.split('ã€').map(item => item.trim()).filter(item => item);
  const manualItems = existingItems.filter(item => !historyItems.includes(item));
  
  // é¸æŠã•ã‚ŒãŸãƒãƒƒãƒ—é …ç›®ã¨æ‰‹å‹•å…¥åŠ›é …ç›®ã‚’çµåˆ
  const allItems = [...new Set([...selectedItems, ...manualItems])];
  const newValue = allItems.join('ã€');
  
  historyTextarea.value = newValue;
  
  // stateã‚‚æ›´æ–°
  state.patient.history = newValue;
}

// æŠ—å‡å›ºè–¬ãƒ»æŠ—è¡€å°æ¿è–¬ãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
function renderMedicationChips() {
  const c = $('#patient_medication_chips');
  if (!c) return;
  
  c.innerHTML = '';
  
  if (!state.patient.anticoagulant) state.patient.anticoagulant = '';
  if (!state.patient.antiplatelet) state.patient.antiplatelet = '';
  if (!state.patient.anticoagulant_drugs) state.patient.anticoagulant_drugs = [];
  if (!state.patient.antiplatelet_drugs) state.patient.antiplatelet_drugs = [];
  
  // æŠ—å‡å›ºè–¬ãƒãƒƒãƒ—
  const anticoagulantChip = document.createElement('div');
  anticoagulantChip.className = 'chip';
  const anticoagulantState = state.patient.anticoagulant || '';
  if (anticoagulantState === 'ãªã—') {
    // ç·‘ç‚¹ç¯
    anticoagulantChip.classList.add('on');
  } else if (anticoagulantState === 'ã‚ã‚Š') {
    // èµ¤ç‚¹ç¯
    anticoagulantChip.style.background = '#fee2e2';
    anticoagulantChip.style.borderColor = '#f87171';
    anticoagulantChip.style.color = '#b91c1c';
  }
  anticoagulantChip.textContent = 'æŠ—å‡å›ºè–¬' + (anticoagulantState ? `(${anticoagulantState})` : '');
  anticoagulantChip.onclick = () => {
    // åˆæœŸ -> ãªã— -> ã‚ã‚Š -> åˆæœŸã®3çŠ¶æ…‹ãƒˆã‚°ãƒ«
    const current = state.patient.anticoagulant || '';
    if (current === '') {
      state.patient.anticoagulant = 'ãªã—';
      state.patient.anticoagulant_drugs = [];
    } else if (current === 'ãªã—') {
      state.patient.anticoagulant = 'ã‚ã‚Š';
      state.patient.anticoagulant_drugs = [];
    } else {
      state.patient.anticoagulant = '';
      state.patient.anticoagulant_drugs = [];
    }
    renderMedicationChips();
    updateMedicationTextarea();
    updateState();
  };
  c.appendChild(anticoagulantChip);
  
  // æŠ—è¡€å°æ¿è–¬ãƒãƒƒãƒ—
  const antiplateletChip = document.createElement('div');
  antiplateletChip.className = 'chip';
  const antiplateletState = state.patient.antiplatelet || '';
  if (antiplateletState === 'ãªã—') {
    // ç·‘ç‚¹ç¯
    antiplateletChip.classList.add('on');
  } else if (antiplateletState === 'ã‚ã‚Š') {
    // èµ¤ç‚¹ç¯
    antiplateletChip.style.background = '#fee2e2';
    antiplateletChip.style.borderColor = '#f87171';
    antiplateletChip.style.color = '#b91c1c';
  }
  antiplateletChip.textContent = 'æŠ—è¡€å°æ¿è–¬' + (antiplateletState ? `(${antiplateletState})` : '');
  antiplateletChip.onclick = () => {
    // åˆæœŸ -> ãªã— -> ã‚ã‚Š -> åˆæœŸã®3çŠ¶æ…‹ãƒˆã‚°ãƒ«
    const current = state.patient.antiplatelet || '';
    if (current === '') {
      state.patient.antiplatelet = 'ãªã—';
      state.patient.antiplatelet_drugs = [];
    } else if (current === 'ãªã—') {
      state.patient.antiplatelet = 'ã‚ã‚Š';
      state.patient.antiplatelet_drugs = [];
    } else {
      state.patient.antiplatelet = '';
      state.patient.antiplatelet_drugs = [];
    }
    renderMedicationChips();
    updateMedicationTextarea();
    updateState();
  };
  c.appendChild(antiplateletChip);
  
  // æŠ—å‡å›ºè–¬ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
  const anticoagulantAccordion = $('#anticoagulant_accordion');
  if (anticoagulantAccordion) {
    anticoagulantAccordion.style.display = state.patient.anticoagulant === 'ã‚ã‚Š' ? 'block' : 'none';
  }
  
  // æŠ—è¡€å°æ¿è–¬ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
  const antiplateletAccordion = $('#antiplatelet_accordion');
  if (antiplateletAccordion) {
    antiplateletAccordion.style.display = state.patient.antiplatelet === 'ã‚ã‚Š' ? 'block' : 'none';
  }
  
  // æŠ—å‡å›ºè–¬ã®è–¬å‰¤ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (state.patient.anticoagulant === 'ã‚ã‚Š') {
    renderAnticoagulantDrugs();
  }
  
  // æŠ—è¡€å°æ¿è–¬ã®è–¬å‰¤ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (state.patient.antiplatelet === 'ã‚ã‚Š') {
    renderAntiplateletDrugs();
  }
}

// æŠ—å‡å›ºè–¬ã®è–¬å‰¤ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderAnticoagulantDrugs() {
  const c = $('#anticoagulant_drugs');
  if (!c) return;
  
  c.innerHTML = '';
  
  const drugs = ['ãƒ¯ãƒ¼ãƒ•ã‚¡ãƒªãƒ³', 'ã‚¤ã‚°ã‚¶ãƒ¬ãƒ«ãƒˆ', 'ã‚¨ãƒªã‚­ãƒ¥ãƒ¼ã‚¹', 'ãƒªã‚¯ã‚·ã‚¢ãƒŠ', 'ãƒ—ãƒ©ã‚¶ã‚­ã‚µ'];
  
  drugs.forEach(drug => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    const isSelected = state.patient.anticoagulant_drugs.includes(drug);
    if (isSelected) chip.classList.add('on');
    chip.textContent = drug;
    
    chip.onclick = () => {
      // æŠ—å‡å›ºè–¬ã¯å˜ä¸€é¸æŠ
      if (state.patient.anticoagulant_drugs.includes(drug)) {
        state.patient.anticoagulant_drugs = [];
      } else {
        state.patient.anticoagulant_drugs = [drug];
      }
      renderAnticoagulantDrugs();
      updateMedicationTextarea();
      updateState();
    };
    
    c.appendChild(chip);
  });
}

// æŠ—è¡€å°æ¿è–¬ã®è–¬å‰¤ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderAntiplateletDrugs() {
  const c = $('#antiplatelet_drugs');
  if (!c) return;
  
  c.innerHTML = '';
  
  const drugs = ['ãƒã‚¤ã‚¢ã‚¹ãƒ”ãƒªãƒ³', 'ãƒ—ãƒ©ãƒ“ãƒƒã‚¯ã‚¹', 'ã‚¨ãƒ•ã‚£ã‚¨ãƒ³ãƒˆ', 'ãƒã‚¯ãƒ­ãƒ”ã‚¸ãƒ³', 'ãƒ—ãƒ¬ã‚¿ãƒ¼ãƒ«', 'ã‚¢ãƒ³ãƒ—ãƒ©ãƒ¼ã‚°', 'ãƒ—ãƒ­ãƒ¬ãƒŠãƒ¼ãƒ«', 'ã‚³ãƒ³ãƒ—ãƒ©ãƒ“ãƒ³é…åˆéŒ '];
  
  drugs.forEach(drug => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    const isSelected = state.patient.antiplatelet_drugs.includes(drug);
    if (isSelected) chip.classList.add('on');
    chip.textContent = drug;
    
    chip.onclick = () => {
      // æŠ—è¡€å°æ¿è–¬ã¯è¤‡æ•°é¸æŠå¯èƒ½
      const index = state.patient.antiplatelet_drugs.indexOf(drug);
      if (index > -1) {
        state.patient.antiplatelet_drugs.splice(index, 1);
      } else {
        state.patient.antiplatelet_drugs.push(drug);
      }
      renderAntiplateletDrugs();
      updateMedicationTextarea();
      updateState();
    };
    
    c.appendChild(chip);
  });
}

// å¸¸ç”¨è–¬ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
window.updateMedicationTextarea = function() {
  const medicationTextarea = $('#patient_medication');
  if (!medicationTextarea) return;
  
  const items = [];
  
  // æŠ—å‡å›ºè–¬ã®å‡¦ç†
  if (state.patient.anticoagulant === 'ã‚ã‚Š') {
    if (state.patient.anticoagulant_drugs.length > 0) {
      items.push(`æŠ—å‡å›ºè–¬ ${state.patient.anticoagulant_drugs.join('ã€')}`);
    } else {
      items.push('æŠ—å‡å›ºè–¬ ã‚ã‚Š');
    }
  } else if (state.patient.anticoagulant === 'ãªã—') {
    items.push('æŠ—å‡å›ºè–¬ ãªã—');
  }
  
  // æŠ—è¡€å°æ¿è–¬ã®å‡¦ç†
  if (state.patient.antiplatelet === 'ã‚ã‚Š') {
    if (state.patient.antiplatelet_drugs.length > 0) {
      items.push(`æŠ—è¡€å°æ¿è–¬ ${state.patient.antiplatelet_drugs.join('ã€')}`);
    } else {
      items.push('æŠ—è¡€å°æ¿è–¬ ã‚ã‚Š');
    }
  } else if (state.patient.antiplatelet === 'ãªã—') {
    items.push('æŠ—è¡€å°æ¿è–¬ ãªã—');
  }
  
  const chipText = items.join('ã€');
  const currentValue = medicationTextarea.value || '';
  
  // æ—¢å­˜ã®å€¤ã‹ã‚‰ãƒãƒƒãƒ—é …ç›®ã‚’æŠ½å‡ºï¼ˆæ‰‹å‹•å…¥åŠ›ã•ã‚ŒãŸé …ç›®ã‚’ä¿æŒï¼‰
  const existingItems = currentValue.split('ã€').map(item => item.trim()).filter(item => item);
  const manualItems = existingItems.filter(item => 
    !item.startsWith('æŠ—å‡å›ºè–¬ ') && !item.startsWith('æŠ—è¡€å°æ¿è–¬ ')
  );
  
  // é¸æŠã•ã‚ŒãŸãƒãƒƒãƒ—é …ç›®ã¨æ‰‹å‹•å…¥åŠ›é …ç›®ã‚’çµåˆ
  const allItems = [...new Set([...items, ...manualItems])];
  const newValue = allItems.join('ã€');
  
  medicationTextarea.value = newValue;
  
  // stateã‚‚æ›´æ–°
  state.patient.medication = newValue;
}

// ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
function renderAllergyChips() {
  const c = $('#patient_allergy_chips');
  if (!c) return;
  
  c.innerHTML = '';
  
  if (!state.patient.food_allergy) state.patient.food_allergy = '';
  if (!state.patient.drug_allergy) state.patient.drug_allergy = '';
  
  // é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒãƒƒãƒ—
  const foodAllergyChip = document.createElement('div');
  foodAllergyChip.className = 'chip';
  const foodAllergyState = state.patient.food_allergy || '';
  if (foodAllergyState === 'ãªã—') {
    // ç·‘ç‚¹ç¯
    foodAllergyChip.classList.add('on');
  } else if (foodAllergyState === 'ã‚ã‚Š') {
    // èµ¤ç‚¹ç¯
    foodAllergyChip.style.background = '#fee2e2';
    foodAllergyChip.style.borderColor = '#f87171';
    foodAllergyChip.style.color = '#b91c1c';
  }
  foodAllergyChip.textContent = 'é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼' + (foodAllergyState ? `(${foodAllergyState})` : '');
  foodAllergyChip.onclick = () => {
    // åˆæœŸ -> ãªã— -> ã‚ã‚Š -> åˆæœŸã®3çŠ¶æ…‹ãƒˆã‚°ãƒ«
    const current = state.patient.food_allergy || '';
    if (current === '') {
      state.patient.food_allergy = 'ãªã—';
    } else if (current === 'ãªã—') {
      state.patient.food_allergy = 'ã‚ã‚Š';
    } else {
      state.patient.food_allergy = '';
    }
    renderAllergyChips();
    updateAllergyTextarea();
    updateState();
  };
  c.appendChild(foodAllergyChip);
  
  // è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒãƒƒãƒ—
  const drugAllergyChip = document.createElement('div');
  drugAllergyChip.className = 'chip';
  const drugAllergyState = state.patient.drug_allergy || '';
  if (drugAllergyState === 'ãªã—') {
    // ç·‘ç‚¹ç¯
    drugAllergyChip.classList.add('on');
  } else if (drugAllergyState === 'ã‚ã‚Š') {
    // èµ¤ç‚¹ç¯
    drugAllergyChip.style.background = '#fee2e2';
    drugAllergyChip.style.borderColor = '#f87171';
    drugAllergyChip.style.color = '#b91c1c';
  }
  drugAllergyChip.textContent = 'è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼' + (drugAllergyState ? `(${drugAllergyState})` : '');
  drugAllergyChip.onclick = () => {
    // åˆæœŸ -> ãªã— -> ã‚ã‚Š -> åˆæœŸã®3çŠ¶æ…‹ãƒˆã‚°ãƒ«
    const current = state.patient.drug_allergy || '';
    if (current === '') {
      state.patient.drug_allergy = 'ãªã—';
    } else if (current === 'ãªã—') {
      state.patient.drug_allergy = 'ã‚ã‚Š';
    } else {
      state.patient.drug_allergy = '';
    }
    renderAllergyChips();
    updateAllergyTextarea();
    updateState();
  };
  c.appendChild(drugAllergyChip);
}

// ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
window.updateAllergyTextarea = function() {
  const allergyTextarea = $('#patient_allergy');
  if (!allergyTextarea) return;
  
  const items = [];
  
  // é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã®å‡¦ç†
  if (state.patient.food_allergy === 'ã‚ã‚Š') {
    items.push('é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ã‚ã‚Š');
  } else if (state.patient.food_allergy === 'ãªã—') {
    items.push('é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ãªã—');
  }
  
  // è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã®å‡¦ç†
  if (state.patient.drug_allergy === 'ã‚ã‚Š') {
    items.push('è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ã‚ã‚Š');
  } else if (state.patient.drug_allergy === 'ãªã—') {
    items.push('è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ãªã—');
  }
  
  const chipText = items.join('ã€');
  const currentValue = allergyTextarea.value || '';
  
  // æ—¢å­˜ã®å€¤ã‹ã‚‰ãƒãƒƒãƒ—é …ç›®ã‚’æŠ½å‡ºï¼ˆæ‰‹å‹•å…¥åŠ›ã•ã‚ŒãŸé …ç›®ã‚’ä¿æŒï¼‰
  const existingItems = currentValue.split('ã€').map(item => item.trim()).filter(item => item);
  const manualItems = existingItems.filter(item => 
    !item.startsWith('é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ') && !item.startsWith('è–¬å‰¤ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ ')
  );
  
  // é¸æŠã•ã‚ŒãŸãƒãƒƒãƒ—é …ç›®ã¨æ‰‹å‹•å…¥åŠ›é …ç›®ã‚’çµåˆ
  const allItems = [...new Set([...items, ...manualItems])];
  const newValue = allItems.join('ã€');
  
  allergyTextarea.value = newValue;
  
  // stateã‚‚æ›´æ–°
  state.patient.allergy = newValue;
}

// å¹´ä»£ãƒ»æ€§åˆ¥ãƒ»å…ˆè¡Œæ•‘æ€¥éšŠãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
function renderRequestInfoChips() {
  // å¹´ä»£ãƒãƒƒãƒ—
  const ageChips = $('#patient_age_chips');
  if (ageChips) {
    ageChips.innerHTML = '';
    const ageOptions = ['10ä»£', '20ä»£', '30ä»£', '40ä»£', '50ä»£', '60ä»£', '70ä»£', '80ä»£', '90ä»£ä»¥ä¸Š'];
    ageOptions.forEach(age => {
      const chip = document.createElement('div');
      chip.className = 'chip' + (state.request.age === age ? ' active' : '');
      chip.textContent = age;
      chip.onclick = () => {
        state.request.age = state.request.age === age ? '' : age;
        renderRequestInfoChips();
        updateState();
      };
      ageChips.appendChild(chip);
    });
  }
  
  // æ€§åˆ¥ãƒãƒƒãƒ—
  const sexChips = $('#patient_sex_chips');
  if (sexChips) {
    sexChips.innerHTML = '';
    const sexOptions = ['ç”·æ€§', 'å¥³æ€§', 'ä¸æ˜'];
    sexOptions.forEach(sex => {
      const chip = document.createElement('div');
      chip.className = 'chip' + (state.request.sex === sex ? ' active' : '');
      chip.textContent = sex;
      chip.onclick = () => {
        state.request.sex = state.request.sex === sex ? '' : sex;
        renderRequestInfoChips();
        updateState();
      };
      sexChips.appendChild(chip);
    });
  }
  
  // å…ˆè¡Œæ•‘æ€¥éšŠãƒãƒƒãƒ—
  const emsTeamChips = $('#ems_team_chips');
  if (emsTeamChips) {
    emsTeamChips.innerHTML = '';
    const emsTeams = [
      { "id": "chuo", "name": "ä¸­å¤®æ•‘æ€¥éšŠ" },
      { "id": "nanrinji", "name": "å—æ—å¯ºæ•‘æ€¥éšŠ" },
      { "id": "uemachi", "name": "ä¸Šç”ºæ•‘æ€¥éšŠ" },
      { "id": "konan", "name": "ç”²å—æ•‘æ€¥éšŠ" },
      { "id": "yoshino", "name": "å‰é‡æ•‘æ€¥éšŠ" },
      { "id": "yoshida", "name": "å‰ç”°æ•‘æ€¥éšŠ" },
      { "id": "sakurajima_e", "name": "æ¡œå³¶æ±æ•‘æ€¥éšŠ" },
      { "id": "sakurajima_w", "name": "æ¡œå³¶è¥¿æ•‘æ€¥éšŠ" },
      { "id": "nishi", "name": "è¥¿æœ¬ç½²" },
      { "id": "ishiki", "name": "ä¼Šæ•·æ•‘æ€¥éšŠ" },
      { "id": "matsumoto", "name": "æ¾å…ƒæ•‘æ€¥éšŠ" },
      { "id": "koriyama", "name": "éƒ¡å±±æ•‘æ€¥éšŠ" },
      { "id": "minami", "name": "å—æœ¬ç½²" },
      { "id": "taniyama", "name": "è°·å±±æ•‘æ€¥éšŠ" },
      { "id": "taniyama_kita", "name": "è°·å±±åŒ—æ•‘æ€¥éšŠ" },
      { "id": "korimoto", "name": "éƒ¡å…ƒæ•‘æ€¥éšŠ" },
      { "id": "kiire", "name": "å–œå…¥æ•‘æ€¥éšŠ" }
    ];
    
    // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠã•ã‚ŒãŸãƒãƒƒãƒ—ã ã‘ã‚’è¡¨ç¤º
    if (state.request.ems_team) {
      const selectedTeam = emsTeams.find(t => t.id === state.request.ems_team);
      if (selectedTeam) {
        const chip = document.createElement('div');
        chip.className = 'chip active';
        chip.textContent = selectedTeam.name;
        chip.onclick = () => {
          state.request.ems_team = '';
          renderRequestInfoChips();
          updateState();
        };
        emsTeamChips.appendChild(chip);
        
        // å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const changeBtn = document.createElement('div');
        changeBtn.className = 'chip';
        changeBtn.style.cssText = 'background:#f3f4f6;color:#6b7280;border:1.5px solid #d1d5db';
        changeBtn.textContent = 'å¤‰æ›´';
        changeBtn.onclick = () => {
          state.request.ems_team = '';
          renderRequestInfoChips();
          updateState();
        };
        emsTeamChips.appendChild(changeBtn);
      }
    } else {
      // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
      emsTeams.forEach(team => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = team.name;
        chip.onclick = () => {
          state.request.ems_team = team.id;
          renderRequestInfoChips();
          updateState();
        };
        emsTeamChips.appendChild(chip);
      });
    }
  }
}

function renderRequestContentChips() {
  const contentChips = $('#request_content_chips');
  if (!contentChips) return;
  
  contentChips.innerHTML = '';
  
  const contentItems = [
    'å¿ƒè‚ºåœæ­¢',
    'çª’æ¯',
    'å‘¼å¸å›°é›£',
    'èƒ¸ç—›',
    'æ„è­˜æ¶ˆå¤±',
    'æ„è­˜éšœå®³',
    'èƒ¸èƒŒéƒ¨ç—›',
    'äº¤é€šå¤–å‚·',
    'è»¢è½å¤–å‚·',
    'ã‘ã„ã‚Œã‚“'
  ];
  
  // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠã•ã‚ŒãŸãƒãƒƒãƒ—ã ã‘ã‚’è¡¨ç¤º
  if (state.request.content) {
    const chip = document.createElement('div');
    chip.className = 'chip active';
    chip.textContent = state.request.content;
    chip.onclick = () => {
      state.request.content = '';
      $('#request_detail').value = '';
      renderRequestContentChips();
      updateState();
    };
    contentChips.appendChild(chip);
    
    // å¤‰æ›´ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const changeBtn = document.createElement('div');
    changeBtn.className = 'chip';
    changeBtn.style.cssText = 'background:#f3f4f6;color:#6b7280;border:1.5px solid #d1d5db';
    changeBtn.textContent = 'å¤‰æ›´';
    changeBtn.onclick = () => {
      state.request.content = '';
      $('#request_detail').value = '';
      renderRequestContentChips();
      updateState();
    };
    contentChips.appendChild(changeBtn);
  } else {
    // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯å…¨ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
    contentItems.forEach(item => {
      const chip = document.createElement('div');
      chip.className = 'chip';
      chip.textContent = item;
      chip.onclick = () => {
        state.request.content = item;
        $('#request_detail').value = item;
        renderRequestContentChips();
        updateState();
      };
      contentChips.appendChild(chip);
    });
  }
}

// ç‚¹æ»´ãƒ»è¼¸æ¶²é–‹å§‹æ™‚åˆ»ãƒ€ã‚¤ãƒ¤ãƒ«
window.openIVStartDial = (drugName) => {
    const now = new Date();
    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    // æ™‚é–“ã¨åˆ†ã®ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’å®šç¾©
    const hoursOptions = Array.from({length: 24}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
    const minutesOptions = Array.from({length: 60}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
    
    const [h, m] = currentTime.split(':').map(String);

    const wheels = [
        {options: hoursOptions, selected: h, unit: ':'},
        {options: minutesOptions, selected: m}
    ];

    openDial(`${drugName} é–‹å§‹æ™‚åˆ»`, wheels, (vals) => {
        const newTime = `${vals[0]}:${vals[1]}`;
        
        // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é–‹å§‹æ™‚åˆ»ã‚’1å›ç›®ã¨ã—ã¦æ ¼ç´ (é‡='é–‹å§‹'ã¨ä»®å®š)
        state.cardr.drug_details[drugName] = [{
            time: newTime,
            amount: 'é–‹å§‹'
        }];
        
        // ãƒãƒƒãƒ—ã®çŠ¶æ…‹ã‚’ONã«ç¢ºå®š
        state.cardr.drugs[drugName] = true;
        
        renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
        updateState();
    });
};

// ã‚¿ãƒ–ãƒ»UIåˆ¶å¾¡é–¢æ•°ç¾¤ (toggleAbgã‚’ä¿®æ­£)
function setupExamTabs(prefix) {
  const container = $(`#${prefix}_examTabs`);
  if (!container) {
    console.warn(`setupExamTabs: Container not found for prefix "${prefix}"`);
    return;
  }
  
  const tabs = container.querySelectorAll('.exam-tab');
  if (!tabs || tabs.length === 0) {
    console.warn(`setupExamTabs: No tabs found for prefix "${prefix}"`);
    return;
  }
  
  if (!state[prefix]) {
    console.warn(`setupExamTabs: state[${prefix}] is not defined`);
    return;
  }
  
  tabs.forEach(tab => {
    tab.onclick = function() {
      container.querySelectorAll('.exam-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const examType = this.dataset.exam;
      if (state[prefix]) {
        state[prefix].exam_tab = examType;
      }
      const card = this.closest('.card');
      if (card) {
        card.querySelectorAll('.exam-pane').forEach(p => p.classList.remove('active'));
        const pane = card.querySelector(`.exam-pane[data-pane="${examType}"]`);
        if (pane) pane.classList.add('active');
      }
      
      // CPAã‚¿ãƒ–é¸æŠæ™‚ã«ãƒã‚¤ã‚¿ãƒ«åˆæœŸå€¤ã‚’CPAç”¨ã«è¨­å®šï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»˜ãï¼‰
      if(prefix === 'cardr' && examType === 'cpa') {
        setCpaVitalDefaults();
        // å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆãŒç©ºã®å ´åˆã¯è‡ªå‹•çš„ã«è¿½åŠ 
        if(state.cardr && state.cardr.cpaEvents && state.cardr.cpaEvents.length === 0) {
          addCpaEvent();
          // è¿½åŠ å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          setTimeout(() => {
            const container = $('#cpa_events_container');
            if(container && container.children.length > 0) {
              container.scrollIntoView({behavior: 'smooth', block: 'nearest'});
            }
          }, 100);
        }
      }
      
      updateState();
    };
  });
}

function setCpaVitalDefaults() {
  if(!confirm('CPAãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚\nãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã‚’CPAåˆæœŸå€¤ï¼ˆBP:0, HR:0, RR:0, SpO2:æ¸¬å®šä¸èƒ½, JCS:300, GCS:E1V1M1ï¼‰ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }
  
  state.ems.vitals.forEach(v => {
    v.sbp = 0; v.dbp = 0; v.hr = 0; v.rr = 0; v.spo2 = 0; 
    v.jcs = '300'; v.gcs = {e: 1, v: 1, m: 1};
  });
  
  state.cardr.vitals.forEach(v => {
    v.sbp = 0; v.dbp = 0; v.hr = 0; v.rr = 0; v.spo2 = 0; 
    v.jcs = '300'; v.gcs = {e: 1, v: 1, m: 1};
  });
  
  renderEmsVitals();
  renderCarDrVitals();
  updateState();
}

window.toggleTransportTimes = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const method = $('#transport_method')?.value;
  const timesDiv = $('#transport_times');
  if(timesDiv) {
    timesDiv.style.display = (method === 'Iã‚¿ãƒ¼ãƒ³') ? 'none' : 'block';
  }
  updateState();
};

function bindMemos() {
  const bind = (id, obj, key) => {
    const el = $(id);
    if(el) {
      el.value = obj[key] || '';
      el.oninput = () => { obj[key] = el.value; updateState(); };
    }
  };
  ['head','resp','card','abd','limb','neuro'].forEach(k => bind(`#memo-ems-gen-${k}`, state.ems.memos.general, k));
  ['head','neck','chest','abd','pelvis','limb'].forEach(k => bind(`#memo-ems-tra-${k}`, state.ems.memos.trauma, k));
  if(!state.ems.memos.cpa) state.ems.memos.cpa = {memo:''};
  bind('#memo-ems-cpa', state.ems.memos.cpa, 'memo');
  if(!state.ems.memos.stroke) state.ems.memos.stroke = {memo:''};
  bind('#memo-ems-str', state.ems.memos.stroke, 'memo');
  
  ['head','resp','card','abd','limb','neuro'].forEach(k => bind(`#memo-cardr-gen-${k}`, state.cardr.memos.general, k));
  ['head','neck','chest','abd','pelvis','limb'].forEach(k => bind(`#memo-cardr-tra-${k}`, state.cardr.memos.trauma, k));
  
  // è„³å’ä¸­è©³ç´°ãƒ¡ãƒ¢
  ['cn','eye','motor','reflex','higher'].forEach(k => {
    const el = $(`#memo-cardr-str-${k}`);
    if(el) {
      if(!state.cardr.memos.stroke) state.cardr.memos.stroke = {};
      el.value = state.cardr.memos.stroke[k] || '';
      el.oninput = () => { state.cardr.memos.stroke[k] = el.value; updateState(); };
    }
  });
  
  // CPAãƒ¡ãƒ¢
  if(!state.cardr.memos.cpa) state.cardr.memos.cpa = {}; 
  bind('#memo-cardr-cpa-body', state.cardr.memos.cpa, 'body');
  bind('#memo-cardr-cpa-head', state.cardr.memos.cpa, 'head');
  bind('#memo-cardr-cpa-trunk', state.cardr.memos.cpa, 'trunk');
}

// è¡€ã‚¬ã‚¹ (ABG_DIAL_CONFIG, toggleAbg, openAbgDialã‚’ä¿®æ­£)
const ABG_ITEMS = [{item:'pH',unit:'',normal:'7.40'},{item:'pCO2',unit:'mmHg',normal:'40'},{item:'pO2',unit:'mmHg',normal:'95'},{item:'HCO3-',unit:'mmol/L',normal:'24'},{item:'BE',unit:'mEq/L',normal:'1.0'},{item:'Lac',unit:'mmol/L',normal:'1.0'},{item:'Na',unit:'mEq/L',normal:'140'},{item:'Cr',unit:'mg/dL',normal:'0.8'}];

const ABG_DIAL_CONFIG = {
  'pH': {min: 6.80, max: 7.80, step: 0.01, decimals: 2},
  'pCO2': {min: 10, max: 150, step: 1, decimals: 0},
  'pO2': {min: 10, max: 500, step: 1, decimals: 0},
  'HCO3-': {min: 0, max: 50, step: 1, decimals: 0},
  'BE': {min: -30, max: 30, step: 0.1, decimals: 1}, // 0.1åˆ»ã¿ã«å¤‰æ›´
  'Lac': {min: 0, max: 30, step: 0.1, decimals: 1},
  'Na': {min: 100, max: 180, step: 1, decimals: 0},
  'Cr': {min: 0.1, max: 15, step: 0.1, decimals: 1}
};

window.toggleAbg = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  state.cardr.abg_type = $('#cardr_abg_type')?.value;
  const abgArea = $('#abg_area');
  const isSelected = state.cardr.abg_type === 'ABG' || state.cardr.abg_type === 'VBG';
  
  if (abgArea) {
    abgArea.style.display = isSelected ? 'block' : 'none';
  }
  
  // æœªå®Ÿæ–½ã«æˆ»ã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
  if (!isSelected) {
    state.cardr.abg_data = [];
    renderAbgPills();
  } else if (state.cardr.abg_data.length === 0) {
    // é¸æŠã•ã‚ŒãŸãŒãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯åˆæœŸã‚»ãƒƒãƒˆã‚’è¿½åŠ 
    addAbgSet();
  }
  
  updateState();
};

window.addAbgSet = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  ABG_ITEMS.forEach(item => {
    // æ—¢ã«å­˜åœ¨ã™ã‚‹é …ç›®ã¯è¿½åŠ ã—ãªã„
    if(!state.cardr.abg_data.some(x => x.item === item.item)) {
      // å€¤ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ ¼ç´ (å°æ•°ç‚¹èª¿æ•´ã®ãŸã‚)
      const initialValue = parseFloat(item.normal).toFixed(ABG_DIAL_CONFIG[item.item]?.decimals ?? 0);
      state.cardr.abg_data.push({item: item.item, unit: item.unit, val: initialValue});
    }
  });
  renderAbgPills();
  updateState();
};

window.clearAbg = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if(confirm('è¡€ã‚¬ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
    state.cardr.abg_data = [];
    renderAbgPills();
    updateState();
  }
};

window.openAbgDial = (index) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const rec = state.cardr.abg_data[index];
  const config = ABG_DIAL_CONFIG[rec.item];
  if(!config) return;
  
  const options = [];
  for(let v = config.min; v <= config.max; v = parseFloat((v + config.step).toFixed(config.decimals))) {
    const val = v.toFixed(config.decimals);
    options.push({label: val, value: val});
  }
  
  const currentVal = (parseFloat(rec.val) || config.min).toFixed(config.decimals);
  
  const wheels = [{
    options: options,
    selected: currentVal,
    unit: rec.unit
  }];
  
  openDial(`${rec.item}`, wheels, vals => {
    rec.val = vals[0];
    renderAbgPills();
    updateState();
  });
};

window.openAbgManualInput = (index) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const rec = state.cardr.abg_data[index];
  const newVal = prompt(`${rec.item} ã®å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, rec.val);
  if(newVal !== null && newVal.trim() !== '') {
    rec.val = newVal.trim();
    renderAbgPills();
    updateState();
  }
};

function renderAbgPills() {
  const c = $('#abg_pills');
  if (!c) return;
  
  c.innerHTML = '';
  state.cardr.abg_data.forEach((rec, i) => {
    const pill = document.createElement('div');
    pill.className = 'labpill';
    pill.style.cursor = 'pointer';
    pill.innerHTML = `
      <label>${rec.item}</label>
      <span class="abg-val" style="min-width:50px;text-align:right;font-weight:600;color:var(--brand)">${rec.val}</span>
      <span class="unit">${rec.unit}</span>
      <button onclick="event.stopPropagation();state.cardr.abg_data.splice(${i},1);renderAbgPills();updateState()">Ã—</button>
    `;
    
    let pressTimer = null;
    let isLongPress = false;
    
    const valSpan = pill.querySelector('.abg-val');
    
    const handleStart = () => {
        isLongPress = false;
        pressTimer = setTimeout(() => {
            isLongPress = true;
            openAbgManualInput(i);
        }, 500);
    };

    const handleEnd = () => {
        clearTimeout(pressTimer);
        if(!isLongPress) {
            openAbgDial(i);
        }
    };

    const handleMove = () => {
        clearTimeout(pressTimer);
    };

    // Touch events
    valSpan.addEventListener('touchstart', handleStart);
    valSpan.addEventListener('touchend', handleEnd);
    valSpan.addEventListener('touchmove', handleMove);

    // Mouse events (for desktop support)
    valSpan.addEventListener('mousedown', handleStart);
    valSpan.addEventListener('mouseup', handleEnd);
    valSpan.addEventListener('mouseleave', handleMove);
    
    c.appendChild(pill);
  });
}

window.toggleExam = (type) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  state.cardr.exams[type] = !state.cardr.exams[type];
  
  if(type === 'bs') {
    const bsArea = $('#exam_bs_area');
    if (bsArea) bsArea.style.display = state.cardr.exams[type] ? 'block' : 'none';
  } else {
    const txtArea = $(`#exam_${type}_txt`);
    if (txtArea) txtArea.style.display = state.cardr.exams[type] ? 'block' : 'none';
  }
  
  // ãƒãƒƒãƒ—ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  renderExamChips();
  updateState();
};

function renderExamChips() {
  const c = $('#exam_chips');
  if (!c) return;
  
  c.innerHTML = '';
  
  const examItems = [
    { id: 'bs', name: 'è¡€ç³–' },
    { id: 'ucg', name: 'UCG' },
    { id: 'us_abd', name: 'è…¹éƒ¨US' },
    { id: 'us_lung', name: 'è‚ºUS' },
    { id: 'us_neck', name: 'é ¸éƒ¨è¡€ç®¡US' },
    { id: 'ecg', name: '12èª˜å°å¿ƒé›»å›³' },
    { id: 'fast', name: 'FAST' },
    { id: 'efast', name: 'eFAST' }
  ];
  
  examItems.forEach(item => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = item.name;
    
    // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç‚¹ç¯ï¼ˆèƒŒæ™¯è‰²å¤‰æ›´ï¼‰
    if(state.cardr.exams[item.id]) {
      chip.dataset.state = 'proc';
    }
    
    chip.onclick = () => {
      toggleExam(item.id);
    };
    
    c.appendChild(chip);
  });
}

// ãƒ—ãƒ­ãƒ–ãƒ¬ãƒ é–¢æ•°ç¾¤
window.addProblem = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const input = $('#new_problem');
  const text = input?.value.trim();
  if(text) {
    state.problems.push(text);
    if(input) input.value = '';
    renderProblems();
    updateState();
  }
};

function renderProblems() {
  const c = $('#problems');
  if (!c) return;
  
  c.innerHTML = state.problems.map((p, i) => `
    <div class="problem-item">
      <span>#${i+1} ${p}</span>
      <button class="del-btn" onclick="state.problems.splice(${i},1);renderProblems();updateState()">å‰Šé™¤</button>
    </div>
  `).join('');
}

// ãƒˆãƒªã‚¢ãƒ¼ã‚¸ãƒ»é‡ç—‡åº¦åˆ†é¡ãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
function renderTriageChips() {
  const c = $('#triage_chips');
  if (!c) return;
  
  c.innerHTML = '';
  
  const triageOptions = [
    { "value": 1, "label": "Lv1: è˜‡ç”Ÿ (ç›´ã¡ã«)", "color": "#ff0000" },
    { "value": 2, "label": "Lv2: ç·Šæ€¥ (15åˆ†ä»¥å†…)", "color": "#ff8800" },
    { "value": 3, "label": "Lv3: æº–ç·Šæ€¥ (30åˆ†ä»¥å†…)", "color": "#ffff00" },
    { "value": 4, "label": "Lv4: ä½ç·Šæ€¥ (60åˆ†ä»¥å†…)", "color": "#00ff00" },
    { "value": 5, "label": "Lv5: éç·Šæ€¥ (120åˆ†ä»¥å†…)", "color": "#ffffff" }
  ];
  
  triageOptions.forEach(option => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = option.label;
    
    // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç‚¹ç¯
    if(state.triage === option.value) {
      chip.classList.add('active');
      chip.style.background = option.color;
      chip.style.borderColor = option.color;
      chip.style.color = option.value === 5 ? '#000' : '#fff';
    }
    
    chip.onclick = () => {
      state.triage = state.triage === option.value ? null : option.value;
      renderTriageChips();
      updateState();
    };
    
    c.appendChild(chip);
  });
}

function renderSeverityChips() {
  const c = $('#severity_chips');
  if (!c) return;
  
  c.innerHTML = '';
  
  const severityOptions = [
    { "value": 0, "label": "0: å‚·ç—…ãªã—" },
    { "value": 1, "label": "I: è»½å¾® (åŒ»ç™‚ä¸è¦)" },
    { "value": 2, "label": "II: è»½ç—‡ (å¤–æ¥ãƒ¬ãƒ™ãƒ«)" },
    { "value": 3, "label": "III: ä¸­ç­‰ç—‡ (è¦å…¥é™¢ãƒ»ç”Ÿå‘½å±æ©Ÿãªã—)" },
    { "value": 4, "label": "IV: é‡ç—‡ (ç”Ÿå‘½å±æ©Ÿã®å¯èƒ½æ€§ã‚ã‚Š)" },
    { "value": 5, "label": "V: é‡ç¯¤ (ç”Ÿå‘½å±æ©Ÿåˆ‡è¿«)" },
    { "value": 6, "label": "VI: è˜‡ç”Ÿ (CPAãƒ»è˜‡ç”Ÿå¾Œ)" },
    { "value": 7, "label": "VII: æ­»äº¡" }
  ];
  
  severityOptions.forEach(option => {
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.textContent = option.label;
    
    // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç‚¹ç¯
    if(state.severity === option.value) {
      chip.classList.add('active');
    }
    
    chip.onclick = () => {
      state.severity = state.severity === option.value ? null : option.value;
      renderSeverityChips();
      updateState();
    };
    
    c.appendChild(chip);
  });
}

// ç—…é™¢é¸æŠé–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
let selectedRegion = 'é¹¿å…å³¶å¸‚';
let hospitalsShowAll = {}; // åœ°åŸŸã”ã¨ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ç®¡ç†

function renderHospitalChips() {
  const container = $('#destination_chips');
  if (!container) return;
  
  container.innerHTML = '';
  
  // åœ°åŸŸã‚¿ãƒ–
  const regionTabs = document.createElement('div');
  regionTabs.className = 'region-tabs';
  regionTabs.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--line)';
  
  Object.keys(state.hospitals).forEach(region => {
    const tab = document.createElement('div');
    tab.className = 'region-tab';
    tab.style.cssText = `padding:6px 12px;border-radius:16px;font-size:13px;cursor:pointer;${selectedRegion === region ? 'background:var(--brand);color:#fff' : 'background:var(--chip)'}`;
    tab.textContent = region;
    tab.onclick = () => {
      selectedRegion = region;
      renderHospitalChips();
    };
    regionTabs.appendChild(tab);
  });
  container.appendChild(regionTabs);
  
  // åŒ»ç™‚æ©Ÿé–¢ãƒãƒƒãƒ—
  const hospitals = state.hospitals[selectedRegion] || [];
  const initialShowCount = 10;
  const isAllShown = hospitalsShowAll[selectedRegion] || false;
  const hospitalsToShow = isAllShown ? hospitals : hospitals.slice(0, initialShowCount);
  
  const hospitalsContainer = document.createElement('div');
  hospitalsContainer.style.cssText = 'display:flex;flex-wrap:wrap;gap:8px';
  hospitalsContainer.id = 'hospitals_container';
  
  hospitalsToShow.forEach(h => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (state.destination.hospital === h ? ' active' : '');
    chip.textContent = h;
    chip.onclick = () => selectHospital(h);
    hospitalsContainer.appendChild(chip);
  });
  
  // ãã®ä»–ãƒœã‚¿ãƒ³ï¼ˆç—…é™¢ãŒ10ä»¥ä¸Šã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
  if(hospitals.length > initialShowCount && !isAllShown) {
    const moreBtn = document.createElement('div');
    moreBtn.className = 'chip';
    moreBtn.style.cssText = 'background:#e0f2fe;color:#0369a1;font-weight:600;border:1.5px solid #0ea5e9';
    moreBtn.textContent = `ãã®ä»– (${hospitals.length - initialShowCount})`;
    moreBtn.onclick = () => {
      hospitalsShowAll[selectedRegion] = true;
      renderHospitalChips();
    };
    hospitalsContainer.appendChild(moreBtn);
  }
  
  container.appendChild(hospitalsContainer);
  
  updateDestinationDisplay();
}

function selectHospital(name) {
  // åŒã˜ç—…é™¢ã‚’ã‚¿ãƒƒãƒ—ã—ãŸã‚‰é¸æŠè§£é™¤
  if(state.destination.hospital === name) {
    state.destination.hospital = '';
  } else {
    state.destination.hospital = name;
    state.destination.custom = ''; // ç°¡æ˜“é¸æŠæ™‚ã¯è‡ªç”±è¨˜è¼‰ã‚’ã‚¯ãƒªã‚¢
    const customEl = $('#destination_custom');
    if (customEl) customEl.value = '';
  }
  renderHospitalChips();
  updateState();
}

function updateDestinationDisplay() {
  const display = $('#destination_display');
  const selected = $('#destination_selected');
  const hospital = state.destination.custom || state.destination.hospital;
  if(hospital && display && selected) {
    display.style.display = 'block';
    selected.textContent = hospital;
  } else if (display) {
    display.style.display = 'none';
  }
}

// çŠ¶æ…‹æ›´æ–°é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
function updateState() {
  state.request.type = $('#request_type')?.value || '';
  state.request.detail = $('#request_detail')?.value || '';
  state.car.request_time = $('#cardr_request_time')?.value || '';
  state.patient.history = $('#patient_history')?.value || '';
  state.patient.medication = $('#patient_medication')?.value || '';
  state.patient.allergy = $('#patient_allergy')?.value || '';
  state.patient.lastWell = $('#last_well_time')?.value || '';
  state.patient.lastMeal = $('#last_meal_time')?.value || '';
  state.patient.hospital = $('#patient_hospital')?.value || '';
  state.car.departure = $('#car_departure')?.value || '';
  state.car.scene_arrival = $('#scene_arrival')?.value || '';
  state.car.cardr_contact = $('#cardr_contact')?.value || '';
  state.car.activity_place = $('#activity_place')?.value || '';
  state.car.transport_method = $('#transport_method')?.value || 'Uã‚¿ãƒ¼ãƒ³';
  state.car.scene_departure = $('#scene_departure')?.value || '';
  state.car.hospital_arrival = $('#hospital_arrival')?.value || '';
  state.ems.aware = $('#ems_aware')?.value || '';
  state.ems.arrival = $('#ems_arrival')?.value || '';
  state.ems.contact = $('#ems_contact')?.value || '';
  state.ems.pickup = $('#ems_pickup')?.value || '';
  state.ems.departure = $('#ems_departure')?.value || '';
  state.ems.rp = $('#ems_rp')?.value || '';
  state.ems.o2_flow = $('#ems_o2_flow')?.value || '';
  state.ems.procedures_detail = $('#ems_procedures_detail')?.value || '';
  state.ems.stroke_onset = $('#ems_stroke_onset')?.value || '';
  state.cardr.bs = $('#cardr_bs')?.value || 120;
  state.cardr.exam_detail = $('#cardr_exam_detail')?.value || '';
  state.cardr.procedure_detail = $('#cardr_procedure_detail')?.value || '';
  state.cardr.drug_detail = $('#cardr_drug_detail')?.value || '';
  
  // æ¤œæŸ»ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆçŠ¶æ…‹ã¯toggleExamã§ç®¡ç†ï¼‰
  ['ucg','us_abd','us_lung','us_neck','ecg','fast','efast'].forEach(t => { 
    const txtEl = $(`#exam_${t}_txt`);
    if(txtEl) state.cardr.exam_texts[t] = txtEl.value; 
  });

  // è„³å’ä¸­æƒ…å ±ï¼ˆstate.cardr.stroke ã®å­˜åœ¨ã‚’ä¿è¨¼ï¼‰
  if($('#plrL')) {
    if(!state.cardr.stroke) state.cardr.stroke = {mmt:{}, nihss:{}, pupilL:3.0, pupilR:3.0};
    state.cardr.stroke.plrL = $('#plrL')?.value || '';
    state.cardr.stroke.plrR = $('#plrR')?.value || '';
    state.cardr.stroke.gaze = $('#str_gaze')?.value || '';
    state.cardr.stroke.nyst = $('#str_nyst')?.value || '';
    state.cardr.stroke.btr = $('#str_btr')?.value || '';
    state.cardr.stroke.ptr = $('#str_ptr')?.value || '';
    state.cardr.stroke.babinski = $('#str_babinski')?.checked || false;
    state.cardr.stroke.chaddock = $('#str_chaddock')?.checked || false;
    state.cardr.stroke.nihssMemo = $('#nihss_memo')?.value || '';
  }
  
  state.consideration = $('#consideration')?.value || '';
  state.symptom_detail = $('#outputReason')?.value || '';
  
  const customHospital = $('#destination_custom')?.value.trim() || '';
  if(customHospital) {
    state.destination.custom = customHospital;
    if(state.destination.hospital) {
      state.destination.hospital = '';
      renderHospitalChips();
    }
  } else {
    state.destination.custom = '';
  }
  state.destination.reason = $('#selection_reason')?.value || '';
  updateDestinationDisplay();
  
  render();
  // `localStorage`ã®ä½¿ç”¨ã¯ãã®ã¾ã¾ç¶­æŒã—ã¾ã™ãŒã€å®Ÿé‹ç”¨ã§ã¯Firestoreãªã©ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
  localStorage.setItem('doctorCarV1', JSON.stringify(state));
}

function render() {
  const outEl = $('#outText');
  if(outEl) outEl.textContent = generateReport();
}

function fmtFinding(lbl, st) {
  if(st === 'on') return lbl;
  if(st === '+') return `${lbl}ï¼ˆï¼‹ï¼‰`;
  if(st === '-') return `${lbl}ï¼ˆ-ï¼‰`;
  return null;
}

function extractFindings(def, chips) {
  const arr = [];
  // defãŒé…åˆ—ã®å ´åˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã«å¯¾å¿œ
  const labels = Array.isArray(def) ? def : (def.normal || []).concat(def.abn || []);
  labels.forEach(lbl => {
    const st = chips[lbl];
    if(st) { const s = fmtFinding(lbl, st); if(s) arr.push(s); }
  });
  return arr.join('ã€');
}

function generateReport() {
  let r = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€€ç—…é™¢å‰åŒ»ç™‚æ´»å‹•è¨˜éŒ²ï¼ˆãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ï¼‰\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
  
  r += 'ã€è¦è«‹æƒ…å ±ã€‘\n';
  r += `è¦è«‹æ–¹æ³•ï¼š${state.request.type || 'ï¼ˆæœªé¸æŠï¼‰'}\n`;
  if(state.request.age) r += `å¹´ä»£ï¼š${state.request.age}\n`;
  if(state.request.sex) r += `æ€§åˆ¥ï¼š${state.request.sex}\n`;
  if(state.request.ems_team) {
    const emsTeams = [
      { "id": "chuo", "name": "ä¸­å¤®æ•‘æ€¥éšŠ" },
      { "id": "nanrinji", "name": "å—æ—å¯ºæ•‘æ€¥éšŠ" },
      { "id": "uemachi", "name": "ä¸Šç”ºæ•‘æ€¥éšŠ" },
      { "id": "konan", "name": "ç”²å—æ•‘æ€¥éšŠ" },
      { "id": "yoshino", "name": "å‰é‡æ•‘æ€¥éšŠ" },
      { "id": "yoshida", "name": "å‰ç”°æ•‘æ€¥éšŠ" },
      { "id": "sakurajima_e", "name": "æ¡œå³¶æ±æ•‘æ€¥éšŠ" },
      { "id": "sakurajima_w", "name": "æ¡œå³¶è¥¿æ•‘æ€¥éšŠ" },
      { "id": "nishi", "name": "è¥¿æœ¬ç½²" },
      { "id": "ishiki", "name": "ä¼Šæ•·æ•‘æ€¥éšŠ" },
      { "id": "matsumoto", "name": "æ¾å…ƒæ•‘æ€¥éšŠ" },
      { "id": "koriyama", "name": "éƒ¡å±±æ•‘æ€¥éšŠ" },
      { "id": "minami", "name": "å—æœ¬ç½²" },
      { "id": "taniyama", "name": "è°·å±±æ•‘æ€¥éšŠ" },
      { "id": "taniyama_kita", "name": "è°·å±±åŒ—æ•‘æ€¥éšŠ" },
      { "id": "korimoto", "name": "éƒ¡å…ƒæ•‘æ€¥éšŠ" },
      { "id": "kiire", "name": "å–œå…¥æ•‘æ€¥éšŠ" }
    ];
    const team = emsTeams.find(t => t.id === state.request.ems_team);
    if (team) r += `å…ˆè¡Œæ•‘æ€¥éšŠï¼š${team.name}\n`;
  }
  if(state.request.detail) r += `è¦è«‹å†…å®¹ï¼š${state.request.detail}\n`;
  r += '\n';
  
  // æ‚£è€…æƒ…å ±
  const hasPatientInfo = state.patient?.history || state.patient?.medication || state.patient?.allergy || state.patient?.lastWell || state.patient?.lastMeal || state.patient?.hospital;
  if(hasPatientInfo) {
    r += 'ã€æ‚£è€…æƒ…å ±ã€‘\n';
    if(state.patient.history) r += `æ—¢å¾€æ­´ï¼š${state.patient.history}\n`;
    if(state.patient.medication) r += `å¸¸ç”¨è–¬ï¼š${state.patient.medication}\n`;
    if(state.patient.allergy) r += `ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ï¼š${state.patient.allergy}\n`;
    if(state.patient.lastWell) r += `æœ€çµ‚å¥å¸¸ï¼š${state.patient.lastWell}\n`;
    if(state.patient.lastMeal) r += `æœ€çµ‚é£Ÿäº‹ï¼š${state.patient.lastMeal}\n`;
    if(state.patient.hospital) r += `ã‹ã‹ã‚Šã¤ã‘ï¼š${state.patient.hospital}\n`;
    r += '\n';
  }
  
  r += 'ã€å…ˆè¡Œæ•‘æ€¥éšŠæ´»å‹•ã€‘\n';
  // æ•‘æ€¥éšŠã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
  if(state.ems.aware || state.ems.arrival || state.ems.contact || state.ems.pickup || state.ems.departure || (state.ems.rp && state.car.activity_place === 'RPï¼ˆãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰')) {
    r += 'ï¼œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼\n';
    if(state.ems.aware) r += `è¦šçŸ¥ï¼š${state.ems.aware}\n`;
    if(state.ems.arrival) r += `ç¾ç€ï¼š${state.ems.arrival}\n`;
    if(state.ems.contact) r += `æ¥è§¦ï¼š${state.ems.contact}\n`;
    if(state.ems.pickup) r += `åå®¹ï¼š${state.ems.pickup}\n`;
    if(state.ems.departure) r += `ç¾ç™ºï¼š${state.ems.departure}\n`;
    if(state.ems.rp && state.car.activity_place === 'RPï¼ˆãƒ©ãƒ³ãƒ‡ãƒ–ãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰') r += `RPåˆ°ç€ï¼š${state.ems.rp}\n`;
    r += '\n';
  }
  if(state.ems.vitals.length > 0) {
    r += 'ï¼œãƒã‚¤ã‚¿ãƒ«ï¼\n';
    state.ems.vitals.forEach(v => {
      const gcsV = v.gcs.v === 'T' ? 'T' : v.gcs.v;
      const gcsSum = v.gcs.v === 'T' ? `${v.gcs.e + parseInt(v.gcs.m)}T` : (v.gcs.e + parseInt(v.gcs.v) + parseInt(v.gcs.m));
      const gcs = `E${v.gcs.e}V${gcsV}M${v.gcs.m}(${gcsSum})`;
      const spo2 = v.spo2 === 0 ? 'æ¸¬å®šä¸èƒ½' : `${v.spo2}%`;
      r += `[${v.time}] BP:${v.sbp}/${v.dbp} HR:${v.hr} RR:${v.rr} SpO2:${spo2} BT:${v.bt}â„ƒ GCS:${gcs} JCS:${v.jcs}\n`;
    });
  }
  
  const tab = state.ems.exam_tab;
  if(tab === 'general') {
    r += '\nï¼œæ‰€è¦‹ï¼\n';
    [['é ­é šéƒ¨',EMS_GEN_GROUPS.head,'head'],['å‘¼å¸å™¨',EMS_GEN_GROUPS.resp,'resp'],['å¾ªç’°å™¨',EMS_GEN_GROUPS.card,'card'],['è…¹éƒ¨',EMS_GEN_GROUPS.abd,'abd'],['å››è‚¢',EMS_GEN_GROUPS.limb,'limb'],['ç¥çµŒ',EMS_GEN_GROUPS.neuro,'neuro']].forEach(([title,def,key]) => {
      const s = extractFindings(def, state.ems.chips);
      const m = state.ems.memos?.general?.[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(tab === 'trauma') {
    r += '\nï¼œæ‰€è¦‹ï¼ˆå¤–å‚·ï¼‰ï¼\n';
    [['é ­éƒ¨ãƒ»é¡”é¢',EMS_TRA_GROUPS.head,'head'],['é ¸éƒ¨',EMS_TRA_GROUPS.neck,'neck'],['èƒ¸éƒ¨',EMS_TRA_GROUPS.chest,'chest'],['è…¹éƒ¨',EMS_TRA_GROUPS.abd,'abd'],['éª¨ç›¤',EMS_TRA_GROUPS.pelvis,'pelvis'],['å››è‚¢',EMS_TRA_GROUPS.limb,'limb']].forEach(([title,arr,key]) => {
      const s = extractFindings(arr, state.ems.chips);
      const m = state.ems.memos?.trauma?.[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(tab === 'cpa') {
    r += '\nï¼œæ‰€è¦‹ï¼ˆCPAï¼‰ï¼\n';
    [['åˆæœŸæ³¢å½¢',EMS_CPA_GROUPS.rhythm],['ç›®æ’ƒ/ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼',EMS_CPA_GROUPS.witness],['æ°—é“',EMS_CPA_GROUPS.airway],['å¾ªç’°',EMS_CPA_GROUPS.circulation],['èƒ¸è…¹éƒ¨',EMS_CPA_GROUPS.chest]].forEach(([title,arr]) => {
      const s = extractFindings(arr, state.ems.chips);
      if(s) r += `ã€${title}ã€‘${s}\n`;
    });
    if(state.ems.memos.cpa?.memo) r += `ãƒ¡ãƒ¢ï¼š${state.ems.memos.cpa.memo}\n`;
  } else if(tab === 'stroke') {
    r += '\nï¼œæ‰€è¦‹ï¼ˆè„³å’ä¸­ï¼‰ï¼\n';
    [['æ„è­˜',EMS_STR_GROUPS.conscious],['é¡”é¢ãƒ»ç™ºèª',EMS_STR_GROUPS.face],['é‹å‹•',EMS_STR_GROUPS.motor],['ãã®ä»–',EMS_STR_GROUPS.other]].forEach(([title,arr]) => {
      const s = extractFindings(arr, state.ems.chips);
      if(s) r += `ã€${title}ã€‘${s}\n`;
    });
    if(state.ems.stroke_onset) r += `ç™ºç—‡æ™‚åˆ»ï¼š${state.ems.stroke_onset}\n`;
    if(state.ems.memos.stroke?.memo) r += `ãƒ¡ãƒ¢ï¼š${state.ems.memos.stroke.memo}\n`;
  }
  
  const emsProc = state.ems.procedures_items.filter(k => state.ems.procedures[k]);
  if(emsProc.length > 0 || state.ems.procedures_detail) {
    r += '\nï¼œå‡¦ç½®ï¼\n';
    if(emsProc.length > 0) r += emsProc.map(p => p === 'é…¸ç´ æŠ•ä¸' && state.ems.procedures['é…¸ç´ æŠ•ä¸'] && state.ems.o2_flow ? `${p}(${state.ems.o2_flow})` : p).join('ã€') + '\n';
    if(state.ems.procedures_detail) r += state.ems.procedures_detail + '\n';
  }
  r += '\n';
  
  r += 'ã€ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ æ´»å‹•ã€‘\n';
  // ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
  if(state.car.request_time || state.car.departure || state.car.scene_arrival || state.car.cardr_contact || state.car.activity_place) {
    r += 'ï¼œã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼\n';
    if(state.car.request_time) r += `è¦è«‹æ™‚åˆ»ï¼š${state.car.request_time}\n`;
    if(state.car.departure) r += `ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼å‡ºå‹•ï¼š${state.car.departure}\n`;
    if(state.car.scene_arrival) r += `ç¾å ´/RPåˆ°ç€ï¼š${state.car.scene_arrival}\n`;
    if(state.car.cardr_contact) r += `ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒ æ¥è§¦ï¼š${state.car.cardr_contact}\n`;
    if(state.car.activity_place) r += `æ´»å‹•å ´æ‰€ï¼š${state.car.activity_place}\n`;
    r += '\n';
  }
  
  if(state.cardr.vitals.length > 0) {
    r += 'ï¼œãƒã‚¤ã‚¿ãƒ«ï¼\n';
    state.cardr.vitals.forEach(v => {
      const gcsV = v.gcs.v === 'T' ? 'T' : v.gcs.v;
      const gcsSum = v.gcs.v === 'T' ? `${v.gcs.e + parseInt(v.gcs.m)}T` : (v.gcs.e + parseInt(v.gcs.v) + parseInt(v.gcs.m));
      const gcs = `E${v.gcs.e}V${gcsV}M${v.gcs.m}(${gcsSum})`;
      const spo2 = v.spo2 === 0 ? 'æ¸¬å®šä¸èƒ½' : `${v.spo2}%`;
      r += `[${v.time}] BP:${v.sbp}/${v.dbp} HR:${v.hr} RR:${v.rr} SpO2:${spo2} BT:${v.bt}â„ƒ GCS:${gcs} JCS:${v.jcs}\n`;
    });
  }
  
  const cardrTab = state.cardr.exam_tab;
  if(cardrTab === 'general') {
    r += '\nï¼œèº«ä½“æ‰€è¦‹ï¼\n';
    [['é ­é šéƒ¨',CARDR_GEN_GROUPS.head,'head'],['å‘¼å¸å™¨',CARDR_GEN_GROUPS.resp,'resp'],['å¾ªç’°å™¨',CARDR_GEN_GROUPS.card,'card'],['è…¹éƒ¨',CARDR_GEN_GROUPS.abd,'abd'],['å››è‚¢',CARDR_GEN_GROUPS.limb,'limb'],['ç¥çµŒ',CARDR_GEN_GROUPS.neuro,'neuro']].forEach(([title,def,key]) => {
      const s = extractFindings(def, state.cardr.chips);
      const m = state.cardr.memos?.general?.[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(cardrTab === 'trauma') {
    r += '\nï¼œèº«ä½“æ‰€è¦‹ï¼ˆå¤–å‚·ï¼‰ï¼\n';
    [['é ­éƒ¨ãƒ»é¡”é¢',CARDR_TRA_GROUPS.head,'head'],['é ¸éƒ¨',CARDR_TRA_GROUPS.neck,'neck'],['èƒ¸éƒ¨',CARDR_TRA_GROUPS.chest,'chest'],['è…¹éƒ¨',CARDR_TRA_GROUPS.abd,'abd'],['éª¨ç›¤',CARDR_TRA_GROUPS.pelvis,'pelvis'],['å››è‚¢',CARDR_TRA_GROUPS.limb,'limb']].forEach(([title,arr,key]) => {
      const s = extractFindings(arr, state.cardr.chips);
      const m = state.cardr.memos?.trauma?.[key];
      if(s || m) r += `ã€${title}ã€‘${[s,m].filter(Boolean).join('ã€‚')}\n`;
    });
  } else if(cardrTab === 'stroke') {
    r += '\nï¼œèº«ä½“æ‰€è¦‹ï¼ˆè„³å’ä¸­ï¼‰ï¼\n';
    
    // è„³ç¥çµŒæ‰€è¦‹ãƒãƒƒãƒ—
    const cnFindings = extractFindings(CARDR_STR_GROUPS.cn, state.cardr.chips);
    const cnMemo = state.cardr.memos?.stroke?.cn || '';
    if(cnFindings || cnMemo) r += `ã€è„³ç¥çµŒã€‘${[cnFindings, cnMemo].filter(Boolean).join('ã€‚')}\n`;
    
    // ç³å­”ãƒ»çœ¼çƒ
    const str = state.cardr.stroke || {};
    let eyeFindings = [];
    if(str.pupilL || str.pupilR) eyeFindings.push(`ç³å­”å¾„ L:${str.pupilL ?? '-'}mm R:${str.pupilR ?? '-'}mm`);
    if(str.plrL || str.plrR) eyeFindings.push(`å¯¾å…‰åå°„ L:${str.plrL || '-'} R:${str.plrR || '-'}`);
    if(str.gaze) eyeFindings.push(`å…±åŒåè¦–:${str.gaze}`);
    if(str.nyst) eyeFindings.push(`çœ¼æŒ¯:${str.nyst}`);
    if(eyeFindings.length > 0) r += `ã€ç³å­”ãƒ»çœ¼ã€‘${eyeFindings.join('ã€')}\n`;
    
    // MMT
    if(str.mmt) {
      r += `ã€é‹å‹•MMTã€‘å³ä¸Šè‚¢:${str.mmt.ru ?? 5} å·¦ä¸Šè‚¢:${str.mmt.lu ?? 5} å³ä¸‹è‚¢:${str.mmt.rl ?? 5} å·¦ä¸‹è‚¢:${str.mmt.ll ?? 5}\n`;
    }
    
    // åå°„
    let reflexFindings = [];
    if(str.btr) reflexFindings.push(`BTR:${str.btr}`);
    if(str.ptr) reflexFindings.push(`PTR:${str.ptr}`);
    if(str.babinski) reflexFindings.push('Babinskié™½æ€§');
    if(str.chaddock) reflexFindings.push('Chaddocké™½æ€§');
    if(reflexFindings.length > 0) r += `ã€åå°„ã€‘${reflexFindings.join('ã€')}\n`;
    
    // é«˜æ¬¡è„³æ©Ÿèƒ½
    const higherFindings = extractFindings(CARDR_STR_GROUPS.higher, state.cardr.chips);
    const higherMemo = state.cardr.memos?.stroke?.higher || '';
    if(higherFindings || higherMemo) r += `ã€é«˜æ¬¡è„³æ©Ÿèƒ½ã€‘${[higherFindings, higherMemo].filter(Boolean).join('ã€‚')}\n`;
    
    // NIHSS
    if(str.nihss && Object.keys(str.nihss).length > 0) {
      let nihssSum = 0;
      NIHSS_ITEMS.forEach(item => nihssSum += str.nihss[item.id] || 0);
      r += `ã€NIHSSã€‘${nihssSum}ç‚¹\n`;
      if(str.nihssMemo) r += `NIHSSãƒ¡ãƒ¢ï¼š${str.nihssMemo}\n`;
    }
  } else if(cardrTab === 'cpa') {
    r += '\nï¼œCPAè¨˜éŒ²ï¼\n';
    if(state.cardr.cpaEvents && state.cardr.cpaEvents.length > 0) {
      state.cardr.cpaEvents.forEach((cpa, idx) => {
        if(state.cardr.cpaEvents.length > 1) r += `\nã€å¿ƒåœæ­¢ã‚¤ãƒ™ãƒ³ãƒˆ ${idx + 1}${idx > 0 ? 'ï¼ˆå†å¿ƒåœæ­¢ï¼‰' : ''}ã€‘\n`;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆ1ï¼ˆåˆå›ï¼‰ã®å ´åˆ
        if(idx === 0) {
          if(cpa.arrestTime) r += `å¿ƒåœæ­¢æ™‚åˆ»ï¼š${cpa.arrestTime}\n`;
          if(cpa.rhythm) r += `åˆæœŸæ³¢å½¢ï¼š${cpa.rhythm}\n`;
          r += `ç›®æ’ƒï¼š${cpa.witnessed ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
          r += `ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼CPRï¼š${cpa.bystander ? 'ã‚ã‚Š' : 'ãªã—'}\n`;
          if(cpa.cprStart) r += `èƒ¸éª¨åœ§è¿«é–‹å§‹ï¼š${cpa.cprStart}\n`;
          if(cpa.ivTime) r += `æœ«æ¢¢ç¢ºä¿ï¼š${cpa.ivTime}\n`;
          if(cpa.adrenalineTimes && cpa.adrenalineTimes.length > 0) {
            r += `ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸ï¼š${cpa.adrenalineTimes.map((t,i) => `${i+1}å›ç›® ${t}`).join('ã€')}\n`;
          }
          if(cpa.lt) r += `LTæŒ¿å…¥ï¼šå®Ÿæ–½\n`;
          if(cpa.intubation) r += `æ°—ç®¡æŒ¿ç®¡ï¼š${state.cardr.procedures['æ°—ç®¡æŒ¿ç®¡'] ? (state.cardr.intubation.time || 'å®Ÿæ–½') + ' (' + state.cardr.intubation.size + 'mm)' : 'å®Ÿæ–½'}\n`;
          if(cpa.pericardio) r += `å¿ƒè†œè…”ç©¿åˆºï¼š${cpa.pericardioTime || 'å®Ÿæ–½'}\n`;
          if(cpa.roscTime) r += `å¿ƒæ‹å†é–‹(ROSC)ï¼š${cpa.roscTime}\n`;
          
          // Flow Timeè¨ˆç®—
          if(cpa.arrestTime && cpa.cprStart) {
            const noFlow = calcTimeDiffMinutes(cpa.arrestTime, cprStart);
            if(noFlow >= 0) r += `No Flow Timeï¼š${noFlow}åˆ†\n`;
          }
          if(cpa.cprStart && cpa.roscTime) {
            const lowFlow = calcTimeDiffMinutes(cprStart, cpa.roscTime);
            if(lowFlow >= 0) r += `Low Flow Timeï¼š${lowFlow}åˆ†\n`;
          }
        } else {
          // ã‚¤ãƒ™ãƒ³ãƒˆ2ä»¥é™ï¼ˆå†å¿ƒåœæ­¢ï¼‰ã®å ´åˆ
          if(cpa.arrestTime) r += `å¿ƒåœæ­¢æ™‚åˆ»ï¼š${cpa.arrestTime}\n`;
          if(cpa.rhythm) r += `æ³¢å½¢ï¼š${cpa.rhythm}\n`;
          if(cpa.adrenalineTimes && cpa.adrenalineTimes.length > 0) {
            r += `ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³æŠ•ä¸ï¼š${cpa.adrenalineTimes.map((t,i) => `${i+1}å›ç›® ${t}`).join('ã€')}\n`;
          }
          if(cpa.roscTime) r += `å¿ƒæ‹å†é–‹(ROSC)ï¼š${cpa.roscTime}\n`;
          
          // Low Flow Time = å¿ƒåœæ­¢ã‹ã‚‰ROSCã¾ã§
          if(cpa.arrestTime && cpa.roscTime) {
            const lowFlow = calcTimeDiffMinutes(cpa.arrestTime, cpa.roscTime);
            if(lowFlow >= 0) r += `Low Flow Timeï¼š${lowFlow}åˆ†\n`;
          }
        }
        
        if(cpa.memo) r += `ãƒ¡ãƒ¢ï¼š${cpa.memo}\n`;
      });
    } else {
      r += 'ãƒ‡ãƒ¼ã‚¿ãªã—\n';
    }
  }
  
  if((state.cardr.exams?.bs && state.cardr.bs) || state.cardr.abg_type || Object.values(state.cardr.exams || {}).some(v=>v) || state.cardr.exam_detail) {
    r += '\nï¼œæ¤œæŸ»ï¼\n';
    if(state.cardr.exams?.bs && state.cardr.bs) r += `è¡€ç³–ï¼š${state.cardr.bs} mg/dL\n`;
    if(state.cardr.abg_type && state.cardr.abg_type !== '') {
      r += `è¡€ã‚¬ã‚¹ï¼š${state.cardr.abg_type}\n`;
      if(state.cardr.abg_data.length > 0) {
        r += state.cardr.abg_data.filter(x=>x.val).map(x => `${x.item} ${x.val}${x.unit}`).join(', ') + '\n';
      }
    }
    ['ucg','us_abd','us_lung','us_neck','ecg','fast','efast'].forEach(t => {
      if(state.cardr.exams[t] && state.cardr.exam_texts[t]) {
        const labels = {ucg:'UCG',us_abd:'è…¹éƒ¨US',us_lung:'è‚ºUS',us_neck:'é ¸éƒ¨è¡€ç®¡US',ecg:'12èª˜å°å¿ƒé›»å›³',fast:'FAST',efast:'eFAST'};
        r += `${labels[t]}ï¼š${state.cardr.exam_texts[t]}\n`;
      }
    });
    if(state.cardr.exam_detail) r += state.cardr.exam_detail + '\n';
  }
  
  const cardrProc = state.cardr.procedures_items.filter(k => state.cardr.procedures[k]);
  if(cardrProc.length > 0 || state.cardr.procedure_detail) {
    r += '\nï¼œå‡¦ç½®ï¼\n';
    if(cardrProc.length > 0) {
      const procWithDetails = cardrProc.map(p => {
        if(p === 'æ°—ç®¡æŒ¿ç®¡' && state.cardr.procedures['æ°—ç®¡æŒ¿ç®¡'] && state.cardr.intubation?.time) {
          return `${p}(${state.cardr.intubation.time}ã€${state.cardr.intubation.size}mm)`;
        }
        return p;
      });
      r += procWithDetails.join('ã€') + '\n';
    }
    if(state.cardr.procedure_detail) r += state.cardr.procedure_detail + '\n';
  }
  
  const cardrDrugs = state.cardr.drugs_items.filter(k => state.cardr.drugs[k]);
  if(cardrDrugs.length > 0 || state.cardr.drug_detail) {
    r += '\nï¼œè–¬å‰¤ï¼\n';
    if(cardrDrugs.length > 0) {
      const drugsWithDetails = cardrDrugs.map(d => {
        if(['ç”Ÿé£Ÿ', 'ã‚½ãƒ«ã‚¢ã‚»ãƒˆF', 'ãƒ–ãƒ‰ã‚¦ç³–æ¶²'].includes(d) && state.cardr.drugs[d]) {
             // ç‚¹æ»´ãƒ»è¼¸æ¶²ã®å ´åˆ
             const detail = state.cardr.drug_details[d]?.[0];
             return detail ? `${d}(${detail.time}ã€é–‹å§‹)` : `${d}ï¼ˆé–‹å§‹ï¼‰`;
        }
        
        if(state.cardr.drugs[d] && state.cardr.drug_details && state.cardr.drug_details[d]) {
          const details = state.cardr.drug_details[d];
          if(details.length > 1) {
            // è¤‡æ•°å›æŠ•ä¸ã®å ´åˆã€è©³ç´°ã‚’åˆ—æŒ™
            return `${d}ï¼š${details.map(det => `${det.time} (${det.amount}mg)`).join('ã€')}`;
          } else if (details.length === 1) {
            // 1å›æŠ•ä¸ã®å ´åˆ
            return `${d}(${details[0].time}ã€${details[0].amount}mg)`;
          }
        }
        return d;
      });
      r += drugsWithDetails.filter(Boolean).join('ã€') + '\n';
    }
    if(state.cardr.drug_detail) r += state.cardr.drug_detail + '\n';
  }
  r += '\n';
  
  r += 'ã€è©•ä¾¡ã€‘\n';
  if(state.problems.length > 0) {
    r += 'ï¼œãƒ—ãƒ­ãƒ–ãƒ¬ãƒ ï¼\n';
    state.problems.forEach((p, i) => r += `#${i+1} ${p}\n`);
  }
  if(state.consideration) r += `ï¼œè€ƒå¯Ÿï¼\n${state.consideration}\n`;
  if(state.triage !== null) {
    r += `JTAS${state.triage}\n`;
  }
  if(state.severity !== null) {
    r += `NACA${state.severity}\n`;
  }
  r += '\n';
  
  r += 'ã€æ¬é€å…ˆã€‘\n';
  const hospitalName = state.destination.custom || state.destination.hospital || 'ï¼ˆæœªé¸æŠï¼‰';
  r += `åŒ»ç™‚æ©Ÿé–¢ï¼š${hospitalName}\n`;
  if(state.destination.reason) r += `é¸å®šç†ç”±ï¼š${state.destination.reason}\n`;
  // æ¬é€æ–¹æ³•ã‹ã‚‰ç—…é™¢ç€ã¾ã§ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æƒ…å ±
  if(state.car.transport_method || state.car.scene_departure || state.car.hospital_arrival) {
    r += `æ¬é€æ–¹æ³•ï¼š${state.car.transport_method || 'ï¼ˆæœªé¸æŠï¼‰'}\n`;
    // Iã‚¿ãƒ¼ãƒ³ä»¥å¤–ã¯ç¾å ´å‡ºç™ºã¨ç—…é™¢ç€ã‚’è¨˜è¼‰
    if(state.car.transport_method !== 'Iã‚¿ãƒ¼ãƒ³') {
      if(state.car.scene_departure) r += `ç¾å ´å‡ºç™ºï¼š${state.car.scene_departure}\n`;
      if(state.car.hospital_arrival) r += `ç—…é™¢ç€ï¼š${state.car.hospital_arrival}\n`;
    }
  }
  r += '\n';
  
  // ç—‡çŠ¶è©³è¨˜
  if(state.symptom_detail) {
    r += 'ã€å‘¼å¸å¾ªç’°ç›£è¦–ã€€è©³è¨˜ã€‘\n';
    r += state.symptom_detail + '\n';
  }
  
  r += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  r += 'è¨˜éŒ²ä½œæˆï¼š' + new Date().toLocaleString('ja-JP') + '\n';
  
  return r;
}

// ä¿å­˜ãƒ»èª­è¾¼é–¢æ•°ç¾¤ (å¤‰æ›´ãªã—)
window.saveData = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼è¨˜éŒ²_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
};

window.loadData = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = e => {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const loadedState = JSON.parse(ev.target.result);
          
          // äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã¨ç§»è¡Œ
          if(loadedState.heli && !loadedState.car) loadedState.car = loadedState.heli;
          if(loadedState.ems?.lz && !loadedState.ems.rp) loadedState.ems.rp = loadedState.ems.lz;
          if(loadedState.fd && !loadedState.cardr) loadedState.cardr = loadedState.fd;
          if(loadedState.car?.fd_contact && !loadedState.car.cardr_contact) loadedState.car.cardr_contact = loadedState.car.fd_contact;
          
          state = loadedState;

          // ãƒ­ãƒ¼ãƒ‰å¾Œã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å …ç‰¢åŒ– (æœ€æ–°ã®ãƒã‚¹ã‚¿å®šç¾©ã‚’é©ç”¨)
          initializeStateDataStructure();
          
          restoreUI();
        } catch(err) { 
          alert('èª­è¾¼ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚'); 
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
};

// ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
window.reloadApp = () => {
  if(!confirm('ã‚¢ãƒ—ãƒªã‚’æœ€æ–°ç‰ˆã«æ›´æ–°ã—ã¾ã™ã‹ï¼Ÿ\n\nå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™ãŒã€ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚')) return;
  
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰
  // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å›é¿
  const url = new URL(window.location.href);
  url.searchParams.set('_t', Date.now());
  window.location.href = url.toString();
};

window.resetData = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  if(!confirm('ã™ã¹ã¦ã®å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
  
  localStorage.removeItem('doctorCarV1');
  
  state = {
    request: {type:'', detail:'', age:'', sex:'', ems_team:'', content:''},
    patient: {history:'', medication:'', allergy:'', lastWell:'', lastMeal:'', hospital:'', history_chips:{}, anticoagulant:'', anticoagulant_drugs:[], antiplatelet:'', antiplatelet_drugs:[], food_allergy:'', drug_allergy:''},
    car: {request_time:'', departure:'', scene_arrival:'', cardr_contact:'', activity_place:'', scene_departure:'', hospital_arrival:'', transport_method:'Uã‚¿ãƒ¼ãƒ³'},
    ems: {
      request_time:'', aware:'', arrival:'', contact:'', rp:'',
      vitals: [],
      exam_tab: 'general',
      chips: {},
      memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{memo:''},cpa:{memo:''}},
      stroke_onset: '',
      procedures: {},
      procedures_items: ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ãƒ–ãƒ‰ã‚¦ç³–æŠ•ä¸','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'],
      o2_flow:'', procedures_detail:''
    },
    cardr: {
      vitals: [],
      exam_tab: 'general',
      chips: {},
      memos: {general:{head:'',resp:'',card:'',abd:'',limb:'',neuro:''},trauma:{head:'',neck:'',chest:'',abd:'',pelvis:'',limb:''},stroke:{neuro:'',motor:'',eye:'',higher:''},cpa:{body:'',head:'',trunk:''}},
      exams: {bs:false, ucg:false, us_abd:false, us_lung:false, us_neck:false, ecg:false, fast:false, efast:false},
      exam_texts: {ucg:'', us_abd:'', us_lung:'', us_neck:'', ecg:'', fast:'', efast:''},
      bs:120, abg_type:'', abg_data: [], exam_detail:'',
      cpaEvents: [],
      stroke: {
        pupilL:3.0, pupilR:3.0, plrL:'', plrR:'', gaze:'', nyst:'',
        mmt:{ru:5, lu:5, rl:5, ll:5},
        btr:'', ptr:'', babinski:false, chaddock:false,
        nihss:{}, nihssMemo:''
      },
      procedures: {},
      procedures_items: ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'],
      procedure_detail:'',
      drugs: {},
      drugs_items: ['ç”Ÿé£Ÿ','ã‚½ãƒ«ã‚¢ã‚»ãƒˆF','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ­ã‚¯ãƒ­ãƒ‹ã‚¦ãƒ ','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹','ãƒ–ãƒ‰ã‚¦ç³–æ¶²'],
      drug_detail:'',
      intubation: {time: '', size: '7.0'},
      drug_details: {}
    },
    problems: [],
    consideration: '',
    destination: {hospital:'', custom:'', reason:''},
    hospitals: {
      'é¹¿å…å³¶å¸‚': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','å—é¢¨ç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢']
    }
  };
  
  location.reload();
};

function restoreUI() {
  // HTMLè¦ç´ ã¸ã®å€¤ã®å¾©å…ƒ
  $('#request_type').value = state.request.type || '';
  // è¦è«‹å†…å®¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã‚’ä½¿ç”¨ã€ãã†ã§ãªã‘ã‚Œã°æ—¢å­˜ã®detailã‚’ä½¿ç”¨
  if (state.request.content) {
    $('#request_detail').value = state.request.content;
  } else {
    $('#request_detail').value = state.request.detail || '';
  }
  $('#cardr_request_time').value = state.car.request_time || '';
  $('#patient_history').value = state.patient?.history || '';
  // æ—¢å¾€æ­´ãƒãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸã—ã¦å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  syncHistoryChipsFromText();
  renderHistoryChips();
  $('#patient_medication').value = state.patient?.medication || '';
  // å¸¸ç”¨è–¬ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (!state.patient.anticoagulant) state.patient.anticoagulant = '';
  if (!state.patient.antiplatelet) state.patient.antiplatelet = '';
  if (!state.patient.anticoagulant_drugs) state.patient.anticoagulant_drugs = [];
  if (!state.patient.antiplatelet_drugs) state.patient.antiplatelet_drugs = [];
  renderMedicationChips();
  $('#patient_allergy').value = state.patient?.allergy || '';
  // ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (!state.patient.food_allergy) state.patient.food_allergy = '';
  if (!state.patient.drug_allergy) state.patient.drug_allergy = '';
  renderAllergyChips();
  // è¦è«‹æƒ…å ±ãƒãƒƒãƒ—ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  if (!state.request.age) state.request.age = '';
  if (!state.request.sex) state.request.sex = '';
  if (!state.request.ems_team) state.request.ems_team = '';
  if (!state.request.content) state.request.content = '';
  renderRequestInfoChips();
  renderRequestContentChips();
  $('#last_well_time').value = state.patient?.lastWell || '';
  $('#last_meal_time').value = state.patient?.lastMeal || '';
  $('#patient_hospital').value = state.patient?.hospital || '';
  $('#car_departure').value = state.car?.departure || '';
  $('#scene_arrival').value = state.car?.scene_arrival || '';
  $('#cardr_contact').value = state.car?.cardr_contact || ''; 
  $('#activity_place').value = state.car?.activity_place || '';
  if($('#transport_method')) {
    $('#transport_method').value = state.car?.transport_method || 'Uã‚¿ãƒ¼ãƒ³';
    toggleTransportTimes();
  }
  $('#scene_departure').value = state.car?.scene_departure || '';
  $('#hospital_arrival').value = state.car?.hospital_arrival || '';
  $('#ems_aware').value = state.ems.aware || '';
  $('#ems_arrival').value = state.ems.arrival || '';
  $('#ems_contact').value = state.ems.contact || '';
  $('#ems_pickup').value = state.ems.pickup || '';
  $('#ems_departure').value = state.ems.departure || '';
  $('#ems_rp').value = state.ems.rp || ''; 
  if($('#ems_o2_flow')) $('#ems_o2_flow').value = state.ems.o2_flow || '';
  $('#ems_procedures_detail').value = state.ems.procedures_detail || '';
  if($('#ems_stroke_onset')) $('#ems_stroke_onset').value = state.ems.stroke_onset || '';
  
  $('#cardr_bs').value = state.cardr.bs || 120; 
  $('#cardr_bs_display').textContent = state.cardr.bs || 120;
  
  const abgTypeEl = $('#cardr_abg_type');
  if (abgTypeEl) abgTypeEl.value = state.cardr.abg_type || ''; 
  const abgAreaEl = $('#abg_area');
  const isAbgSelected = state.cardr.abg_type === 'ABG' || state.cardr.abg_type === 'VBG';
  if (abgAreaEl) abgAreaEl.style.display = isAbgSelected ? 'block' : 'none';

  // æ¤œæŸ»ãƒãƒƒãƒ—ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
  renderExamChips();
  
  const examBsAreaEl = $('#exam_bs_area');
  if (examBsAreaEl) examBsAreaEl.style.display = state.cardr.exams?.bs ? 'block' : 'none';
  
  ['ucg','us_abd','us_lung','us_neck','ecg','fast','efast'].forEach(t => {
    const txtEl = $(`#exam_${t}_txt`);
    if (txtEl) {
      txtEl.style.display = state.cardr.exams[t] ? 'block' : 'none';
      txtEl.value = state.cardr.exam_texts[t] || '';
    }
  });
  $('#cardr_exam_detail').value = state.cardr.exam_detail || ''; 
  $('#cardr_procedure_detail').value = state.cardr.procedure_detail || ''; 
  $('#cardr_drug_detail').value = state.cardr.drug_detail || ''; 
  
  // CPAæƒ…å ±å¾©å…ƒ
  renderCpaEvents();
  
  // è„³å’ä¸­æƒ…å ±å¾©å…ƒ
  if(state.cardr.stroke && $('#plrL')) {
    $('#pupilL_display').textContent = state.cardr.stroke.pupilL?.toFixed(1) || '3.0';
    $('#pupilR_display').textContent = state.cardr.stroke.pupilR?.toFixed(1) || '3.0';
    $('#plrL').value = state.cardr.stroke.plrL || '';
    $('#plrR').value = state.cardr.stroke.plrR || '';
    $('#str_gaze').value = state.cardr.stroke.gaze || '';
    $('#str_nyst').value = state.cardr.stroke.nyst || '';
    if(state.cardr.stroke.mmt) {
      $('#mmt_ru_display').textContent = state.cardr.stroke.mmt.ru ?? 5;
      $('#mmt_lu_display').textContent = state.cardr.stroke.mmt.lu ?? 5;
      $('#mmt_rl_display').textContent = state.cardr.stroke.mmt.rl ?? 5;
      $('#mmt_ll_display').textContent = state.cardr.stroke.mmt.ll ?? 5;
    }
    $('#str_btr').value = state.cardr.stroke.btr || '';
    $('#str_ptr').value = state.cardr.stroke.ptr || '';
    $('#str_babinski').checked = state.cardr.stroke.babinski || false;
    $('#str_chaddock').checked = state.cardr.stroke.chaddock || false;
    if($('#nihss_memo')) $('#nihss_memo').value = state.cardr.stroke.nihssMemo || '';
    renderNihss();
  }
  
  $('#consideration').value = state.consideration || '';
  $('#outputReason').value = state.symptom_detail || '';
  // ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã¨é‡ç—‡åº¦åˆ†é¡ã®åˆæœŸåŒ–
  if (state.triage === undefined) state.triage = null;
  if (state.severity === undefined) state.severity = null;
  renderTriageChips();
  renderSeverityChips();
  $('#destination_custom').value = state.destination.custom || '';
  $('#selection_reason').value = state.destination.reason || '';
  
  // å„ç¨®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨ãƒã‚¤ãƒ³ãƒ‰
  renderEmsVitals();
  renderCarDrVitals();
  renderProcedureChips('ems_procedures', state.ems.procedures_items, state.ems.procedures);
  renderProcedureChips('cardr_procedures', state.cardr.procedures_items, state.cardr.procedures); 
  renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs); 
  renderExamChips();
  renderAbgPills();
  renderProblems();
  renderHospitalChips();
  bindMemos();
  
  // èº«ä½“æ‰€è¦‹ã‚¿ãƒ–ã®å¾©å…ƒ
  if (state.cardr && state.cardr.exam_tab) {
    const examTab = $(`#cardr_examTabs .exam-tab[data-exam="${state.cardr.exam_tab}"]`);
    if (examTab) {
      $$('#cardr_examTabs .exam-tab').forEach(t => t.classList.remove('active'));
      examTab.classList.add('active');
      const card = examTab.closest('.card');
      if (card) {
        card.querySelectorAll('.exam-pane').forEach(p => p.classList.remove('active'));
        const pane = card.querySelector(`.exam-pane[data-pane="${state.cardr.exam_tab}"]`);
        if (pane) pane.classList.add('active');
      }
    }
  }
  
  // EMSèº«ä½“æ‰€è¦‹ã‚¿ãƒ–ã®å¾©å…ƒ
  if (state.ems && state.ems.exam_tab) {
    const examTab = $(`#ems_examTabs .exam-tab[data-exam="${state.ems.exam_tab}"]`);
    if (examTab) {
      $$('#ems_examTabs .exam-tab').forEach(t => t.classList.remove('active'));
      examTab.classList.add('active');
      const card = examTab.closest('.card');
      if (card) {
        card.querySelectorAll('.exam-pane').forEach(p => p.classList.remove('active'));
        const pane = card.querySelector(`.exam-pane[data-pane="${state.ems.exam_tab}"]`);
        if (pane) pane.classList.add('active');
      }
    }
  }
  
  if(state.ems.procedures['é…¸ç´ æŠ•ä¸']) {
    const o2AmountEl = $('#ems_o2_amount');
    if (o2AmountEl) {
      o2AmountEl.style.display = 'block';
      const o2FlowEl = $('#o2_flow_display');
      if(o2FlowEl) o2FlowEl.textContent = state.ems.o2_flow || 'ï¼';
    }
  }
  
  render();
}

/**
 * çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ä¸è¶³ã—ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’åˆæœŸåŒ–ã™ã‚‹
 */
function initializeStateDataStructure() {
    // ãƒã‚¹ã‚¿ã‚’æ›´æ–°
    state.hospitals = {
      'é¹¿å…å³¶å¸‚': ['é¹¿å…å³¶å¸‚ç«‹ç—…é™¢','é¹¿å…å³¶å¤§å­¦ç—…é™¢','é¹¿å…å³¶åŒ»ç™‚ã‚»ãƒ³ã‚¿ãƒ¼','ç±³ç››ç—…é™¢','ã„ã¾ãã„ã‚Œç·åˆç—…é™¢','ä»Šæ‘ç·åˆç—…é™¢','ä¸­å¤®ç—…é™¢','é¹¿å…å³¶å¾³æ´²ä¼šç—…é™¢','å—é¢¨ç—…é™¢','é¹¿å…å³¶ç”Ÿå”ç—…é™¢','åšåœ°è„³ç¥çµŒå¤–ç§‘ç—…é™¢','æ± ç”°ç—…é™¢','ã„ã˜ã‚…ã†ã„ã‚“è„³ç¥çµŒå¤–ç§‘','ä¸Šç”ºã„ã¾ãã„ã‚Œç—…é™¢','ã„ã¥ã‚ä»Šæ‘ç—…é™¢','å²©å°¾ç—…é™¢','æ¤æ‘ç—…é™¢','å¤§å‹ç—…é™¢','å°ç”°ä»£ç—…é™¢','é¹¿å…å³¶åšç”Ÿé€£ç—…é™¢','é¹¿å…å³¶ã“ã©ã‚‚ç—…é™¢','é¹¿å…å³¶å¸‚åŒ»å¸«ä¼šç—…é™¢','é¹¿å…å³¶èµ¤åå­—ç—…é™¢','æ²³äº•è„³ç¥çµŒå¤–ç§‘','ã‹ã‚ã¯ã‚‰è„³ç¥çµŒå¤–ç§‘ã‚¯ãƒªãƒ‹ãƒƒã‚¯','æœ¨æ‘å¤–ç§‘å†…ç§‘','å…±ç«‹ç—…é™¢','ã‚­ãƒ©ãƒ¡ã‚­ãƒ†ãƒ©ã‚¹ãƒ˜ãƒ«ã‚¹ã‚±ã‚¢ãƒ›ã‚¹ãƒ”ã‚¿ãƒ«','é¦¬å ´ç—…é™¢','å¥ç¿”ä¼šç—…é™¢','æ¸ˆç”Ÿä¼šé¹¿å…å³¶ç—…é™¢','æ¡œå³¶ç—…é™¢','ä¸‰æ„›ç—…é™¢','æ–°æˆç—…é™¢','è±Šå³¶ç—…é™¢','ä¸­é‡è„³ç¥çµŒå¤–ç§‘','æ–°æ‘ç—…é™¢','æ—å†…ç§‘èƒƒè…¸ç§‘ç—…é™¢','æ—¥é«˜ç—…é™¢','å¢—ç”°æ•´å½¢å¤–ç§‘ç—…é™¢','ä¸‰èˆ¹ç—…é™¢','ä¸‰å®…ç—…é™¢','ã¿ã‚‰ã„ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç—…é™¢']
    };
    state.ems.procedures_items = ['é šæ¤ã‚«ãƒ©ãƒ¼','å…¨èº«å›ºå®š','å¸å¼•','é…¸ç´ æŠ•ä¸','BVMæ›æ°—','æ°—ç®¡æŒ¿ç®¡','LTæŒ¿å…¥','é™è„ˆè·¯ç¢ºä¿','ãƒ–ãƒ‰ã‚¦ç³–æŠ•ä¸','ã‚·ãƒ§ãƒƒã‚¯è¼¸æ¶²','åœ§è¿«æ­¢è¡€','èƒ¸éª¨åœ§è¿«','LUCASè£…ç€','é™¤ç´°å‹•','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³'];
    state.cardr.procedures_items = ['é…¸ç´ æŠ•ä¸','BVM','æ°—ç®¡æŒ¿ç®¡','èƒ¸è…”ãƒ‰ãƒ¬ãƒŠãƒ¼ã‚¸','é–‹èƒ¸','è¼¸æ¶²','è¼¸è¡€','éª¨ç›¤å›ºå®š','æ­¢è¡€å‡¦ç½®','CPR','é™¤ç´°å‹•','çµŒçš®ãƒšãƒ¼ã‚·ãƒ³ã‚°'];
    state.cardr.drugs_items = ['ç”Ÿé£Ÿ','ã‚½ãƒ«ã‚¢ã‚»ãƒˆF','ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³','ãƒŸãƒ€ã‚¾ãƒ©ãƒ ','ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ','ã‚¢ãƒˆãƒ­ãƒ”ãƒ³','ãƒ­ã‚¯ãƒ­ãƒ‹ã‚¦ãƒ ','ãƒ¡ã‚¤ãƒ­ãƒ³','ãƒ¬ãƒšã‚¿ãƒ³','ãƒˆãƒ©ãƒ³ã‚µãƒŸãƒ³','ã‚¢ã‚»ãƒªã‚ª','ãƒ¡ãƒˆã‚¯ãƒ­ãƒ—ãƒ©ãƒŸãƒ‰','ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹','ãƒ–ãƒ‰ã‚¦ç³–æ¶²'];

    // ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–
    if (!state.request.age) state.request.age = '';
    if (!state.request.sex) state.request.sex = '';
    if (!state.request.ems_team) state.request.ems_team = '';
    if (!state.patient.history_chips) state.patient.history_chips = {};
    if (!state.patient.anticoagulant) state.patient.anticoagulant = '';
    if (!state.patient.antiplatelet) state.patient.antiplatelet = '';
    if (!state.patient.anticoagulant_drugs) state.patient.anticoagulant_drugs = [];
    if (!state.patient.antiplatelet_drugs) state.patient.antiplatelet_drugs = [];
    if (!state.patient.food_allergy) state.patient.food_allergy = '';
    if (!state.patient.drug_allergy) state.patient.drug_allergy = '';
    if (!state.cardr.intubation) state.cardr.intubation = {time: '', size: '7.0'};
    if (!state.cardr.drug_details) state.cardr.drug_details = {};
    if (!state.cardr.exams) state.cardr.exams = {bs:false, ucg:false, us_abd:false, us_lung:false, us_neck:false, ecg:false, fast:false, efast:false};
    if (!state.cardr.exam_texts) state.cardr.exam_texts = {ucg:'', us_abd:'', us_lung:'', us_neck:'', ecg:'', fast:'', efast:''};
    if (!state.cardr.abg_data) state.cardr.abg_data = [];
    if (!state.cardr.cpaEvents) state.cardr.cpaEvents = [];
    if (!state.cardr.exam_tab) state.cardr.exam_tab = 'general';
    if (!state.ems.exam_tab) state.ems.exam_tab = 'general';

    if (!state.cardr.stroke) state.cardr.stroke = {};
    if (state.cardr.stroke.pupilL === undefined) state.cardr.stroke.pupilL = 3.0;
    if (state.cardr.stroke.pupilR === undefined) state.cardr.stroke.pupilR = 3.0;
    if (!state.cardr.stroke.mmt) state.cardr.stroke.mmt = {ru:5, lu:5, rl:5, ll:5};
    if (!state.cardr.stroke.nihss) state.cardr.stroke.nihss = {};
    if (state.cardr.stroke.babinski === undefined) state.cardr.stroke.babinski = false;
    if (state.cardr.stroke.chaddock === undefined) state.cardr.stroke.chaddock = false;
    
    // CPAãƒ¡ãƒ¢ãŒå¤ã„å½¢å¼ã®å ´åˆã®å¯¾å¿œï¼ˆæ–°ã—ã„å½¢å¼ã«åˆã‚ã›ã‚‹ï¼‰
    if (state.ems.memos.cpa && typeof state.ems.memos.cpa === 'string') {
        state.ems.memos.cpa = {memo: state.ems.memos.cpa};
    }
}

// é…¸ç´ æµé‡ãƒ€ã‚¤ãƒ¤ãƒ« (å¤‰æ›´ãªã—)
window.openO2FlowDial = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  const flows = ['1L/min', '2L/min', '3L/min', '4L/min', '5L/min', '6L/min', '8L/min', '10L/min', '12L/min', '15L/min', 'ãƒªã‚¶ãƒ¼ãƒãƒ¼10L', 'ãƒªã‚¶ãƒ¼ãƒãƒ¼15L'];
  const options = flows.map(f => ({label: f, value: f}));
  const selectedFlow = state.ems.o2_flow || '1L/min';
  
  openDial('é…¸ç´ æµé‡', [
    {options: options, selected: selectedFlow}
  ], (vals) => {
    state.ems.o2_flow = vals[0];
    const o2FlowEl = $('#o2_flow_display');
    if (o2FlowEl) o2FlowEl.textContent = vals[0] || 'ï¼';
    updateState();
  });
};

// æ°—ç®¡æŒ¿ç®¡ãƒ€ã‚¤ãƒ¤ãƒ« (å¤‰æ›´ãªã—)
window.openIntubationDial = () => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  // state.cardr.intubationã®å­˜åœ¨ã‚’ä¿è¨¼
  if (!state.cardr.intubation) state.cardr.intubation = {time: '', size: '7.0'};
  
  const now = new Date();
  const hh = String(now.getHours()).padStart(2, '0');
  const mm = String(now.getMinutes()).padStart(2, '0');
  const currentTime = state.cardr.intubation.time || `${hh}:${mm}`;
  const [h, m] = currentTime.split(':');
  
  const sizes = [];
  for(let i = 3.5; i <= 8.5; i += 0.5) {
    sizes.push(i.toFixed(1)); // valueã¨ã—ã¦æ•°å€¤æ–‡å­—åˆ—ã‚’ä¿æŒ
  }
  const currentSize = state.cardr.intubation.size || '7.0';
  
  const hoursOptions = Array.from({length: 24}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
  const minutesOptions = Array.from({length: 60}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
  const sizeOptions = sizes.map(s => ({label: s + 'mm', value: s}));
  
  openDial('æ°—ç®¡æŒ¿ç®¡', [
    {options: hoursOptions, selected: h, unit: ':'},
    {options: minutesOptions, selected: m},
    {options: sizeOptions, selected: currentSize, unit:'mm'}
  ], (vals) => {
    state.cardr.intubation.time = `${vals[0]}:${vals[1]}`;
    state.cardr.intubation.size = vals[2];
    renderProcedureChips('cardr_procedures', state.cardr.procedures_items, state.cardr.procedures); // æ›´æ–°ã‚’åæ˜ 
    updateState();
  });
};

// è–¬å‰¤æŠ•ä¸è©³ç´°ãƒ€ã‚¤ãƒ¤ãƒ« (å¤§å¹…ä¿®æ­£)
window.openDrugDetailDial = (drugName, isEditMode) => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«åŒ–
  // state.cardr.drug_detailsã®å­˜åœ¨ã‚’ä¿è¨¼
  if(!state.cardr.drug_details) state.cardr.drug_details = {};
  if(!state.cardr.drug_details[drugName]) state.cardr.drug_details[drugName] = [];

  const drugDetails = state.cardr.drug_details[drugName];
  
  // è–¬å‰¤ã”ã¨ã®è¨­å®š
  let amountConfig = {};
  let defaultAmount = '';
  
  switch(drugName) {
    case 'ã‚¢ãƒ‰ãƒ¬ãƒŠãƒªãƒ³':
      amountConfig = {min: 0.1, max: 2.0, step: 0.1, decimals: 1};
      defaultAmount = 1.0;
      break;
    case 'ãƒŸãƒ€ã‚¾ãƒ©ãƒ ':
    case 'ã‚¸ã‚¢ã‚¼ãƒ‘ãƒ ':
    case 'ã‚¢ãƒˆãƒ­ãƒ”ãƒ³':
      amountConfig = {min: 0.1, max: 10.0, step: 0.1, decimals: 1};
      defaultAmount = 1.0; // åŸºæº–å€¤1.0mg
      break;
    case 'ã‚¨ã‚¹ãƒ©ãƒƒã‚¯ã‚¹':
    case 'ãƒ­ã‚¯ãƒ­ãƒ‹ã‚¦ãƒ ':
      amountConfig = {min: 1, max: 100, step: 1, decimals: 0};
      defaultAmount = 50;
      break;
    default:
      amountConfig = {min: 0.1, max: 20.0, step: 0.1, decimals: 1};
      defaultAmount = 1.0;
  }
  
  // æŠ•ä¸å›æ•°è¡¨ç¤º
  let detailListHtml = '';
  if (drugDetails.length > 0) {
      detailListHtml = `<div style="max-height:100px; overflow-y:auto; border:1px solid var(--line); border-radius:8px; padding:8px; margin-bottom:12px">
          <h4 style="margin:0 0 4px; font-size:14px; color:var(--muted)">æŠ•ä¸å±¥æ­´:</h4>
          ${drugDetails.map((d, i) => 
              `<div style="font-size:14px; display:flex; justify-content:space-between; margin-bottom:4px; padding-right:10px;">
                  <span>${i + 1}å›ç›®: ${d.time} (${d.amount}mg)</span>
                  <button style="color:#dc2626; border:none; background:none; cursor:pointer; padding:0" onclick="removeDrugDose('${drugName}', ${i})">å‰Šé™¤</button>
              </div>`
          ).join('')}
      </div>`;
  }
  
  // æŠ•ä¸è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®æœ¬ä½“ã‚’ç”Ÿæˆ
  const showDrugDial = (initialTime, initialAmount) => {
      const [h, m] = initialTime.split(':').map(String);
      const currentAmount = parseFloat(initialAmount || defaultAmount);
      
      const hoursOptions = Array.from({length: 24}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
      const minutesOptions = Array.from({length: 60}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
      
      const amounts = [];
      for(let i = amountConfig.min; i <= amountConfig.max; i = parseFloat((i + amountConfig.step).toFixed(amountConfig.decimals))) {
          const val = i.toFixed(amountConfig.decimals);
          amounts.push(val);
      }
      const amountOptions = amounts.map(a => ({label: a + 'mg', value: a}));
      
      const wheels = [
          {options: hoursOptions, selected: h, unit: ':'},
          {options: minutesOptions, selected: m},
          {options: amountOptions, selected: currentAmount.toFixed(amountConfig.decimals), unit: 'mg'}
      ];
      
      openDial(drugName + ' æŠ•ä¸è¨­å®š', wheels, (vals) => {
          const newTime = `${vals[0]}:${vals[1]}`;
          const newAmount = vals[2];
          
          drugDetails.push({
              time: newTime,
              amount: newAmount
          });
          
          // æŠ•ä¸å¾Œã€å†åº¦ãƒãƒƒãƒ—ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¨çŠ¶æ…‹æ›´æ–°
          renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
          updateState();
      });
  };
  
  if (isEditMode) {
      // è¤‡æ•°å›æŠ•ä¸ãƒ¢ãƒ¼ãƒ‰ã®ã‚«ã‚¹ã‚¿ãƒ UI
      const now = new Date();
      const nextTime = drugDetails.length > 0 ? addMinutesToTime(drugDetails[drugDetails.length - 1].time, 4) : `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé‡ã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ¸¡ã™
      const defaultAmountStr = defaultAmount.toFixed(amountConfig.decimals || 0);

      const customDialog = `
          <div id="drug-custom-dialog" style="padding:20px; text-align:center;">
              <h3 style="margin-top:0; font-size:18px;">${drugName}</h3>
              ${detailListHtml}
              <p style="font-size:14px; margin-bottom:15px; color:var(--muted);">æ¬¡å›ã®æŠ•ä¸è¨­å®šã€ã¾ãŸã¯è¨˜éŒ²ã®è§£é™¤ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚</p>
              
              <button class="btn" style="background:#4ade80; margin-bottom:10px;" onclick="closeDial(); showDrugDialFunction('${nextTime}', '${defaultAmountStr}');">
                  ï¼‹ è¿½åŠ æŠ•ä¸ (${nextTime} é ƒ)
              </button>
              <button class="btn ghost" style="color:#dc2626; border:1px solid #dc2626;" onclick="closeDial(); removeDrugAll('${drugName}');">
                  è¨˜éŒ²ã‚’å…¨ã¦è§£é™¤ (ãƒãƒƒãƒ—OFF)
              </button>
          </div>
      `;
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦showDrugDialã‚’ãƒ©ãƒƒãƒ—ã—ã¦æ¸¡ã™
      window.showDrugDialFunction = showDrugDial;
      
      // openDialã¯ãƒ›ã‚¤ãƒ¼ãƒ«è¡¨ç¤ºãŒå¿…è¦ãªã®ã§ã€ã“ã“ã§ã¯ç›´æ¥DOMã‚’æ“ä½œã—ã¦ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      $('#dialOverlay').classList.add('show');
      $('#dialBody').innerHTML = customDialog;
      $('#dialTitle').textContent = `${drugName} æŠ•ä¸å±¥æ­´`;
      
      // ã‚«ã‚¹ã‚¿ãƒ UIã§ã¯å®Œäº†ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
      const doneBtn = $('#dialDone');
      if (doneBtn) doneBtn.style.display = 'none';

  } else {
      // åˆå›æŠ•ä¸
      const now = new Date();
      const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      showDrugDial(currentTime, defaultAmount);
  }
};

// è–¬å‰¤ã®å…¨å‰Šé™¤
window.removeDrugAll = (drugName) => {
    delete state.cardr.drug_details[drugName];
    state.cardr.drugs[drugName] = false;
    renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
    updateState();
    closeDial();
};

// è–¬å‰¤ã®å€‹åˆ¥å‰Šé™¤
window.removeDrugDose = (drugName, index) => {
    if (state.cardr.drug_details[drugName]) {
        state.cardr.drug_details[drugName].splice(index, 1);
        // æŠ•ä¸è¨˜éŒ²ãŒãªããªã£ãŸã‚‰ã€ãƒãƒƒãƒ—ã‚’OFFã«ã™ã‚‹
        if (state.cardr.drug_details[drugName].length === 0) {
            removeDrugAll(drugName);
        } else {
            // å†æç”»ã¨UIæ›´æ–° (å†å¸°çš„ã«openDrugDetailDialã‚’å‘¼ã³å‡ºã™)
            closeDial();
            openDrugDetailDial(drugName, true); 
            renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
            updateState();
        }
    }
};


window.openIVStartDial = (drugName) => {
    const now = new Date();
    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    
    // æ™‚é–“ã¨åˆ†ã®ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’å®šç¾©
    const hoursOptions = Array.from({length: 24}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
    const minutesOptions = Array.from({length: 60}, (_, i) => ({label: String(i).padStart(2, '0'), value: String(i).padStart(2, '0')}));
    
    const [h, m] = currentTime.split(':').map(String);

    const wheels = [
        {options: hoursOptions, selected: h, unit: ':'},
        {options: minutesOptions, selected: m}
    ];

    openDial(`${drugName} é–‹å§‹æ™‚åˆ»`, wheels, (vals) => {
        const newTime = `${vals[0]}:${vals[1]}`;
        
        // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„é–‹å§‹æ™‚åˆ»ã‚’1å›ç›®ã¨ã—ã¦æ ¼ç´ (é‡='é–‹å§‹'ã¨ä»®å®š)
        state.cardr.drug_details[drugName] = [{
            time: newTime,
            amount: 'é–‹å§‹'
        }];
        
        // ãƒãƒƒãƒ—ã®çŠ¶æ…‹ã‚’ONã«ç¢ºå®š
        state.cardr.drugs[drugName] = true;
        
        renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
        updateState();
    });
};


function init() {
  // 1. localStorageã‹ã‚‰ã®å¾©å…ƒã¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®çµ±åˆ
  const saved = localStorage.getItem('doctorCarV1');
  if(saved) {
    try { 
        const loadedState = JSON.parse(saved);
        
        // äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã¨ç§»è¡Œ
        if(loadedState.heli && !loadedState.car) loadedState.car = loadedState.heli;
        if(loadedState.ems?.lz && !loadedState.ems.rp) loadedState.ems.rp = loadedState.ems.lz;
        if(loadedState.fd && !loadedState.cardr) loadedState.cardr = loadedState.fd;
        if(loadedState.car?.fd_contact && !loadedState.car.cardr_contact) loadedState.car.cardr_contact = loadedState.car.fd_contact;
        
        state = loadedState;
        
    } catch(e) {
      console.error('Failed to load state from localStorage:', e);
    }
  }
  
  // 2. çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å …ç‰¢åŒ– (æœ€æ–°ã®ãƒã‚¹ã‚¿å®šç¾©ã‚’é©ç”¨ã—ã€ä¸è¶³ã—ã¦ã„ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’åˆæœŸåŒ–)
  initializeStateDataStructure();
  
  // 3. UIã®åˆæœŸè¨­å®šã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  
  // ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ
  $$('.tab-bar-item').forEach(el => el.addEventListener('click', () => switchTab(el.dataset.tab)));
  
  // ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½ã®åˆæœŸåŒ–
  const mainElement = $('main');
  if (mainElement) {
    let touchStartX = 0;
    let touchEndX = 0;
    const tabs = ['patient', 'car-time', 'ems', 'doctor', 'exam', 'assess', 'consider', 'output'];
    
    function getCurrentTabIndex() {
      const activeTab = $('.tab-bar-item.active');
      if (!activeTab) return 0;
      const tabId = activeTab.dataset.tab;
      return tabs.indexOf(tabId);
    }
    
    function switchTabBySwipe(direction) {
      const currentIndex = getCurrentTabIndex();
      let newIndex;
      if (direction === 'left' && currentIndex < tabs.length - 1) {
        newIndex = currentIndex + 1;
      } else if (direction === 'right' && currentIndex > 0) {
        newIndex = currentIndex - 1;
      } else {
        return; // ç¯„å›²å¤–
      }
      switchTab(tabs[newIndex]);
    }
    
    mainElement.addEventListener('touchstart', (e) => {
      touchStartX = e.touches[0].clientX;
    }, { passive: true });

    mainElement.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX - touchEndX;
      const minSwipeDistance = 50; // æœ€å°ã‚¹ãƒ¯ã‚¤ãƒ—è·é›¢
      
      if (Math.abs(diff) > minSwipeDistance) {
        if (diff > 0) {
          // å·¦ã«ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæ¬¡ã®ã‚¿ãƒ–ï¼‰
          switchTabBySwipe('left');
        } else {
          // å³ã«ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆå‰ã®ã‚¿ãƒ–ï¼‰
          switchTabBySwipe('right');
        }
      }
    }, { passive: true });
  }
  
  // ãƒãƒƒãƒ—ãƒã‚¦ãƒ³ãƒˆ
  mountChips('#ems-gen-head', EMS_GEN_GROUPS.head, 'ems');
  mountChips('#ems-gen-resp', EMS_GEN_GROUPS.resp, 'ems');
  mountChips('#ems-gen-card', EMS_GEN_GROUPS.card, 'ems');
  mountChips('#ems-gen-abd', EMS_GEN_GROUPS.abd, 'ems');
  mountChips('#ems-gen-limb', EMS_GEN_GROUPS.limb, 'ems');
  mountChips('#ems-gen-neuro', EMS_GEN_GROUPS.neuro, 'ems');
  mountChips('#ems-tra-head', EMS_TRA_GROUPS.head, 'ems');
  mountChips('#ems-tra-neck', EMS_TRA_GROUPS.neck, 'ems');
  mountChips('#ems-tra-chest', EMS_TRA_GROUPS.chest, 'ems');
  mountChips('#ems-tra-abd', EMS_TRA_GROUPS.abd, 'ems');
  mountChips('#ems-tra-pelvis', EMS_TRA_GROUPS.pelvis, 'ems');
  mountChips('#ems-tra-limb', EMS_TRA_GROUPS.limb, 'ems');
  mountChips('#ems-cpa-rhythm', EMS_CPA_GROUPS.rhythm, 'ems');
  mountChips('#ems-cpa-witness', EMS_CPA_GROUPS.witness, 'ems');
  mountChips('#ems-cpa-airway', EMS_CPA_GROUPS.airway, 'ems');
  mountChips('#ems-cpa-circulation', EMS_CPA_GROUPS.circulation, 'ems');
  mountChips('#ems-cpa-chest', EMS_CPA_GROUPS.chest, 'ems');
  mountChips('#ems-str-conscious', EMS_STR_GROUPS.conscious, 'ems');
  mountChips('#ems-str-face', EMS_STR_GROUPS.face, 'ems');
  mountChips('#ems-str-motor', EMS_STR_GROUPS.motor, 'ems');
  mountChips('#ems-str-other', EMS_STR_GROUPS.other, 'ems');
  
  mountChips('#cardr-gen-head', CARDR_GEN_GROUPS.head, 'cardr');
  mountChips('#cardr-gen-resp', CARDR_GEN_GROUPS.resp, 'cardr');
  mountChips('#cardr-gen-card', CARDR_GEN_GROUPS.card, 'cardr');
  mountChips('#cardr-gen-abd', CARDR_GEN_GROUPS.abd, 'cardr');
  mountChips('#cardr-gen-limb', CARDR_GEN_GROUPS.limb, 'cardr');
  mountChips('#cardr-gen-neuro', CARDR_GEN_GROUPS.neuro, 'cardr');
  mountChips('#cardr-tra-head', CARDR_TRA_GROUPS.head, 'cardr');
  mountChips('#cardr-tra-neck', CARDR_TRA_GROUPS.neck, 'cardr');
  mountChips('#cardr-tra-chest', CARDR_TRA_GROUPS.chest, 'cardr');
  mountChips('#cardr-tra-abd', CARDR_TRA_GROUPS.abd, 'cardr');
  mountChips('#cardr-tra-pelvis', CARDR_TRA_GROUPS.pelvis, 'cardr');
  mountChips('#cardr-tra-limb', CARDR_TRA_GROUPS.limb, 'cardr');
  mountChips('#cardr-str-cn', CARDR_STR_GROUPS.cn, 'cardr');
  mountChips('#cardr-str-higher', CARDR_STR_GROUPS.higher, 'cardr');
  
  renderProcedureChips('ems_procedures', state.ems.procedures_items, state.ems.procedures);
  renderProcedureChips('cardr_procedures', state.cardr.procedures_items, state.cardr.procedures);
  renderProcedureChips('cardr_drugs', state.cardr.drugs_items, state.cardr.drugs);
  
  // æ—¢å¾€æ­´ãƒãƒƒãƒ—ã‚’ãƒã‚¦ãƒ³ãƒˆï¼ˆå¾©å…ƒå‰ã«ãƒãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸï¼‰
  if (state.patient?.history && !state.patient.history_chips) {
    state.patient.history_chips = {};
  }
  syncHistoryChipsFromText();
  renderHistoryChips();
  
  // å¸¸ç”¨è–¬ãƒãƒƒãƒ—ã‚’ãƒã‚¦ãƒ³ãƒˆ
  if (!state.patient.anticoagulant) state.patient.anticoagulant = '';
  if (!state.patient.antiplatelet) state.patient.antiplatelet = '';
  if (!state.patient.anticoagulant_drugs) state.patient.anticoagulant_drugs = [];
  if (!state.patient.antiplatelet_drugs) state.patient.antiplatelet_drugs = [];
  renderMedicationChips();
  
  // ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒãƒƒãƒ—ã‚’ãƒã‚¦ãƒ³ãƒˆ
  if (!state.patient.food_allergy) state.patient.food_allergy = '';
  if (!state.patient.drug_allergy) state.patient.drug_allergy = '';
  renderAllergyChips();
  
  // è¦è«‹æƒ…å ±ãƒãƒƒãƒ—ã‚’ãƒã‚¦ãƒ³ãƒˆ
  if (!state.request.age) state.request.age = '';
  if (!state.request.sex) state.request.sex = '';
  if (!state.request.ems_team) state.request.ems_team = '';
  if (!state.request.content) state.request.content = '';
  renderRequestInfoChips();
  renderRequestContentChips();
  
  renderHospitalChips();
  renderProblems();
  renderTriageChips();
  renderSeverityChips();
  // ç—‡çŠ¶è©³è¨˜ã®ãƒ‡ãƒ¼ã‚¿ãƒªã‚¹ãƒˆåˆæœŸåŒ–
  // triggersã¨suspicionsã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ãªã®ã§ã€ã™ã¹ã¦ã®å€¤ã‚’å–å¾—ã—ã¦ãƒ•ãƒ©ãƒƒãƒˆåŒ–
  const allTriggers = [];
  Object.values(MedicalReasonGenerator.triggers).forEach(category => {
    Object.values(category).forEach(items => {
      items.forEach(item => {
        if (!allTriggers.includes(item)) {
          allTriggers.push(item);
        }
      });
    });
  });
  const triggerOpts = allTriggers.map(t => `<option value="${t}">`).join('');
  const triggerList = $('#triggerList');
  if(triggerList) triggerList.innerHTML = triggerOpts;
  
  const allSuspicions = [];
  Object.values(MedicalReasonGenerator.suspicions).forEach(category => {
    Object.values(category).forEach(items => {
      items.forEach(item => {
        if (!allSuspicions.includes(item)) {
          allSuspicions.push(item);
        }
      });
    });
  });
  const suspOpts = allSuspicions.map(s => `<option value="${s}">`).join('');
  const suspicionList = $('#suspicionList');
  if(suspicionList) suspicionList.innerHTML = suspOpts;
  
  renderAbgPills();
  renderNihss();
  bindMemos();
  
  const transportMethodEl = $('#transport_method');
  if (transportMethodEl) transportMethodEl.onchange = toggleTransportTimes;
  
  const destinationCustomEl = $('#destination_custom');
  if (destinationCustomEl) destinationCustomEl.oninput = updateState;
  
  const newProblemEl = $('#new_problem');
  if (newProblemEl) newProblemEl.onkeypress = e => { if(e.key === 'Enter') { e.preventDefault(); addProblem(); } };
  
  ['ucg','us_abd','us_lung','us_neck','ecg','fast','efast'].forEach(t => {
    const txtEl = $(`#exam_${t}_txt`);
    if(txtEl) {
      txtEl.oninput = () => { 
        if(state.cardr.exam_texts) state.cardr.exam_texts[t] = txtEl.value; 
        updateState(); 
      };
    }
  });

  // æ—¢å¾€æ­´ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æ‰‹å‹•å¤‰æ›´æ™‚ã«ãƒãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸ
  const patientHistoryEl = $('#patient_history');
  if (patientHistoryEl) {
    patientHistoryEl.oninput = () => {
      syncHistoryChipsFromText();
      renderHistoryChips();
      updateState();
    };
  }
  
  // å¸¸ç”¨è–¬ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æ‰‹å‹•å¤‰æ›´æ™‚ï¼ˆãƒãƒƒãƒ—ã§æ›´æ–°ã•ã‚ŒãŸå€¤ã¯é™¤å¤–ï¼‰
  const patientMedicationEl = $('#patient_medication');
  if (patientMedicationEl) {
    let isUpdatingFromChip = false;
    const originalInput = patientMedicationEl.oninput;
    patientMedicationEl.oninput = () => {
      if (!isUpdatingFromChip) {
        updateState();
      }
    };
    // updateMedicationTextareaã§ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    const originalUpdateMedicationTextarea = window.updateMedicationTextarea;
    window.updateMedicationTextarea = function() {
      isUpdatingFromChip = true;
      originalUpdateMedicationTextarea();
      isUpdatingFromChip = false;
    };
  }
  
  // ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®æ‰‹å‹•å¤‰æ›´æ™‚ï¼ˆãƒãƒƒãƒ—ã§æ›´æ–°ã•ã‚ŒãŸå€¤ã¯é™¤å¤–ï¼‰
  const patientAllergyEl = $('#patient_allergy');
  if (patientAllergyEl) {
    let isUpdatingFromChip = false;
    patientAllergyEl.oninput = () => {
      if (!isUpdatingFromChip) {
        updateState();
      }
    };
    // updateAllergyTextareaã§ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    const originalUpdateAllergyTextarea = window.updateAllergyTextarea;
    window.updateAllergyTextarea = function() {
      isUpdatingFromChip = true;
      originalUpdateAllergyTextarea();
      isUpdatingFromChip = false;
    };
  }
  
  // ãã®ä»–ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚¤ãƒ³ãƒ‰
  $$('input:not([type="time"]):not([type="checkbox"]), textarea, select').forEach(el => {
    if(!el.onchange && !el.oninput && el.id !== 'patient_history' && el.id !== 'patient_medication' && el.id !== 'patient_allergy') el.oninput = updateState;
  });
  
  // input type="time" ã® onchange ã‚‚ updateState ã«è¨­å®š
  $$('input[type="time"], select:not(#transport_method):not(#cardr_abg_type)').forEach(el => {
      if(!el.onchange) el.onchange = updateState;
  });
  
  // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®è¨­å®š
  const copyOutEl = $('#copyOut');
  if (copyOutEl) {
    copyOutEl.onclick = () => {
      navigator.clipboard.writeText($('#outText')?.textContent || '').then(() => {
        const btn = $('#copyOut');
        if (btn) {
          btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼å®Œäº†';
          setTimeout(() => { if (btn) btn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 2000);
        }
      });
    };
  }
  
  // 4. UIçŠ¶æ…‹ã®å¾©å…ƒã¨æç”»
  restoreUI();
  
  // èº«ä½“æ‰€è¦‹ã‚¿ãƒ–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆrestoreUIã®å¾Œï¼‰
  setupExamTabs('ems');
  setupExamTabs('cardr');
  
  render();
  
  // åˆæœŸã‚¿ãƒ–ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
  const initialTab = $('.tab-content.active')?.dataset.tab || 'patient';
  const tabNames = {
    'patient': 'æ‚£è€…',
    'car-time': 'ã‚«ãƒ¼æ™‚åˆ»',
    'ems': 'æ•‘æ€¥éšŠ',
    'doctor': 'æ‰€è¦‹',
    'exam': 'æ¤œæŸ»',
    'assess': 'è©•ä¾¡',
    'consider': 'æ¬é€å…ˆ',
    'output': 'å‡ºåŠ›'
  };
  const headerTitle = $('header h1');
  if (headerTitle && tabNames[initialTab]) {
    headerTitle.textContent = `ğŸš— ãƒ‰ã‚¯ã‚¿ãƒ¼ã‚«ãƒ¼ - ${tabNames[initialTab]}`;
  }
  
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
  $$('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const parent = this.closest('.time-row') || this.closest('label'); // è¦ªè¦ç´ ã‚’ä¿®æ­£
      if(parent) {
        parent.classList.remove('check-flash');
        void parent.offsetWidth; // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
        parent.classList.add('check-flash');
        setTimeout(() => parent.classList.remove('check-flash'), 400);
      }
    });
  });
}

init();
</script>
</body>
</html>
